<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>IMG file disk to JSON converter</title>
		<style>
			html,body{margin:0;padding:0;background-color:white}
			input[type=file]{height:30px;font-family:Arial;font-size:13px;line-height:30px;vertical-align:top;margin:0;padding:0;box-sizing:border-box}
		</style>
	</head>
	<body>
		<input type="file" id="uploader">

		<script>
			// Buffer
			!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).buffer=t()}}(function(){return function(){return function t(r,e,n){function i(f,u){if(!e[f]){if(!r[f]){var s="function"==typeof require&&require;if(!u&&s)return s(f,!0);if(o)return o(f,!0);var h=new Error("Cannot find module '"+f+"'");throw h.code="MODULE_NOT_FOUND",h}var a=e[f]={exports:{}};r[f][0].call(a.exports,function(t){return i(r[f][1][t]||t)},a,a.exports,t,r,e,n)}return e[f].exports}for(var o="function"==typeof require&&require,f=0;f<n.length;f++)i(n[f]);return i}}()({1:[function(t,r,e){"use strict";e.byteLength=function(t){var r=h(t),e=r[0],n=r[1];return 3*(e+n)/4-n},e.toByteArray=function(t){var r,e,n=h(t),f=n[0],u=n[1],s=new o(function(t,r,e){return 3*(r+e)/4-e}(0,f,u)),a=0,c=u>0?f-4:f;for(e=0;e<c;e+=4)r=i[t.charCodeAt(e)]<<18|i[t.charCodeAt(e+1)]<<12|i[t.charCodeAt(e+2)]<<6|i[t.charCodeAt(e+3)],s[a++]=r>>16&255,s[a++]=r>>8&255,s[a++]=255&r;2===u&&(r=i[t.charCodeAt(e)]<<2|i[t.charCodeAt(e+1)]>>4,s[a++]=255&r);1===u&&(r=i[t.charCodeAt(e)]<<10|i[t.charCodeAt(e+1)]<<4|i[t.charCodeAt(e+2)]>>2,s[a++]=r>>8&255,s[a++]=255&r);return s},e.fromByteArray=function(t){for(var r,e=t.length,i=e%3,o=[],f=0,u=e-i;f<u;f+=16383)o.push(a(t,f,f+16383>u?u:f+16383));1===i?(r=t[e-1],o.push(n[r>>2]+n[r<<4&63]+"==")):2===i&&(r=(t[e-2]<<8)+t[e-1],o.push(n[r>>10]+n[r>>4&63]+n[r<<2&63]+"="));return o.join("")};for(var n=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=0,s=f.length;u<s;++u)n[u]=f[u],i[f.charCodeAt(u)]=u;function h(t){var r=t.length;if(r%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=t.indexOf("=");return-1===e&&(e=r),[e,e===r?0:4-e%4]}function a(t,r,e){for(var i,o,f=[],u=r;u<e;u+=3)i=(t[u]<<16&16711680)+(t[u+1]<<8&65280)+(255&t[u+2]),f.push(n[(o=i)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return f.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},{}],2:[function(t,r,e){(function(r){"use strict";var n=t("base64-js"),i=t("ieee754");e.Buffer=r,e.SlowBuffer=function(t){+t!=t&&(t=0);return r.alloc(+t)},e.INSPECT_MAX_BYTES=50;var o=2147483647;function f(t){if(t>o)throw new RangeError('The value "'+t+'" is invalid for option "size"');var e=new Uint8Array(t);return e.__proto__=r.prototype,e}function r(t,r,e){if("number"==typeof t){if("string"==typeof r)throw new TypeError('The "string" argument must be of type string. Received type number');return h(t)}return u(t,r,e)}function u(t,e,n){if("string"==typeof t)return function(t,e){"string"==typeof e&&""!==e||(e="utf8");if(!r.isEncoding(e))throw new TypeError("Unknown encoding: "+e);var n=0|p(t,e),i=f(n),o=i.write(t,e);o!==n&&(i=i.slice(0,o));return i}(t,e);if(ArrayBuffer.isView(t))return a(t);if(null==t)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(j(t,ArrayBuffer)||t&&j(t.buffer,ArrayBuffer))return function(t,e,n){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(n||0))throw new RangeError('"length" is outside of buffer bounds');var i;i=void 0===e&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,e):new Uint8Array(t,e,n);return i.__proto__=r.prototype,i}(t,e,n);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');var i=t.valueOf&&t.valueOf();if(null!=i&&i!==t)return r.from(i,e,n);var o=function(t){if(r.isBuffer(t)){var e=0|c(t.length),n=f(e);return 0===n.length?n:(t.copy(n,0,0,e),n)}if(void 0!==t.length)return"number"!=typeof t.length||F(t.length)?f(0):a(t);if("Buffer"===t.type&&Array.isArray(t.data))return a(t.data)}(t);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return r.from(t[Symbol.toPrimitive]("string"),e,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function s(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function h(t){return s(t),f(t<0?0:0|c(t))}function a(t){for(var r=t.length<0?0:0|c(t.length),e=f(r),n=0;n<r;n+=1)e[n]=255&t[n];return e}function c(t){if(t>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return 0|t}function p(t,e){if(r.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||j(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);var n=t.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===n)return 0;for(var o=!1;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return P(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return k(t).length;default:if(o)return i?-1:P(t).length;e=(""+e).toLowerCase(),o=!0}}function l(t,r,e){var n=t[r];t[r]=t[e],t[e]=n}function y(t,e,n,i,o){if(0===t.length)return-1;if("string"==typeof n?(i=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),F(n=+n)&&(n=o?0:t.length-1),n<0&&(n=t.length+n),n>=t.length){if(o)return-1;n=t.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof e&&(e=r.from(e,i)),r.isBuffer(e))return 0===e.length?-1:g(t,e,n,i,o);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(t,e,n):Uint8Array.prototype.lastIndexOf.call(t,e,n):g(t,[e],n,i,o);throw new TypeError("val must be string, number or Buffer")}function g(t,r,e,n,i){var o,f=1,u=t.length,s=r.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||r.length<2)return-1;f=2,u/=2,s/=2,e/=2}function h(t,r){return 1===f?t[r]:t.readUInt16BE(r*f)}if(i){var a=-1;for(o=e;o<u;o++)if(h(t,o)===h(r,-1===a?0:o-a)){if(-1===a&&(a=o),o-a+1===s)return a*f}else-1!==a&&(o-=o-a),a=-1}else for(e+s>u&&(e=u-s),o=e;o>=0;o--){for(var c=!0,p=0;p<s;p++)if(h(t,o+p)!==h(r,p)){c=!1;break}if(c)return o}return-1}function w(t,r,e,n){e=Number(e)||0;var i=t.length-e;n?(n=Number(n))>i&&(n=i):n=i;var o=r.length;n>o/2&&(n=o/2);for(var f=0;f<n;++f){var u=parseInt(r.substr(2*f,2),16);if(F(u))return f;t[e+f]=u}return f}function d(t,r,e,n){return $(P(r,t.length-e),t,e,n)}function b(t,r,e,n){return $(function(t){for(var r=[],e=0;e<t.length;++e)r.push(255&t.charCodeAt(e));return r}(r),t,e,n)}function m(t,r,e,n){return b(t,r,e,n)}function E(t,r,e,n){return $(k(r),t,e,n)}function v(t,r,e,n){return $(function(t,r){for(var e,n,i,o=[],f=0;f<t.length&&!((r-=2)<0);++f)e=t.charCodeAt(f),n=e>>8,i=e%256,o.push(i),o.push(n);return o}(r,t.length-e),t,e,n)}function B(t,r,e){return 0===r&&e===t.length?n.fromByteArray(t):n.fromByteArray(t.slice(r,e))}function A(t,r,e){e=Math.min(t.length,e);for(var n=[],i=r;i<e;){var o,f,u,s,h=t[i],a=null,c=h>239?4:h>223?3:h>191?2:1;if(i+c<=e)switch(c){case 1:h<128&&(a=h);break;case 2:128==(192&(o=t[i+1]))&&(s=(31&h)<<6|63&o)>127&&(a=s);break;case 3:o=t[i+1],f=t[i+2],128==(192&o)&&128==(192&f)&&(s=(15&h)<<12|(63&o)<<6|63&f)>2047&&(s<55296||s>57343)&&(a=s);break;case 4:o=t[i+1],f=t[i+2],u=t[i+3],128==(192&o)&&128==(192&f)&&128==(192&u)&&(s=(15&h)<<18|(63&o)<<12|(63&f)<<6|63&u)>65535&&s<1114112&&(a=s)}null===a?(a=65533,c=1):a>65535&&(a-=65536,n.push(a>>>10&1023|55296),a=56320|1023&a),n.push(a),i+=c}return function(t){var r=t.length;if(r<=I)return String.fromCharCode.apply(String,t);var e="",n=0;for(;n<r;)e+=String.fromCharCode.apply(String,t.slice(n,n+=I));return e}(n)}e.kMaxLength=o,r.TYPED_ARRAY_SUPPORT=function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()}catch(t){return!1}}(),r.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(r.prototype,"parent",{enumerable:!0,get:function(){if(r.isBuffer(this))return this.buffer}}),Object.defineProperty(r.prototype,"offset",{enumerable:!0,get:function(){if(r.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&r[Symbol.species]===r&&Object.defineProperty(r,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),r.poolSize=8192,r.from=function(t,r,e){return u(t,r,e)},r.prototype.__proto__=Uint8Array.prototype,r.__proto__=Uint8Array,r.alloc=function(t,r,e){return function(t,r,e){return s(t),t<=0?f(t):void 0!==r?"string"==typeof e?f(t).fill(r,e):f(t).fill(r):f(t)}(t,r,e)},r.allocUnsafe=function(t){return h(t)},r.allocUnsafeSlow=function(t){return h(t)},r.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==r.prototype},r.compare=function(t,e){if(j(t,Uint8Array)&&(t=r.from(t,t.offset,t.byteLength)),j(e,Uint8Array)&&(e=r.from(e,e.offset,e.byteLength)),!r.isBuffer(t)||!r.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;for(var n=t.length,i=e.length,o=0,f=Math.min(n,i);o<f;++o)if(t[o]!==e[o]){n=t[o],i=e[o];break}return n<i?-1:i<n?1:0},r.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return r.alloc(0);var n;if(void 0===e)for(e=0,n=0;n<t.length;++n)e+=t[n].length;var i=r.allocUnsafe(e),o=0;for(n=0;n<t.length;++n){var f=t[n];if(j(f,Uint8Array)&&(f=r.from(f)),!r.isBuffer(f))throw new TypeError('"list" argument must be an Array of Buffers');f.copy(i,o),o+=f.length}return i},r.byteLength=p,r.prototype._isBuffer=!0,r.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var r=0;r<t;r+=2)l(this,r,r+1);return this},r.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var r=0;r<t;r+=4)l(this,r,r+3),l(this,r+1,r+2);return this},r.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var r=0;r<t;r+=8)l(this,r,r+7),l(this,r+1,r+6),l(this,r+2,r+5),l(this,r+3,r+4);return this},r.prototype.toString=function(){var t=this.length;return 0===t?"":0===arguments.length?A(this,0,t):function(t,r,e){var n=!1;if((void 0===r||r<0)&&(r=0),r>this.length)return"";if((void 0===e||e>this.length)&&(e=this.length),e<=0)return"";if((e>>>=0)<=(r>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return T(this,r,e);case"utf8":case"utf-8":return A(this,r,e);case"ascii":return U(this,r,e);case"latin1":case"binary":return R(this,r,e);case"base64":return B(this,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _(this,r,e);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}.apply(this,arguments)},r.prototype.toLocaleString=r.prototype.toString,r.prototype.equals=function(t){if(!r.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===r.compare(this,t)},r.prototype.inspect=function(){var t="",r=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(t+=" ... "),"<Buffer "+t+">"},r.prototype.compare=function(t,e,n,i,o){if(j(t,Uint8Array)&&(t=r.from(t,t.offset,t.byteLength)),!r.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===n&&(n=t?t.length:0),void 0===i&&(i=0),void 0===o&&(o=this.length),e<0||n>t.length||i<0||o>this.length)throw new RangeError("out of range index");if(i>=o&&e>=n)return 0;if(i>=o)return-1;if(e>=n)return 1;if(this===t)return 0;for(var f=(o>>>=0)-(i>>>=0),u=(n>>>=0)-(e>>>=0),s=Math.min(f,u),h=this.slice(i,o),a=t.slice(e,n),c=0;c<s;++c)if(h[c]!==a[c]){f=h[c],u=a[c];break}return f<u?-1:u<f?1:0},r.prototype.includes=function(t,r,e){return-1!==this.indexOf(t,r,e)},r.prototype.indexOf=function(t,r,e){return y(this,t,r,e,!0)},r.prototype.lastIndexOf=function(t,r,e){return y(this,t,r,e,!1)},r.prototype.write=function(t,r,e,n){if(void 0===r)n="utf8",e=this.length,r=0;else if(void 0===e&&"string"==typeof r)n=r,e=this.length,r=0;else{if(!isFinite(r))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");r>>>=0,isFinite(e)?(e>>>=0,void 0===n&&(n="utf8")):(n=e,e=void 0)}var i=this.length-r;if((void 0===e||e>i)&&(e=i),t.length>0&&(e<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return w(this,t,r,e);case"utf8":case"utf-8":return d(this,t,r,e);case"ascii":return b(this,t,r,e);case"latin1":case"binary":return m(this,t,r,e);case"base64":return E(this,t,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return v(this,t,r,e);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},r.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var I=4096;function U(t,r,e){var n="";e=Math.min(t.length,e);for(var i=r;i<e;++i)n+=String.fromCharCode(127&t[i]);return n}function R(t,r,e){var n="";e=Math.min(t.length,e);for(var i=r;i<e;++i)n+=String.fromCharCode(t[i]);return n}function T(t,r,e){var n=t.length;(!r||r<0)&&(r=0),(!e||e<0||e>n)&&(e=n);for(var i="",o=r;o<e;++o)i+=N(t[o]);return i}function _(t,r,e){for(var n=t.slice(r,e),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function L(t,r,e){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+r>e)throw new RangeError("Trying to access beyond buffer length")}function S(t,e,n,i,o,f){if(!r.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>o||e<f)throw new RangeError('"value" argument is out of bounds');if(n+i>t.length)throw new RangeError("Index out of range")}function O(t,r,e,n,i,o){if(e+n>t.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function C(t,r,e,n,o){return r=+r,e>>>=0,o||O(t,0,e,4),i.write(t,r,e,n,23,4),e+4}function x(t,r,e,n,o){return r=+r,e>>>=0,o||O(t,0,e,8),i.write(t,r,e,n,52,8),e+8}r.prototype.slice=function(t,e){var n=this.length;(t=~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),(e=void 0===e?n:~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),e<t&&(e=t);var i=this.subarray(t,e);return i.__proto__=r.prototype,i},r.prototype.readUIntLE=function(t,r,e){t>>>=0,r>>>=0,e||L(t,r,this.length);for(var n=this[t],i=1,o=0;++o<r&&(i*=256);)n+=this[t+o]*i;return n},r.prototype.readUIntBE=function(t,r,e){t>>>=0,r>>>=0,e||L(t,r,this.length);for(var n=this[t+--r],i=1;r>0&&(i*=256);)n+=this[t+--r]*i;return n},r.prototype.readUInt8=function(t,r){return t>>>=0,r||L(t,1,this.length),this[t]},r.prototype.readUInt16LE=function(t,r){return t>>>=0,r||L(t,2,this.length),this[t]|this[t+1]<<8},r.prototype.readUInt16BE=function(t,r){return t>>>=0,r||L(t,2,this.length),this[t]<<8|this[t+1]},r.prototype.readUInt32LE=function(t,r){return t>>>=0,r||L(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},r.prototype.readUInt32BE=function(t,r){return t>>>=0,r||L(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},r.prototype.readIntLE=function(t,r,e){t>>>=0,r>>>=0,e||L(t,r,this.length);for(var n=this[t],i=1,o=0;++o<r&&(i*=256);)n+=this[t+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*r)),n},r.prototype.readIntBE=function(t,r,e){t>>>=0,r>>>=0,e||L(t,r,this.length);for(var n=r,i=1,o=this[t+--n];n>0&&(i*=256);)o+=this[t+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*r)),o},r.prototype.readInt8=function(t,r){return t>>>=0,r||L(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},r.prototype.readInt16LE=function(t,r){t>>>=0,r||L(t,2,this.length);var e=this[t]|this[t+1]<<8;return 32768&e?4294901760|e:e},r.prototype.readInt16BE=function(t,r){t>>>=0,r||L(t,2,this.length);var e=this[t+1]|this[t]<<8;return 32768&e?4294901760|e:e},r.prototype.readInt32LE=function(t,r){return t>>>=0,r||L(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},r.prototype.readInt32BE=function(t,r){return t>>>=0,r||L(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},r.prototype.readFloatLE=function(t,r){return t>>>=0,r||L(t,4,this.length),i.read(this,t,!0,23,4)},r.prototype.readFloatBE=function(t,r){return t>>>=0,r||L(t,4,this.length),i.read(this,t,!1,23,4)},r.prototype.readDoubleLE=function(t,r){return t>>>=0,r||L(t,8,this.length),i.read(this,t,!0,52,8)},r.prototype.readDoubleBE=function(t,r){return t>>>=0,r||L(t,8,this.length),i.read(this,t,!1,52,8)},r.prototype.writeUIntLE=function(t,r,e,n){(t=+t,r>>>=0,e>>>=0,n)||S(this,t,r,e,Math.pow(2,8*e)-1,0);var i=1,o=0;for(this[r]=255&t;++o<e&&(i*=256);)this[r+o]=t/i&255;return r+e},r.prototype.writeUIntBE=function(t,r,e,n){(t=+t,r>>>=0,e>>>=0,n)||S(this,t,r,e,Math.pow(2,8*e)-1,0);var i=e-1,o=1;for(this[r+i]=255&t;--i>=0&&(o*=256);)this[r+i]=t/o&255;return r+e},r.prototype.writeUInt8=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,1,255,0),this[r]=255&t,r+1},r.prototype.writeUInt16LE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,2,65535,0),this[r]=255&t,this[r+1]=t>>>8,r+2},r.prototype.writeUInt16BE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,2,65535,0),this[r]=t>>>8,this[r+1]=255&t,r+2},r.prototype.writeUInt32LE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,4,4294967295,0),this[r+3]=t>>>24,this[r+2]=t>>>16,this[r+1]=t>>>8,this[r]=255&t,r+4},r.prototype.writeUInt32BE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,4,4294967295,0),this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t,r+4},r.prototype.writeIntLE=function(t,r,e,n){if(t=+t,r>>>=0,!n){var i=Math.pow(2,8*e-1);S(this,t,r,e,i-1,-i)}var o=0,f=1,u=0;for(this[r]=255&t;++o<e&&(f*=256);)t<0&&0===u&&0!==this[r+o-1]&&(u=1),this[r+o]=(t/f>>0)-u&255;return r+e},r.prototype.writeIntBE=function(t,r,e,n){if(t=+t,r>>>=0,!n){var i=Math.pow(2,8*e-1);S(this,t,r,e,i-1,-i)}var o=e-1,f=1,u=0;for(this[r+o]=255&t;--o>=0&&(f*=256);)t<0&&0===u&&0!==this[r+o+1]&&(u=1),this[r+o]=(t/f>>0)-u&255;return r+e},r.prototype.writeInt8=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,1,127,-128),t<0&&(t=255+t+1),this[r]=255&t,r+1},r.prototype.writeInt16LE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,2,32767,-32768),this[r]=255&t,this[r+1]=t>>>8,r+2},r.prototype.writeInt16BE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,2,32767,-32768),this[r]=t>>>8,this[r+1]=255&t,r+2},r.prototype.writeInt32LE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,4,2147483647,-2147483648),this[r]=255&t,this[r+1]=t>>>8,this[r+2]=t>>>16,this[r+3]=t>>>24,r+4},r.prototype.writeInt32BE=function(t,r,e){return t=+t,r>>>=0,e||S(this,t,r,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t,r+4},r.prototype.writeFloatLE=function(t,r,e){return C(this,t,r,!0,e)},r.prototype.writeFloatBE=function(t,r,e){return C(this,t,r,!1,e)},r.prototype.writeDoubleLE=function(t,r,e){return x(this,t,r,!0,e)},r.prototype.writeDoubleBE=function(t,r,e){return x(this,t,r,!1,e)},r.prototype.copy=function(t,e,n,i){if(!r.isBuffer(t))throw new TypeError("argument should be a Buffer");if(n||(n=0),i||0===i||(i=this.length),e>=t.length&&(e=t.length),e||(e=0),i>0&&i<n&&(i=n),i===n)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),t.length-e<i-n&&(i=t.length-e+n);var o=i-n;if(this===t&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(e,n,i);else if(this===t&&n<e&&e<i)for(var f=o-1;f>=0;--f)t[f+e]=this[f+n];else Uint8Array.prototype.set.call(t,this.subarray(n,i),e);return o},r.prototype.fill=function(t,e,n,i){if("string"==typeof t){if("string"==typeof e?(i=e,e=0,n=this.length):"string"==typeof n&&(i=n,n=this.length),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!r.isEncoding(i))throw new TypeError("Unknown encoding: "+i);if(1===t.length){var o=t.charCodeAt(0);("utf8"===i&&o<128||"latin1"===i)&&(t=o)}}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<n)throw new RangeError("Out of range index");if(n<=e)return this;var f;if(e>>>=0,n=void 0===n?this.length:n>>>0,t||(t=0),"number"==typeof t)for(f=e;f<n;++f)this[f]=t;else{var u=r.isBuffer(t)?t:r.from(t,i),s=u.length;if(0===s)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(f=0;f<n-e;++f)this[f+e]=u[f%s]}return this};var M=/[^+\/0-9A-Za-z-_]/g;function N(t){return t<16?"0"+t.toString(16):t.toString(16)}function P(t,r){var e;r=r||1/0;for(var n=t.length,i=null,o=[],f=0;f<n;++f){if((e=t.charCodeAt(f))>55295&&e<57344){if(!i){if(e>56319){(r-=3)>-1&&o.push(239,191,189);continue}if(f+1===n){(r-=3)>-1&&o.push(239,191,189);continue}i=e;continue}if(e<56320){(r-=3)>-1&&o.push(239,191,189),i=e;continue}e=65536+(i-55296<<10|e-56320)}else i&&(r-=3)>-1&&o.push(239,191,189);if(i=null,e<128){if((r-=1)<0)break;o.push(e)}else if(e<2048){if((r-=2)<0)break;o.push(e>>6|192,63&e|128)}else if(e<65536){if((r-=3)<0)break;o.push(e>>12|224,e>>6&63|128,63&e|128)}else{if(!(e<1114112))throw new Error("Invalid code point");if((r-=4)<0)break;o.push(e>>18|240,e>>12&63|128,e>>6&63|128,63&e|128)}}return o}function k(t){return n.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(M,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function $(t,r,e,n){for(var i=0;i<n&&!(i+e>=r.length||i>=t.length);++i)r[i+e]=t[i];return i}function j(t,r){return t instanceof r||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===r.name}function F(t){return t!=t}}).call(this,t("buffer").Buffer)},{"base64-js":1,buffer:2,ieee754:3}],3:[function(t,r,e){e.read=function(t,r,e,n,i){var o,f,u=8*i-n-1,s=(1<<u)-1,h=s>>1,a=-7,c=e?i-1:0,p=e?-1:1,l=t[r+c];for(c+=p,o=l&(1<<-a)-1,l>>=-a,a+=u;a>0;o=256*o+t[r+c],c+=p,a-=8);for(f=o&(1<<-a)-1,o>>=-a,a+=n;a>0;f=256*f+t[r+c],c+=p,a-=8);if(0===o)o=1-h;else{if(o===s)return f?NaN:1/0*(l?-1:1);f+=Math.pow(2,n),o-=h}return(l?-1:1)*f*Math.pow(2,o-n)},e.write=function(t,r,e,n,i,o){var f,u,s,h=8*o-i-1,a=(1<<h)-1,c=a>>1,p=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,l=n?0:o-1,y=n?1:-1,g=r<0||0===r&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(u=isNaN(r)?1:0,f=a):(f=Math.floor(Math.log(r)/Math.LN2),r*(s=Math.pow(2,-f))<1&&(f--,s*=2),(r+=f+c>=1?p/s:p*Math.pow(2,1-c))*s>=2&&(f++,s/=2),f+c>=a?(u=0,f=a):f+c>=1?(u=(r*s-1)*Math.pow(2,i),f+=c):(u=r*Math.pow(2,c-1)*Math.pow(2,i),f=0));i>=8;t[e+l]=255&u,l+=y,u/=256,i-=8);for(f=f<<i|u,h+=i;h>0;t[e+l]=255&f,l+=y,f/=256,h-=8);t[e+l-y]|=128*g}},{}],4:[function(t,r,e){(function(r){"use strict";const n=t("base64-js"),i=t("ieee754"),o="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=r,e.SlowBuffer=function(t){+t!=t&&(t=0);return r.alloc(+t)},e.INSPECT_MAX_BYTES=50;const f=2147483647;function u(t){if(t>f)throw new RangeError('The value "'+t+'" is invalid for option "size"');const e=new Uint8Array(t);return Object.setPrototypeOf(e,r.prototype),e}function r(t,r,e){if("number"==typeof t){if("string"==typeof r)throw new TypeError('The "string" argument must be of type string. Received type number');return a(t)}return s(t,r,e)}function s(t,e,n){if("string"==typeof t)return function(t,e){"string"==typeof e&&""!==e||(e="utf8");if(!r.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const n=0|y(t,e);let i=u(n);const o=i.write(t,e);o!==n&&(i=i.slice(0,o));return i}(t,e);if(ArrayBuffer.isView(t))return function(t){if(W(t,Uint8Array)){const r=new Uint8Array(t);return p(r.buffer,r.byteOffset,r.byteLength)}return c(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(W(t,ArrayBuffer)||t&&W(t.buffer,ArrayBuffer))return p(t,e,n);if("undefined"!=typeof SharedArrayBuffer&&(W(t,SharedArrayBuffer)||t&&W(t.buffer,SharedArrayBuffer)))return p(t,e,n);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');const i=t.valueOf&&t.valueOf();if(null!=i&&i!==t)return r.from(i,e,n);const o=function(t){if(r.isBuffer(t)){const r=0|l(t.length),e=u(r);return 0===e.length?e:(t.copy(e,0,0,r),e)}if(void 0!==t.length)return"number"!=typeof t.length||X(t.length)?u(0):c(t);if("Buffer"===t.type&&Array.isArray(t.data))return c(t.data)}(t);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return r.from(t[Symbol.toPrimitive]("string"),e,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function h(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function a(t){return h(t),u(t<0?0:0|l(t))}function c(t){const r=t.length<0?0:0|l(t.length),e=u(r);for(let n=0;n<r;n+=1)e[n]=255&t[n];return e}function p(t,e,n){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(n||0))throw new RangeError('"length" is outside of buffer bounds');let i;return i=void 0===e&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,e):new Uint8Array(t,e,n),Object.setPrototypeOf(i,r.prototype),i}function l(t){if(t>=f)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+f.toString(16)+" bytes");return 0|t}function y(t,e){if(r.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||W(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);const n=t.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===n)return 0;let o=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return q(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return G(t).length;default:if(o)return i?-1:q(t).length;e=(""+e).toLowerCase(),o=!0}}function g(t,r,e){const n=t[r];t[r]=t[e],t[e]=n}function w(t,e,n,i,o){if(0===t.length)return-1;if("string"==typeof n?(i=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),X(n=+n)&&(n=o?0:t.length-1),n<0&&(n=t.length+n),n>=t.length){if(o)return-1;n=t.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof e&&(e=r.from(e,i)),r.isBuffer(e))return 0===e.length?-1:d(t,e,n,i,o);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(t,e,n):Uint8Array.prototype.lastIndexOf.call(t,e,n):d(t,[e],n,i,o);throw new TypeError("val must be string, number or Buffer")}function d(t,r,e,n,i){let o,f=1,u=t.length,s=r.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||r.length<2)return-1;f=2,u/=2,s/=2,e/=2}function h(t,r){return 1===f?t[r]:t.readUInt16BE(r*f)}if(i){let n=-1;for(o=e;o<u;o++)if(h(t,o)===h(r,-1===n?0:o-n)){if(-1===n&&(n=o),o-n+1===s)return n*f}else-1!==n&&(o-=o-n),n=-1}else for(e+s>u&&(e=u-s),o=e;o>=0;o--){let e=!0;for(let n=0;n<s;n++)if(h(t,o+n)!==h(r,n)){e=!1;break}if(e)return o}return-1}function b(t,r,e,n){e=Number(e)||0;const i=t.length-e;n?(n=Number(n))>i&&(n=i):n=i;const o=r.length;let f;for(n>o/2&&(n=o/2),f=0;f<n;++f){const n=parseInt(r.substr(2*f,2),16);if(X(n))return f;t[e+f]=n}return f}function m(t,r,e,n){return V(q(r,t.length-e),t,e,n)}function E(t,r,e,n){return V(function(t){const r=[];for(let e=0;e<t.length;++e)r.push(255&t.charCodeAt(e));return r}(r),t,e,n)}function v(t,r,e,n){return V(G(r),t,e,n)}function B(t,r,e,n){return V(function(t,r){let e,n,i;const o=[];for(let f=0;f<t.length&&!((r-=2)<0);++f)e=t.charCodeAt(f),n=e>>8,i=e%256,o.push(i),o.push(n);return o}(r,t.length-e),t,e,n)}function A(t,r,e){return 0===r&&e===t.length?n.fromByteArray(t):n.fromByteArray(t.slice(r,e))}function I(t,r,e){e=Math.min(t.length,e);const n=[];let i=r;for(;i<e;){const r=t[i];let o=null,f=r>239?4:r>223?3:r>191?2:1;if(i+f<=e){let e,n,u,s;switch(f){case 1:r<128&&(o=r);break;case 2:128==(192&(e=t[i+1]))&&(s=(31&r)<<6|63&e)>127&&(o=s);break;case 3:e=t[i+1],n=t[i+2],128==(192&e)&&128==(192&n)&&(s=(15&r)<<12|(63&e)<<6|63&n)>2047&&(s<55296||s>57343)&&(o=s);break;case 4:e=t[i+1],n=t[i+2],u=t[i+3],128==(192&e)&&128==(192&n)&&128==(192&u)&&(s=(15&r)<<18|(63&e)<<12|(63&n)<<6|63&u)>65535&&s<1114112&&(o=s)}}null===o?(o=65533,f=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),i+=f}return function(t){const r=t.length;if(r<=U)return String.fromCharCode.apply(String,t);let e="",n=0;for(;n<r;)e+=String.fromCharCode.apply(String,t.slice(n,n+=U));return e}(n)}e.kMaxLength=f,r.TYPED_ARRAY_SUPPORT=function(){try{const t=new Uint8Array(1),r={foo:function(){return 42}};return Object.setPrototypeOf(r,Uint8Array.prototype),Object.setPrototypeOf(t,r),42===t.foo()}catch(t){return!1}}(),r.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(r.prototype,"parent",{enumerable:!0,get:function(){if(r.isBuffer(this))return this.buffer}}),Object.defineProperty(r.prototype,"offset",{enumerable:!0,get:function(){if(r.isBuffer(this))return this.byteOffset}}),r.poolSize=8192,r.from=function(t,r,e){return s(t,r,e)},Object.setPrototypeOf(r.prototype,Uint8Array.prototype),Object.setPrototypeOf(r,Uint8Array),r.alloc=function(t,r,e){return function(t,r,e){return h(t),t<=0?u(t):void 0!==r?"string"==typeof e?u(t).fill(r,e):u(t).fill(r):u(t)}(t,r,e)},r.allocUnsafe=function(t){return a(t)},r.allocUnsafeSlow=function(t){return a(t)},r.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==r.prototype},r.compare=function(t,e){if(W(t,Uint8Array)&&(t=r.from(t,t.offset,t.byteLength)),W(e,Uint8Array)&&(e=r.from(e,e.offset,e.byteLength)),!r.isBuffer(t)||!r.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let n=t.length,i=e.length;for(let r=0,o=Math.min(n,i);r<o;++r)if(t[r]!==e[r]){n=t[r],i=e[r];break}return n<i?-1:i<n?1:0},r.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return r.alloc(0);let n;if(void 0===e)for(e=0,n=0;n<t.length;++n)e+=t[n].length;const i=r.allocUnsafe(e);let o=0;for(n=0;n<t.length;++n){let e=t[n];if(W(e,Uint8Array))o+e.length>i.length?(r.isBuffer(e)||(e=r.from(e)),e.copy(i,o)):Uint8Array.prototype.set.call(i,e,o);else{if(!r.isBuffer(e))throw new TypeError('"list" argument must be an Array of Buffers');e.copy(i,o)}o+=e.length}return i},r.byteLength=y,r.prototype._isBuffer=!0,r.prototype.swap16=function(){const t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<t;r+=2)g(this,r,r+1);return this},r.prototype.swap32=function(){const t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<t;r+=4)g(this,r,r+3),g(this,r+1,r+2);return this},r.prototype.swap64=function(){const t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<t;r+=8)g(this,r,r+7),g(this,r+1,r+6),g(this,r+2,r+5),g(this,r+3,r+4);return this},r.prototype.toString=function(){const t=this.length;return 0===t?"":0===arguments.length?I(this,0,t):function(t,r,e){let n=!1;if((void 0===r||r<0)&&(r=0),r>this.length)return"";if((void 0===e||e>this.length)&&(e=this.length),e<=0)return"";if((e>>>=0)<=(r>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return _(this,r,e);case"utf8":case"utf-8":return I(this,r,e);case"ascii":return R(this,r,e);case"latin1":case"binary":return T(this,r,e);case"base64":return A(this,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return L(this,r,e);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}.apply(this,arguments)},r.prototype.toLocaleString=r.prototype.toString,r.prototype.equals=function(t){if(!r.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===r.compare(this,t)},r.prototype.inspect=function(){let t="";const r=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(t+=" ... "),"<Buffer "+t+">"},o&&(r.prototype[o]=r.prototype.inspect),r.prototype.compare=function(t,e,n,i,o){if(W(t,Uint8Array)&&(t=r.from(t,t.offset,t.byteLength)),!r.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===n&&(n=t?t.length:0),void 0===i&&(i=0),void 0===o&&(o=this.length),e<0||n>t.length||i<0||o>this.length)throw new RangeError("out of range index");if(i>=o&&e>=n)return 0;if(i>=o)return-1;if(e>=n)return 1;if(this===t)return 0;let f=(o>>>=0)-(i>>>=0),u=(n>>>=0)-(e>>>=0);const s=Math.min(f,u),h=this.slice(i,o),a=t.slice(e,n);for(let t=0;t<s;++t)if(h[t]!==a[t]){f=h[t],u=a[t];break}return f<u?-1:u<f?1:0},r.prototype.includes=function(t,r,e){return-1!==this.indexOf(t,r,e)},r.prototype.indexOf=function(t,r,e){return w(this,t,r,e,!0)},r.prototype.lastIndexOf=function(t,r,e){return w(this,t,r,e,!1)},r.prototype.write=function(t,r,e,n){if(void 0===r)n="utf8",e=this.length,r=0;else if(void 0===e&&"string"==typeof r)n=r,e=this.length,r=0;else{if(!isFinite(r))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");r>>>=0,isFinite(e)?(e>>>=0,void 0===n&&(n="utf8")):(n=e,e=void 0)}const i=this.length-r;if((void 0===e||e>i)&&(e=i),t.length>0&&(e<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let o=!1;for(;;)switch(n){case"hex":return b(this,t,r,e);case"utf8":case"utf-8":return m(this,t,r,e);case"ascii":case"latin1":case"binary":return E(this,t,r,e);case"base64":return v(this,t,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,t,r,e);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},r.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const U=4096;function R(t,r,e){let n="";e=Math.min(t.length,e);for(let i=r;i<e;++i)n+=String.fromCharCode(127&t[i]);return n}function T(t,r,e){let n="";e=Math.min(t.length,e);for(let i=r;i<e;++i)n+=String.fromCharCode(t[i]);return n}function _(t,r,e){const n=t.length;(!r||r<0)&&(r=0),(!e||e<0||e>n)&&(e=n);let i="";for(let n=r;n<e;++n)i+=J[t[n]];return i}function L(t,r,e){const n=t.slice(r,e);let i="";for(let t=0;t<n.length-1;t+=2)i+=String.fromCharCode(n[t]+256*n[t+1]);return i}function S(t,r,e){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+r>e)throw new RangeError("Trying to access beyond buffer length")}function O(t,e,n,i,o,f){if(!r.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>o||e<f)throw new RangeError('"value" argument is out of bounds');if(n+i>t.length)throw new RangeError("Index out of range")}function C(t,r,e,n,i){F(r,n,i,t,e,7);let o=Number(r&BigInt(4294967295));t[e++]=o,o>>=8,t[e++]=o,o>>=8,t[e++]=o,o>>=8,t[e++]=o;let f=Number(r>>BigInt(32)&BigInt(4294967295));return t[e++]=f,f>>=8,t[e++]=f,f>>=8,t[e++]=f,f>>=8,t[e++]=f,e}function x(t,r,e,n,i){F(r,n,i,t,e,7);let o=Number(r&BigInt(4294967295));t[e+7]=o,o>>=8,t[e+6]=o,o>>=8,t[e+5]=o,o>>=8,t[e+4]=o;let f=Number(r>>BigInt(32)&BigInt(4294967295));return t[e+3]=f,f>>=8,t[e+2]=f,f>>=8,t[e+1]=f,f>>=8,t[e]=f,e+8}function M(t,r,e,n,i,o){if(e+n>t.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function N(t,r,e,n,o){return r=+r,e>>>=0,o||M(t,0,e,4),i.write(t,r,e,n,23,4),e+4}function P(t,r,e,n,o){return r=+r,e>>>=0,o||M(t,0,e,8),i.write(t,r,e,n,52,8),e+8}r.prototype.slice=function(t,e){const n=this.length;(t=~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),(e=void 0===e?n:~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),e<t&&(e=t);const i=this.subarray(t,e);return Object.setPrototypeOf(i,r.prototype),i},r.prototype.readUintLE=r.prototype.readUIntLE=function(t,r,e){t>>>=0,r>>>=0,e||S(t,r,this.length);let n=this[t],i=1,o=0;for(;++o<r&&(i*=256);)n+=this[t+o]*i;return n},r.prototype.readUintBE=r.prototype.readUIntBE=function(t,r,e){t>>>=0,r>>>=0,e||S(t,r,this.length);let n=this[t+--r],i=1;for(;r>0&&(i*=256);)n+=this[t+--r]*i;return n},r.prototype.readUint8=r.prototype.readUInt8=function(t,r){return t>>>=0,r||S(t,1,this.length),this[t]},r.prototype.readUint16LE=r.prototype.readUInt16LE=function(t,r){return t>>>=0,r||S(t,2,this.length),this[t]|this[t+1]<<8},r.prototype.readUint16BE=r.prototype.readUInt16BE=function(t,r){return t>>>=0,r||S(t,2,this.length),this[t]<<8|this[t+1]},r.prototype.readUint32LE=r.prototype.readUInt32LE=function(t,r){return t>>>=0,r||S(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},r.prototype.readUint32BE=r.prototype.readUInt32BE=function(t,r){return t>>>=0,r||S(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},r.prototype.readBigUInt64LE=Z(function(t){z(t>>>=0,"offset");const r=this[t],e=this[t+7];void 0!==r&&void 0!==e||D(t,this.length-8);const n=r+256*this[++t]+65536*this[++t]+this[++t]*2**24,i=this[++t]+256*this[++t]+65536*this[++t]+e*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))}),r.prototype.readBigUInt64BE=Z(function(t){z(t>>>=0,"offset");const r=this[t],e=this[t+7];void 0!==r&&void 0!==e||D(t,this.length-8);const n=r*2**24+65536*this[++t]+256*this[++t]+this[++t],i=this[++t]*2**24+65536*this[++t]+256*this[++t]+e;return(BigInt(n)<<BigInt(32))+BigInt(i)}),r.prototype.readIntLE=function(t,r,e){t>>>=0,r>>>=0,e||S(t,r,this.length);let n=this[t],i=1,o=0;for(;++o<r&&(i*=256);)n+=this[t+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*r)),n},r.prototype.readIntBE=function(t,r,e){t>>>=0,r>>>=0,e||S(t,r,this.length);let n=r,i=1,o=this[t+--n];for(;n>0&&(i*=256);)o+=this[t+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*r)),o},r.prototype.readInt8=function(t,r){return t>>>=0,r||S(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},r.prototype.readInt16LE=function(t,r){t>>>=0,r||S(t,2,this.length);const e=this[t]|this[t+1]<<8;return 32768&e?4294901760|e:e},r.prototype.readInt16BE=function(t,r){t>>>=0,r||S(t,2,this.length);const e=this[t+1]|this[t]<<8;return 32768&e?4294901760|e:e},r.prototype.readInt32LE=function(t,r){return t>>>=0,r||S(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},r.prototype.readInt32BE=function(t,r){return t>>>=0,r||S(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},r.prototype.readBigInt64LE=Z(function(t){z(t>>>=0,"offset");const r=this[t],e=this[t+7];void 0!==r&&void 0!==e||D(t,this.length-8);const n=this[t+4]+256*this[t+5]+65536*this[t+6]+(e<<24);return(BigInt(n)<<BigInt(32))+BigInt(r+256*this[++t]+65536*this[++t]+this[++t]*2**24)}),r.prototype.readBigInt64BE=Z(function(t){z(t>>>=0,"offset");const r=this[t],e=this[t+7];void 0!==r&&void 0!==e||D(t,this.length-8);const n=(r<<24)+65536*this[++t]+256*this[++t]+this[++t];return(BigInt(n)<<BigInt(32))+BigInt(this[++t]*2**24+65536*this[++t]+256*this[++t]+e)}),r.prototype.readFloatLE=function(t,r){return t>>>=0,r||S(t,4,this.length),i.read(this,t,!0,23,4)},r.prototype.readFloatBE=function(t,r){return t>>>=0,r||S(t,4,this.length),i.read(this,t,!1,23,4)},r.prototype.readDoubleLE=function(t,r){return t>>>=0,r||S(t,8,this.length),i.read(this,t,!0,52,8)},r.prototype.readDoubleBE=function(t,r){return t>>>=0,r||S(t,8,this.length),i.read(this,t,!1,52,8)},r.prototype.writeUintLE=r.prototype.writeUIntLE=function(t,r,e,n){if(t=+t,r>>>=0,e>>>=0,!n){O(this,t,r,e,Math.pow(2,8*e)-1,0)}let i=1,o=0;for(this[r]=255&t;++o<e&&(i*=256);)this[r+o]=t/i&255;return r+e},r.prototype.writeUintBE=r.prototype.writeUIntBE=function(t,r,e,n){if(t=+t,r>>>=0,e>>>=0,!n){O(this,t,r,e,Math.pow(2,8*e)-1,0)}let i=e-1,o=1;for(this[r+i]=255&t;--i>=0&&(o*=256);)this[r+i]=t/o&255;return r+e},r.prototype.writeUint8=r.prototype.writeUInt8=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,1,255,0),this[r]=255&t,r+1},r.prototype.writeUint16LE=r.prototype.writeUInt16LE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,2,65535,0),this[r]=255&t,this[r+1]=t>>>8,r+2},r.prototype.writeUint16BE=r.prototype.writeUInt16BE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,2,65535,0),this[r]=t>>>8,this[r+1]=255&t,r+2},r.prototype.writeUint32LE=r.prototype.writeUInt32LE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,4,4294967295,0),this[r+3]=t>>>24,this[r+2]=t>>>16,this[r+1]=t>>>8,this[r]=255&t,r+4},r.prototype.writeUint32BE=r.prototype.writeUInt32BE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,4,4294967295,0),this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t,r+4},r.prototype.writeBigUInt64LE=Z(function(t,r=0){return C(this,t,r,BigInt(0),BigInt("0xffffffffffffffff"))}),r.prototype.writeBigUInt64BE=Z(function(t,r=0){return x(this,t,r,BigInt(0),BigInt("0xffffffffffffffff"))}),r.prototype.writeIntLE=function(t,r,e,n){if(t=+t,r>>>=0,!n){const n=Math.pow(2,8*e-1);O(this,t,r,e,n-1,-n)}let i=0,o=1,f=0;for(this[r]=255&t;++i<e&&(o*=256);)t<0&&0===f&&0!==this[r+i-1]&&(f=1),this[r+i]=(t/o>>0)-f&255;return r+e},r.prototype.writeIntBE=function(t,r,e,n){if(t=+t,r>>>=0,!n){const n=Math.pow(2,8*e-1);O(this,t,r,e,n-1,-n)}let i=e-1,o=1,f=0;for(this[r+i]=255&t;--i>=0&&(o*=256);)t<0&&0===f&&0!==this[r+i+1]&&(f=1),this[r+i]=(t/o>>0)-f&255;return r+e},r.prototype.writeInt8=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,1,127,-128),t<0&&(t=255+t+1),this[r]=255&t,r+1},r.prototype.writeInt16LE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,2,32767,-32768),this[r]=255&t,this[r+1]=t>>>8,r+2},r.prototype.writeInt16BE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,2,32767,-32768),this[r]=t>>>8,this[r+1]=255&t,r+2},r.prototype.writeInt32LE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,4,2147483647,-2147483648),this[r]=255&t,this[r+1]=t>>>8,this[r+2]=t>>>16,this[r+3]=t>>>24,r+4},r.prototype.writeInt32BE=function(t,r,e){return t=+t,r>>>=0,e||O(this,t,r,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t,r+4},r.prototype.writeBigInt64LE=Z(function(t,r=0){return C(this,t,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),r.prototype.writeBigInt64BE=Z(function(t,r=0){return x(this,t,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),r.prototype.writeFloatLE=function(t,r,e){return N(this,t,r,!0,e)},r.prototype.writeFloatBE=function(t,r,e){return N(this,t,r,!1,e)},r.prototype.writeDoubleLE=function(t,r,e){return P(this,t,r,!0,e)},r.prototype.writeDoubleBE=function(t,r,e){return P(this,t,r,!1,e)},r.prototype.copy=function(t,e,n,i){if(!r.isBuffer(t))throw new TypeError("argument should be a Buffer");if(n||(n=0),i||0===i||(i=this.length),e>=t.length&&(e=t.length),e||(e=0),i>0&&i<n&&(i=n),i===n)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),t.length-e<i-n&&(i=t.length-e+n);const o=i-n;return this===t&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(e,n,i):Uint8Array.prototype.set.call(t,this.subarray(n,i),e),o},r.prototype.fill=function(t,e,n,i){if("string"==typeof t){if("string"==typeof e?(i=e,e=0,n=this.length):"string"==typeof n&&(i=n,n=this.length),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!r.isEncoding(i))throw new TypeError("Unknown encoding: "+i);if(1===t.length){const r=t.charCodeAt(0);("utf8"===i&&r<128||"latin1"===i)&&(t=r)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<n)throw new RangeError("Out of range index");if(n<=e)return this;let o;if(e>>>=0,n=void 0===n?this.length:n>>>0,t||(t=0),"number"==typeof t)for(o=e;o<n;++o)this[o]=t;else{const f=r.isBuffer(t)?t:r.from(t,i),u=f.length;if(0===u)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(o=0;o<n-e;++o)this[o+e]=f[o%u]}return this};const k={};function $(t,r,e){k[t]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:r.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(t){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:t,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}function j(t){let r="",e=t.length;const n="-"===t[0]?1:0;for(;e>=n+4;e-=3)r=`_${t.slice(e-3,e)}${r}`;return`${t.slice(0,e)}${r}`}function F(t,r,e,n,i,o){if(t>e||t<r){const n="bigint"==typeof r?"n":"";let i;throw i=o>3?0===r||r===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(o+1)}${n}`:`>= -(2${n} ** ${8*(o+1)-1}${n}) and < 2 ** `+`${8*(o+1)-1}${n}`:`>= ${r}${n} and <= ${e}${n}`,new k.ERR_OUT_OF_RANGE("value",i,t)}!function(t,r,e){z(r,"offset"),void 0!==t[r]&&void 0!==t[r+e]||D(r,t.length-(e+1))}(n,i,o)}function z(t,r){if("number"!=typeof t)throw new k.ERR_INVALID_ARG_TYPE(r,"number",t)}function D(t,r,e){if(Math.floor(t)!==t)throw z(t,e),new k.ERR_OUT_OF_RANGE(e||"offset","an integer",t);if(r<0)throw new k.ERR_BUFFER_OUT_OF_BOUNDS;throw new k.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${r}`,t)}$("ERR_BUFFER_OUT_OF_BOUNDS",function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),$("ERR_INVALID_ARG_TYPE",function(t,r){return`The "${t}" argument must be of type number. Received type ${typeof r}`},TypeError),$("ERR_OUT_OF_RANGE",function(t,r,e){let n=`The value of "${t}" is out of range.`,i=e;return Number.isInteger(e)&&Math.abs(e)>2**32?i=j(String(e)):"bigint"==typeof e&&(i=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(i=j(i)),i+="n"),n+=` It must be ${r}. Received ${i}`},RangeError);const Y=/[^+\/0-9A-Za-z-_]/g;function q(t,r){let e;r=r||1/0;const n=t.length;let i=null;const o=[];for(let f=0;f<n;++f){if((e=t.charCodeAt(f))>55295&&e<57344){if(!i){if(e>56319){(r-=3)>-1&&o.push(239,191,189);continue}if(f+1===n){(r-=3)>-1&&o.push(239,191,189);continue}i=e;continue}if(e<56320){(r-=3)>-1&&o.push(239,191,189),i=e;continue}e=65536+(i-55296<<10|e-56320)}else i&&(r-=3)>-1&&o.push(239,191,189);if(i=null,e<128){if((r-=1)<0)break;o.push(e)}else if(e<2048){if((r-=2)<0)break;o.push(e>>6|192,63&e|128)}else if(e<65536){if((r-=3)<0)break;o.push(e>>12|224,e>>6&63|128,63&e|128)}else{if(!(e<1114112))throw new Error("Invalid code point");if((r-=4)<0)break;o.push(e>>18|240,e>>12&63|128,e>>6&63|128,63&e|128)}}return o}function G(t){return n.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(Y,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function V(t,r,e,n){let i;for(i=0;i<n&&!(i+e>=r.length||i>=t.length);++i)r[i+e]=t[i];return i}function W(t,r){return t instanceof r||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===r.name}function X(t){return t!=t}const J=function(){const t=new Array(256);for(let r=0;r<16;++r){const e=16*r;for(let n=0;n<16;++n)t[e+n]="0123456789abcdef"[r]+"0123456789abcdef"[n]}return t}();function Z(t){return"undefined"==typeof BigInt?H:t}function H(){throw new Error("BigInt not supported")}}).call(this,t("buffer").Buffer)},{"base64-js":5,buffer:2,ieee754:6}],5:[function(t,r,e){"use strict";e.byteLength=function(t){var r=h(t),e=r[0],n=r[1];return 3*(e+n)/4-n},e.toByteArray=function(t){var r,e,n=h(t),f=n[0],u=n[1],s=new o(function(t,r,e){return 3*(r+e)/4-e}(0,f,u)),a=0,c=u>0?f-4:f;for(e=0;e<c;e+=4)r=i[t.charCodeAt(e)]<<18|i[t.charCodeAt(e+1)]<<12|i[t.charCodeAt(e+2)]<<6|i[t.charCodeAt(e+3)],s[a++]=r>>16&255,s[a++]=r>>8&255,s[a++]=255&r;2===u&&(r=i[t.charCodeAt(e)]<<2|i[t.charCodeAt(e+1)]>>4,s[a++]=255&r);1===u&&(r=i[t.charCodeAt(e)]<<10|i[t.charCodeAt(e+1)]<<4|i[t.charCodeAt(e+2)]>>2,s[a++]=r>>8&255,s[a++]=255&r);return s},e.fromByteArray=function(t){for(var r,e=t.length,i=e%3,o=[],f=0,u=e-i;f<u;f+=16383)o.push(a(t,f,f+16383>u?u:f+16383));1===i?(r=t[e-1],o.push(n[r>>2]+n[r<<4&63]+"==")):2===i&&(r=(t[e-2]<<8)+t[e-1],o.push(n[r>>10]+n[r>>4&63]+n[r<<2&63]+"="));return o.join("")};for(var n=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=0,s=f.length;u<s;++u)n[u]=f[u],i[f.charCodeAt(u)]=u;function h(t){var r=t.length;if(r%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=t.indexOf("=");return-1===e&&(e=r),[e,e===r?0:4-e%4]}function a(t,r,e){for(var i,o,f=[],u=r;u<e;u+=3)i=(t[u]<<16&16711680)+(t[u+1]<<8&65280)+(255&t[u+2]),f.push(n[(o=i)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return f.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},{}],6:[function(t,r,e){e.read=function(t,r,e,n,i){var o,f,u=8*i-n-1,s=(1<<u)-1,h=s>>1,a=-7,c=e?i-1:0,p=e?-1:1,l=t[r+c];for(c+=p,o=l&(1<<-a)-1,l>>=-a,a+=u;a>0;o=256*o+t[r+c],c+=p,a-=8);for(f=o&(1<<-a)-1,o>>=-a,a+=n;a>0;f=256*f+t[r+c],c+=p,a-=8);if(0===o)o=1-h;else{if(o===s)return f?NaN:1/0*(l?-1:1);f+=Math.pow(2,n),o-=h}return(l?-1:1)*f*Math.pow(2,o-n)},e.write=function(t,r,e,n,i,o){var f,u,s,h=8*o-i-1,a=(1<<h)-1,c=a>>1,p=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,l=n?0:o-1,y=n?1:-1,g=r<0||0===r&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(u=isNaN(r)?1:0,f=a):(f=Math.floor(Math.log(r)/Math.LN2),r*(s=Math.pow(2,-f))<1&&(f--,s*=2),(r+=f+c>=1?p/s:p*Math.pow(2,1-c))*s>=2&&(f++,s/=2),f+c>=a?(u=0,f=a):f+c>=1?(u=(r*s-1)*Math.pow(2,i),f+=c):(u=r*Math.pow(2,c-1)*Math.pow(2,i),f=0));i>=8;t[e+l]=255&u,l+=y,u/=256,i-=8);for(f=f<<i|u,h+=i;h>0;t[e+l]=255&f,l+=y,f/=256,h-=8);t[e+l-y]|=128*g}},{}]},{},[4])(4)});

			const DRIVE_CTRLS=["XT","AT","COMPAQ"],DRIVE_TYPES=[{0:[306,2],1:[375,8],2:[306,6],3:[306,4]},{0:[1024,16,21,2048],1:[306,4],2:[615,4],3:[615,6],4:[940,8],5:[940,6],6:[615,4],7:[462,8],8:[733,5],9:[900,15],10:[820,3],11:[855,5],12:[855,7],13:[306,8],14:[733,7],16:[612,4],17:[977,5],18:[977,7],19:[1024,7],20:[733,5],21:[733,7],22:[733,5],23:[306,4]},{0:[1024,16,21,2048],1:[306,4],2:[615,4],3:[615,6],4:[1023,8],5:[940,6],6:[697,5],7:[462,8],8:[925,5],9:[900,15],10:[980,5],11:[925,7],12:[925,9],13:[612,8],14:[980,4],16:[612,4],17:[980,5],18:[966,6],19:[1023,8],20:[733,5],21:[733,7],22:[768,6],23:[771,6],24:[966,14],25:[966,16],26:[1023,14],27:[966,10],28:[771,3],29:[578,4],30:[615,4,25],31:[615,8,25],32:[966,3,34],33:[966,5,34],34:[966,7,34],35:[966,8,34],36:[966,9,34],37:[966,5,34],38:[1023,9,33],39:[1023,11,33],40:[1023,13,33],41:[1023,15,33],42:[1023,16,34],43:[756,4,26],44:[756,2,26],45:[768,4,26],46:[768,2,26],47:[966,5,25]}];
			const MESSAGE={ALL:0xffffffffffff,NONE:0,DEFAULT:0,ADDR:1,BUS:2,FAULT:4,MEMORY:8,PORTS:16,CHIPS:32,KBD:64,SERIAL:128,MISC:256,CPU:512,INT:1024,MMU:2048,TRAP:4096,VIDEO:8192,MONITOR:16384,SCREEN:32768,FILE:65536,DISK:131072,TIME:262144,TIMER:524288,EVENT:1048576,INPUT:2097152,KEY:4194304,MOUSE:8388608,TOUCH:16777216,CUSTOM:268435456,LOG:68719476736,STATUS:137438953472,NOTICE:274877906944,INFO:274877906944,WARNING:549755813888,ERROR:1099511627776,ALERTS:1924145348608,DEBUG:2199023255552,PROGRESS:4398046511104,SCRIPT:8796093022208,TYPES:0xff000000000,HALT:70368744177664,BUFFER:0x800000000000};MESSAGE.NAMES={all:MESSAGE.ALL,addr:MESSAGE.ADDR,bus:MESSAGE.BUS,fault:MESSAGE.FAULT,memory:MESSAGE.MEMORY,ports:MESSAGE.PORTS,chips:MESSAGE.CHIPS,kbd:MESSAGE.KBD,serial:MESSAGE.SERIAL,misc:MESSAGE.MISC,cpu:MESSAGE.CPU,mmu:MESSAGE.MMU,int:MESSAGE.INT,trap:MESSAGE.TRAP,video:MESSAGE.VIDEO,monitor:MESSAGE.MONITOR,screen:MESSAGE.SCREEN,disk:MESSAGE.DISK,file:MESSAGE.FILE,time:MESSAGE.TIME,timer:MESSAGE.TIMER,event:MESSAGE.EVENT,input:MESSAGE.INPUT,key:MESSAGE.KEY,mouse:MESSAGE.MOUSE,touch:MESSAGE.TOUCH,info:MESSAGE.INFO,warn:MESSAGE.WARNING,error:MESSAGE.ERROR,halt:MESSAGE.HALT,buffer:MESSAGE.BUFFER}

			class Format{static NamesOfDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];static NamesOfMonths=["January","February","March","April","May","June","July","August","September","October","November","December"];static HexLowerCase="0123456789abcdef?";static HexUpperCase="0123456789ABCDEF?";constructor(){this.formatters={};let e="ACDFGHMNSTWYBbdfjcsoXx%";for(let t=0;t<23;t++)this.formatters[e[t]]=null}addFormatType(e,t){return!this.formatters[e]&&(this.formatters[e]=t,!0)}static isDate(e){return!isNaN(e.getTime())}static parseDate(...e){let t;if(void 0===e[0])t=new Date(Date.now());else if("string"==typeof e[0]){let a=e[0];a.indexOf(":")<0?a+=" "+(e[1]||"00:00:00 UTC"):a.match(/^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] [0-9][0-9]:[0-9][0-9]:[0-9][0-9]$/)&&(e[1]||(a+=" UTC")),t=new Date(a)}else t=void 0===e[1]?new Date(e[0]):new Date(Date.UTC(...e));return t}sprintf(e,...t){if(!t||!t.length)return e;let a,s="",r=e.split(/%([-+ 0#]*)([0-9]*|\*)(\.[0-9]+|)([bwhlL]?)([A-Za-z%])/),i=0;for(a=0;a<r.length-6;a+=6){s+=r[a];let e,n=r[a+5];if(void 0===this.formatters[n]){s+="%"+r[a+1]+r[a+2]+r[a+3]+r[a+4]+n;continue}i<t.length?(e=t[i],"%"!=n&&i++):e=t[t.length-1];let o=!1,l=r[a+1],c=l.indexOf("#")>=0,f=l.indexOf("0")>=0,h=r[a+2];"*"==h?(h=e,e=i<t.length?t[i++]:t[t.length-1]):h=+h||0;let u=r[a+3];u=u?+u.substr(1):-1;let d,g=r[a+4],b=null,m=0,p="",D="ACDFGHMNSTWY".indexOf(n)>=0&&"object"!=typeof e?Format.parseDate(e):e;switch(n){case"C":s+=Format.isDate(D)?this.sprintf("%#W, %#F %#D, %#Y".replaceAll("#",c?"#":""),D):void 0;continue;case"D":e=c?D.getUTCDate():D.getDate(),n="d";break;case"A":case"G":case"H":e=c?D.getUTCHours():D.getHours(),"A"==n?(e=e<12?"am":"pm",n="s"):("G"==n&&(e=e?e>12?e-12:e:12),n="d");break;case"F":case"M":e=c?D.getUTCMonth():D.getMonth(),"F"==n?(e=Format.NamesOfMonths[e],n="s"):(e++,n="d");break;case"N":e=c?D.getUTCMinutes():D.getMinutes(),n="d";break;case"S":e=c?D.getUTCSeconds():D.getSeconds(),n="d";break;case"T":s+=Format.isDate(D)?this.sprintf("%#Y-%#02M-%#02D %#02H:%#02N:%#02S".replaceAll("#",c?"#":""),D):void 0;continue;case"W":e=Format.NamesOfDays[c?D.getUTCDay():D.getDay()],n="s";break;case"Y":e=c?D.getUTCFullYear():D.getFullYear(),u>0&&(e%=Math.pow(10,u)),n="d"}switch(n){case"b":s+=e?"true":"false";break;case"d":e=Math.trunc(e),u>=0&&(f=!0,h<u&&(h=u),u=-1);case"f":e=+e,d=e+"",u>=0&&(d=e.toFixed(u)),d.length<h&&(f?(e<0&&(h--,d=d.substr(1)),d=("0".repeat(h)+d).slice(-h),e<0&&(d="-"+d)):d=(" ".repeat(h)+d).slice(-h)),s+=d;break;case"j":s+=JSON.stringify(e,null,h||void 0);break;case"c":e="string"==typeof e?e[0]:String.fromCharCode(e);case"s":if(null!=e)for("string"!=typeof e&&(e=e.toString()),u>=0&&(e=e.substr(0,u));e.length<h;)l.indexOf("-")>=0?e+=" ":e=" "+e;s+=e;break;case"B":m=2,c&&(p="0b");case"o":m||(m=8),!p&&c&&(p="0o");case"X":b=Format.HexUpperCase;case"x":if(d="",m||(m=16),!p&&c&&(p="0x"),b||(b=Format.HexLowerCase),"string"==typeof e&&"-"==e[0]&&(o=!0,e=e.slice(1)),e=Math.trunc(e),o&&(e=-e),e<0&&((0|e)==e?e>>>=0:Math.abs(e)<=Math.pow(2,53)&&(e+=Math.pow(2,53))),u>=0&&(f=!0,h<u&&(h=u),u=-1),f&&!h){if("b"==g)h=2;else if("h"==g||"w"==g)h=4;else if("l"==g)h=8;else{let t=Math.abs(e);h=t<=255?2:t<=65535?4:t<=4294967295?8:9}h+=p.length}h-=p.length;do{let t=16;Number.isNaN(e)||(t=e&m-1,e=Math.trunc(e/m)),f||!d||t||e?d=b[t]+d:(p&&(d=p+d,p=""),h>0&&(d=" "+d))}while(--h>0||e);s+=p+d;break;case"%":s+="%";break;default:if(this.formatters[n]){s+=this.formatters[n](n,l,h,u,e);break}s+="(unimplemented sprintf type: %"+n+")"}}return s+=r[a],s}}

			class Defines{constructor(){this.idDevice=""}static setDebug(e){Defines.DEBUG=e}}const COMMAND="command",COMPILED=!1,DEBUG=!0,FACTORY="PCjsMachine",MAXDEBUG=!1,VERSION="3.00",REPOSITORY="pcjs.org",COPYRIGHT="Copyright  2012-2025 Jeff Parsons <Jeff@pcjs.org>",LITTLE_ENDIAN=function(){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,256,!0),256===new Uint16Array(e)[0]}(),RS232={RTS:{PIN:4,MASK:16},CTS:{PIN:5,MASK:32},DSR:{PIN:6,MASK:64},CD:{PIN:8,MASK:256},DTR:{PIN:20,MASK:1048576},RI:{PIN:22,MASK:4194304}};Defines.COMMAND=COMMAND,Defines.COMPILED=false,Defines.COPYRIGHT=COPYRIGHT,Defines.DEBUG=true,Defines.FACTORY=FACTORY,Defines.LITTLE_ENDIAN=LITTLE_ENDIAN,Defines.MAXDEBUG=false,Defines.REPOSITORY="pcjs.org",Defines.RS232=RS232,Defines.VERSION="3.00";let globals={browser:"undefined"!=typeof window,node:"undefined"!=typeof window?{}:global,process:"undefined"!=typeof process?process:{},window:"undefined"!=typeof window?window:global,document:"undefined"!=typeof document?document:{},pcjs:{machines:{},components:[],commands:{},files:null}};globals.window.PCjs?globals.pcjs=globals.window.PCjs:globals.window.PCjs=globals.pcjs,Defines.globals=globals,Defines.process=globals.process,Defines.Machines=globals.pcjs.machines,Defines.Components=globals.pcjs.components,Defines.CLASSES={},Defines.CLASSES.Defines=Defines;

			class StdLib extends Defines{static TWO_POW32=Math.pow(2,32);isInt(e,t){return t&&10!=t?16==t?null!==e.match(/^-?[0-9a-f]+$/i):8==t?null!==e.match(/^-?[0-7]+$/):2==t&&null!==e.match(/^-?[01]+$/):null!==e.match(/^[+-]?[0-9]+$/)}parseInt(e,t){let a;if(e){let r,s,l;t||(t=10);let i,o=e.indexOf(",")>0;o&&(e=e.replace(/,/g,"")),r=s=e.charAt(0),"#"==s?(t=8,s=""):"$"==s&&(t=16,s=""),r!=s?e=e.substr(1):(r=s=e.substr(0,2),"0b"==s&&o||"^B"==s?(t=2,s=""):"0o"==s||"^O"==s?(t=8,s=""):"^D"==s?(t=10,s=""):"0x"==s&&(t=16,s=""),r!=s&&(e=e.substr(2))),r=l=e.slice(-1),"Y"==l||"y"==l?(t=2,l=""):"."==l?(t=10,l=""):"H"==l||"h"==l?(t=16,l=""):"K"==l?l="000":"M"==l?l="000000":"G"==l&&(l="000000000"),r!=l&&(e=e.slice(0,-1)+l);let u=0;if(t<=10){let t=e.match(/(-?[0-9]+)B([0-9]*)$/);t&&(e=t[1],u=35-(255&(t[2]||35)))}this.isInt(e,t)&&!isNaN(i=parseInt(e,t))&&(u&&(i<0&&(i+=Math.pow(2,36)),u>0?i*=Math.pow(2,u):i=Math.trunc(i/Math.pow(2,-u))),a=i)}return a}parseResource(sURL,sData){let i,resource={aBytes:null,aSymbols:null,addrLoad:null,addrExec:null};if("["==sData.charAt(0)||"{"==sData.charAt(0))try{let a,ib,data;if("<"==sData.substr(0,1))throw new Error(sData);data=sData.indexOf("0x")<0&&sData.indexOf("0o")<0&&'["'!=sData.substr(0,2)?JSON.parse(sData.replace(/([a-z]+):/gm,'"$1":').replace(/\/\/[^\n]*/gm,"")):eval("("+sData+")"),resource.addrLoad=data.load,resource.addrExec=data.exec;let width=data.width,values=data.values;if(width&&values&&(8==width?data.bytes=values:16==width?data.words=values:32==width?data.longs=values:data.data=values),a=data.bytes)resource.aBytes=a;else if(a=data.words)for(resource.aBytes=new Array(2*a.length),i=0,ib=0;i<a.length;i++)resource.aBytes[ib++]=255&a[i],resource.aBytes[ib++]=a[i]>>8&255,this.assert(!(-65536&a[i]));else if(a=data.longs)for(resource.aBytes=new Array(4*a.length),i=0,ib=0;i<a.length;i++)resource.aBytes[ib++]=255&a[i],resource.aBytes[ib++]=a[i]>>8&255,resource.aBytes[ib++]=a[i]>>16&255,resource.aBytes[ib++]=a[i]>>24&255;else(a=data.data)?resource.aData=a:resource.aBytes=data;resource.aBytes&&(resource.aBytes.length?1==resource.aBytes.length&&(this.error(resource.aBytes[0]),resource=null):(this.error("empty resource: %s",sURL),resource=null)),resource.aSymbols=data.symbols}catch(e){this.error("resource (%s) exception: %s",sURL,e.message),resource=null}else{let e=[],t=sData.replace(/\n/gm," ").replace(/ +$/,""),a=t.split(" ");for(i=0;i<a.length;i++){let t=parseInt(a[i],16);if(isNaN(t)){this.error("resource (%s) contains invalid hex byte (%s)",sURL,a[i]);break}e.push(255&t)}i==a.length&&(resource.aBytes=e)}return resource}parseSwitches(e,t){let a;if(e){a=0;let r=1;for(let s=0;s<e.length;s++){let l=e.charAt(s);a|=-1==t?"0"!=l&&"1"!=l?0:r:"0"==l?r:0,r<<=1}}else a=t;return a}toBase(e,t,a=0,r=void 0,s=0){let l="",i="",o=-1;if(t||(t=this.nDefaultRadix||10),a&&(o=Math.ceil(a/Math.log2(t))),null==r)switch(t){case 8:r="0o";break;case 16:r="0x";break;case 10:i=".";default:r=""}isNaN(e)||"number"!=typeof e?(e=void 0,r=i=""):(e<0&&e>-1&&(e=-1),a&&(e<0&&(e+=Math.pow(2,a)),e>=Math.pow(2,a)&&(o=Math.ceil(Math.log(e)/Math.log(t)))));let u=s||-1;for(;o--;){if(u||(l=","+l,u=s),null==e){if(l="?"+l,o<0)break}else{let a=e%t;if(e=Math.trunc(e/t),a+=a>=0&&a<=9?48:55,l=String.fromCharCode(a)+l,!e&&o<0)break}u--}return r+l+i}clearBits(e,t){let a=StdLib.TWO_POW32;return(e&~t)+((e/a|0)&~(t/a|0))*a}setBits(e,t){let a=StdLib.TWO_POW32;return(e|t)+(e/a|0|(t/a|0))*a}testBits(e,t){let a=StdLib.TWO_POW32,r=t/a|0;return(e&t)==(0|t)&&((e/a|0)&r)==r}compress(e){let t=0,a=0,r=[];for(;t<e.length;){let s=e[t];this.assert(void 0!==s);let l=t+1;for(;l<e.length&&e[l]===s;)l++;r[a++]=l-t,r[a++]=s,t=l}return r.length>=e.length?e:r}decompress(e,t=0){if(e.length==t)return e;let a=0,r=t?new Array(t):[],s=0;for(;s<e.length-1;){let t=e[s++],l=e[s++];for(;t--;)r[a++]=l}return this.assert(!t||r.length==t),r}}StdLib.CLASSES.StdLib=StdLib;

			class StdIO extends StdLib{constructor(){super(),this.format=new Format,this.addFormatType=this.format.addFormatType.bind(this.format),this.sprintf=this.format.sprintf.bind(this.format),this.isDate=Format.isDate,this.parseDate=Format.parseDate}flush(){let t=StdIO.PrintBuffer;StdIO.PrintBuffer="",this.print(t)}getBaseName(t,e,i){let r=t,s=t.lastIndexOf("/");return s>=0&&(r=t.substr(s+1)),i||(s=r.indexOf("&"),s>0&&(r=r.substr(0,s))),e&&(s=r.lastIndexOf("."),s>0&&(r=r.substring(0,s))),r}print(t,e){let i=t.length,r=t.lastIndexOf("\n");if(e){if(r>=0){let e=Date.now();StdIO.PrintTime||(StdIO.PrintTime=e),i=(t=((e-StdIO.PrintTime)/1e3).toFixed(3)+": "+t).length}}else"node"==this.idDevice?(StdIO.process.stdout.write(t),t=""):(r>=0&&(console.log(StdIO.PrintBuffer+t.slice(0,r)),StdIO.PrintBuffer="",t=t.slice(r+1)),StdIO.PrintTime=null);return StdIO.PrintBuffer+=t,i}printf(t,...e){return this.print(this.sprintf(t,...e))}toHex(t){return this.sprintf("%#x",t)}}StdIO.PrintBuffer="",StdIO.PrintTime=null,StdIO.CLASSES.StdIO=StdIO;

			class WebIO extends StdIO{constructor(e){super(),this.bindings={},this.messages=0,this.machine=this,e&&(this.machine.messages=0,this.machine.aCommands=[],this.machine.iCommand=0,this.machine.handlers={},this.machine.isFullScreen=!1)}addBinding(e,t,a){let n=this;switch(this.bindings[e]=t,e){case WebIO.BINDING.CLEAR:t.onclick=()=>this.clear();break;case WebIO.BINDING.PRINT:this.disableAuto(t),t.addEventListener("keydown",(function(e){n.onCommandEvent(e,!0,a)})),t.addEventListener("keypress",(function(e){n.onCommandEvent(e,void 0,a)}))}}addBindings(e={}){if("undefined"==typeof document)return;this.config.bindings||(this.config.bindings=e);let t=Array.isArray(e);t?e.indexOf("container")<0&&e.push("container"):e.container||(e.container=this.idDevice);for(let a in e){let n=e[a];if(t)a=n;else if(n.match(/^[0-9]+$/)){let e=+n;for(this.bindings[a]=[];;){n=a+e++;let t=document.getElementById(n);if(!t)break;this.bindings[a].push(t)}continue}let i=document.getElementById(n);i?this.addBinding(a,i):WebIO.MAXDEBUG&&!t&&n!=this.idDevice&&this.printf("unable to find element '%s' for device '%s'\n",n,this.idDevice)}}addBindingOptions(e,t,a,n){if(a&&(e.options.length=0),t)for(let a in t){let i=document.createElement("option");i.text=a,i.value="string"==typeof t[a]?t[a]:a,e.appendChild(i),i.value==n&&(e.selectedIndex=e.options.length-1)}}addHandler(e,t){this.machine.handlers[e]||(this.machine.handlers[e]=[]),this.machine.handlers[e].push(t)}alert(e,t){let a=!1;"boolean"==typeof e&&(a=e,e=t.shift());let n=this.sprintf(e,...t);n&&(this.printf("%s\n",n),a||alert(n))}assert(e,t,...a){if(WebIO.DEBUG&&!e)throw new Error(t?this.sprintf(t,...a):"assertion failure")}clear(){let e=this.findBinding(WebIO.BINDING.PRINT,!0);e&&(e.value="")}disableAuto(e){e.setAttribute("autocapitalize","off"),e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("spellcheck","false"),e.value=""}error(e,t){this.alert("%s",this.sprintf(e,...t))}findBinding(e,t){return this.bindings[e]}findHandlers(e){return this.machine.handlers[e]}findProperty(e,t,a){if(e)for(;;){for(let n=0;n<WebIO.BrowserPrefixes.length;n++){let i=WebIO.BrowserPrefixes[n];if(a){if(i+=a,t+i in e)return i}else if(i?i+=t[0].toUpperCase():i=t[0],i+=t.substr(1),i in e)return i}if(t.indexOf("screen")<0)break;t=t.replace("screen","Screen")}return null}getBindingID(e){return this.config.bindings&&this.config.bindings[e]}getBindingText(e){let t,a=this.bindings[e];return a&&(t=a.textContent),t}getBounded(e,t,a){return this.assert(t<=a),(e=+e||0)<t&&(e=t),e>a&&(e=a),e}getDefault(e,t,a){let n=this.config[e];if(void 0===n)n=t;else{a&&void 0!==a[n]&&(n=a[n]);let e=typeof t;typeof n!=e&&(this.assert(!1),"boolean"==e?n=!!n:"number"==typeof t&&(n=+n))}return n}getDefaultBoolean(e,t){return this.getDefault(e,t)}getDefaultNumber(e,t,a){return this.getDefault(e,t,a)}getDefaultString(e,t){return this.getDefault(e,t)}static getHost(){return window?window.location.host:"localhost"}static getHostName(){return window?window.location.hostname:WebIO.getHost()}static getHostOrigin(){return window?window.location.origin:WebIO.getHost()}static getHostPath(){return window?window.location.pathname:null}static getHostProtocol(){return window?window.location.protocol:"file:"}static getHostURL(){return window?window.location.href:null}getMedia(e,t){let a=this;return"string"==typeof e?(this.getResource(e,(function(e,n,i,s){let r,l,o=!1;if(s)o=s<0,r=e;else{if(4!=i)return;try{l=JSON.parse(n)}catch(e){s=1,r=e.message||"unknown error"}}r&&a.alert(o,"Unable to load %s media (error %d: %s)",a.idDevice,s,r),t(l)})),!1):(t(e),!0)}getResource(e,t){let a=0,n=null,i=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP");i.onreadystatechange=function(){4===i.readyState?(n=i.responseText,200==i.status||!i.status&&n.length&&"file:"==WebIO.getHostProtocol()||(a=i.status||-1),t(e,n,i.readyState,a)):t(e,n,i.readyState,a)},i.open("GET",e,!0),i.send()}static getURLParms(e){let t=WebIO.URLParms;if(!t){if(t={},window){let a;e||(e=window.location.search.slice(1));let n=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(n," ")).trim()};for(;a=i.exec(e);)t[s(a[1])]=s(a[2])}WebIO.URLParms=t}return t}hasLocalStorage(){if(void 0===WebIO.LocalStorage.Available){let e=!1;if(window)try{window.localStorage.setItem(WebIO.LocalStorage.Test,WebIO.LocalStorage.Test),e=window.localStorage.getItem(WebIO.LocalStorage.Test)==WebIO.LocalStorage.Test,window.localStorage.removeItem(WebIO.LocalStorage.Test)}catch(t){this.printf("%s\n",t.message),e=!1}WebIO.LocalStorage.Available=e}return!!WebIO.LocalStorage.Available}isMessageOn(e=0){return e>1&&e%2&&e--,!(-1!=(1|(e=e||this.messages))&&!this.testBits(this.machine.messages,e))}isUserAgent(e){if(window){let t=window.navigator.userAgent;return"iOS"==e&&(!!t.match(/(iPod|iPhone|iPad)/)||"MacIntel"===window.navigator.platform&&window.navigator.maxTouchPoints>1)||"MSIE"==e&&!!t.match(/(MSIE|Trident)/)||t.indexOf(e)>=0}return!1}loadLocalStorage(){let e=null;if(this.hasLocalStorage()){let t;if(window)try{t=window.localStorage.getItem(this.idMachine),t&&(e=JSON.parse(t))}catch(e){this.printf("%s\n",e.message)}}return e}onCommandEvent(e,t,a){let n=(e=e||window.event).which||e.keyCode;if(a&&a(e,t))e.preventDefault();else if(n){let a=this.machine,i=e.target;if(t){let t,s=!1,r=i.value,l=r.lastIndexOf("\n");n==WebIO.KEYCODE.BS&&i.selectionStart<=l+1&&(s=!0),n==WebIO.KEYCODE.UP?(s=!0,a.iCommand>0&&(t=a.aCommands[--a.iCommand])):n==WebIO.KEYCODE.DOWN&&(s=!0,a.iCommand<a.aCommands.length&&(t=a.aCommands[++a.iCommand]||"")),s&&e.preventDefault(),null!=t&&(i.value=r.substr(0,l+1)+t)}else{let t=n,s=String.fromCharCode(t),r=i.value,l=r.lastIndexOf("\n");if(i.selectionStart<=l&&i.setSelectionRange(r.length,r.length),e.stopPropagation(),"@"==s&&a.iCommand>0&&l+1==r.length&&(i.value+=a.aCommands[--a.iCommand],s="\r"),"\r"==s){e.preventDefault(),r=i.value+="\n",i.blur(),i.focus();let t=r.lastIndexOf("\n",r.length-2),a=r.slice(t+1,-1)||"",n=this.parseCommands(a);n&&this.printf("%s\n",n.replace(/\n$/,""))}}}}onPageEvent(e,t){window&&window.addEventListener(e,t)}parseBoolean(e){return"true"==e||"on"==e||"false"!=e&&"off"!=e&&void 0}parseCommand(e){let t;if(null!=e){let a=this.machine;try{(e=e.trim())&&(a.iCommand<a.aCommands.length&&e==a.aCommands[a.iCommand]?a.iCommand++:(a.aCommands.push(e),a.iCommand=a.aCommands.length));let n,i,s,r,l=e.split(" "),o=l[0],f=this.findHandlers(WebIO.HANDLER.COMMAND);switch(o[0]){case"m":if("?"==o[1]){t="",WebIO.MESSAGE_COMMANDS.forEach((e=>{t+=e+"\n"})),t&&(t="message commands:\n"+t);break}t="",r=1,s=void 0,o=l[l.length-1].toLowerCase(),i=this.parseBoolean(o),null!=i&&l.pop(),l.length<=1&&(null!=i&&(s=i,i=void 0),l[r]="all"),"all"==l[r]&&(l=Object.keys(MESSAGE.NAMES));for(let e=r;e<l.length;e++){if(o=l[e],n=MESSAGE.NAMES[o],!n){t+="unrecognized message: "+o+"\n";break}null!=i&&this.setMessages(n,i),null!=s&&s!=this.isMessageOn(n)||(t+=this.sprintf("%8s: %b\n",o,this.isMessageOn(n)))}this.isMessageOn(MESSAGE.BUFFER)&&(t+="all messages will be buffered until buffer is turned off\n"),t||(t="no messages\n");break;case"?":t="",WebIO.COMMANDS.forEach((e=>{t+=e+"\n"})),t&&(t="default commands:\n"+t);default:if(l.unshift(e),f)for(let e=0;e<f.length;e++){let a=f[e](l);if(null!=a){t?t+=a:t=a;break}}}}catch(e){t="error: "+e.message+"\n"}}return t}parseCommands(e="?"){let t;if(e){t="";let a=e.split(/(?:\n|;\s*)/);for(let e=0;e<a.length;e++)t+=this.parseCommand(a[e])}return t}print(e,t){if(null==t&&(t=this.isMessageOn(MESSAGE.BUFFER)),!t){let t=this.findBinding(WebIO.BINDING.PRINT,!0);if(t){let a=t.selectionStart,n=e.split(/([\n\r\b])/);for(let e=0;e<n.length;e++){let i=n[e];if(i)if("\b"==i||"\r"==i)for(;a>0;){if("\n"==t.value.slice(a-1,a))break;if(a--,"\b"==i)break}else if("\n"==i){let e="";for(;a<t.value.length&&(e=t.value[a],a++,"\n"!=e););"\n"!=e&&(t.value+="\r\n",a=t.value.length)}else t.value=t.value.slice(0,a)+i+t.value.slice(a+i.length),a+=i.length}if(t.focus(),t.setSelectionRange(a,a),!WebIO.DEBUG&&t.value.length>=8192){let e=t.value.length-8192+4096;t.value=t.value.slice(e)}return t.scrollTop=t.scrollHeight,e.length}}return super.print(e,t)}printf(e,...t){let a=0;return"number"==typeof e&&(a=e,e=t.shift()),this.isMessageOn(a)?(this.testBits(a,MESSAGE.ERROR)&&(e="error: "+e),this.testBits(a,MESSAGE.WARNING)&&(e="warning: "+e),super.printf(e,...t)):0}saveLocalStorage(e){if(this.hasLocalStorage()){let t=JSON.stringify(e);try{return window.localStorage.setItem(this.idMachine,t),!0}catch(e){this.printf("%s\n",e.message)}}return!1}setBindingText(e,t){let a=this.bindings[e];return!!a&&(a.textContent!=t&&(a.textContent=t),!0)}getMessages(){return this.machine.messages}setMessages(e,t){let a=!1,n=this.machine.messages;return t?this.machine.messages=this.setBits(this.machine.messages,e):(a=this.testBits(this.machine.messages,MESSAGE.BUFFER)&&this.testBits(e,MESSAGE.BUFFER),this.machine.messages=this.clearBits(this.machine.messages,e)),a&&this.flush(),n}}WebIO.BINDING={CLEAR:"clear",PRINT:"print"},WebIO.COMMANDS=[" \t\trecall commands","@\t\trepeat last command","m?\t\tmessage commands"],WebIO.MESSAGE_COMMANDS=["m\t\tdisplay all messages","m on\t\tdisplay all active messages","m off\t\tdisplay all inactive messages","m all [on|off]\tturn all messages on or off","m ... [on|off]\tturn selected messages on or off"],WebIO.HANDLER={COMMAND:"command"},WebIO.CHARCODE={CR:13,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,a:97,b:98,c:99,d:100,e:101,f:102,g:103,h:104,i:105,j:106,k:107,l:108,m:109,n:110,o:111,p:112,q:113,r:114,s:115,t:116,u:117,v:118,w:119,x:120,y:121,z:122},WebIO.KEYCODE={BS:8,TAB:9,LF:10,CR:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PGUP:33,PGDN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,FF_QUOTE:39,DOWN:40,FF_COMMA:44,PRTSC:44,INS:45,DEL:46,FF_PERIOD:46,FF_SLASH:47,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,FF_SEMI:59,FF_EQUALS:61,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,CMD:91,FF_LBRACK:91,FF_BSLASH:92,RCMD:93,FF_RBRACK:93,NUM_0:96,NUM_INS:96,FF_BQUOTE:96,NUM_1:97,NUM_END:97,NUM_2:98,NUM_DOWN:98,NUM_3:99,NUM_PGDN:99,NUM_4:100,NUM_LEFT:100,NUM_5:101,NUM_CENTER:101,NUM_6:102,NUM_RIGHT:102,NUM_7:103,NUM_HOME:103,NUM_8:104,NUM_UP:104,NUM_9:105,NUM_PGUP:105,NUM_MUL:106,NUM_ADD:107,NUM_SUB:109,NUM_DEL:110,NUM_DIV:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,FF_DASH:173,SEMI:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,SLASH:191,BQUOTE:192,LBRACK:219,BSLASH:220,RBRACK:221,QUOTE:222,FF_CMD:224,LOCK:901,VIRTUAL:1e3},WebIO.FF_KEYCODE={[WebIO.KEYCODE.FF_SEMI]:WebIO.KEYCODE.SEMI,[WebIO.KEYCODE.FF_EQUALS]:WebIO.KEYCODE.EQUALS,[WebIO.KEYCODE.FF_DASH]:WebIO.KEYCODE.DASH,[WebIO.KEYCODE.FF_CMD]:WebIO.KEYCODE.CMD},WebIO.LOCATION={LEFT:1,RIGHT:2,NUMPAD:3},WebIO.KEYNAME={[WebIO.KEYCODE.BS]:"\b",[WebIO.KEYCODE.TAB]:"\t",[WebIO.KEYCODE.LF]:"\n",[WebIO.KEYCODE.CR]:"\r",[WebIO.KEYCODE.SPACE]:" ",[WebIO.KEYCODE.ZERO]:"0",[WebIO.KEYCODE.ONE]:"1",[WebIO.KEYCODE.TWO]:"2",[WebIO.KEYCODE.THREE]:"3",[WebIO.KEYCODE.FOUR]:"4",[WebIO.KEYCODE.FIVE]:"5",[WebIO.KEYCODE.SIX]:"6",[WebIO.KEYCODE.SEVEN]:"7",[WebIO.KEYCODE.EIGHT]:"8",[WebIO.KEYCODE.NINE]:"9",[WebIO.KEYCODE.A]:"A",[WebIO.KEYCODE.B]:"B",[WebIO.KEYCODE.C]:"C",[WebIO.KEYCODE.D]:"D",[WebIO.KEYCODE.E]:"E",[WebIO.KEYCODE.F]:"F",[WebIO.KEYCODE.G]:"G",[WebIO.KEYCODE.H]:"H",[WebIO.KEYCODE.I]:"I",[WebIO.KEYCODE.J]:"J",[WebIO.KEYCODE.K]:"K",[WebIO.KEYCODE.L]:"L",[WebIO.KEYCODE.M]:"M",[WebIO.KEYCODE.N]:"N",[WebIO.KEYCODE.O]:"O",[WebIO.KEYCODE.P]:"P",[WebIO.KEYCODE.Q]:"Q",[WebIO.KEYCODE.R]:"R",[WebIO.KEYCODE.S]:"S",[WebIO.KEYCODE.T]:"T",[WebIO.KEYCODE.U]:"U",[WebIO.KEYCODE.V]:"V",[WebIO.KEYCODE.W]:"W",[WebIO.KEYCODE.X]:"X",[WebIO.KEYCODE.Y]:"Y",[WebIO.KEYCODE.Z]:"Z",[WebIO.KEYCODE.LEFT]:"Left",[WebIO.KEYCODE.RIGHT]:"Right"},WebIO.BrowserPrefixes=["","moz","ms","webkit"],WebIO.COLORS={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},WebIO.LocalStorage={Available:void 0,Test:"PCjs.localStorage"},WebIO.CLASSES.WebIO=WebIO;

			class Device extends WebIO{constructor(i="default",e=i,s={},t=[]){super(i==e),this.addDevice(i,e),this.checkConfig(s,t),this.registers={},this.aReadyCallbacks=[]}addDevice(i,e){this.idMachine=i,this.idDevice=e,Device.Machines[this.idMachine]||(Device.Machines[this.idMachine]={}),Device.Machines[this.idMachine][this.idDevice]&&this.printf("warning: machine configuration contains multiple '%s' devices\n",this.idDevice),Device.Machines[this.idMachine][this.idDevice]=this,this.id=this.idMachine==this.idDevice?this.idMachine:this.idMachine+"."+this.idDevice,Device.Components.push(this),this.machine=this.findDevice(this.idMachine),this.ready=!0}addDumper(i,e,s,t){}addSymbols(i){}checkConfig(i,e){if((e=i.overrides||e).length){let s=WebIO.getURLParms();for(let t in s)if(e.indexOf(t)>=0){let e=s[t],n=this.parseInt(e,10);null==n&&("true"==e?n=!0:"false"==e?n=!1:(n=e,e='"'+e+'"')),i[t]=n,this.printf("overriding %s property '%s' with %s\n",this.idDevice,t,e)}}this.config=i,this.addBindings(i.bindings),this.checkVersion(i)}checkVersion(i={}){if(this.version=+Device.VERSION,this.version){let e,s="";if(this.idMachine!=this.idDevice){e=this.findDevice(this.idMachine).version,e&&e!=this.version&&(s="Machine")}if(s||(e=i.version,e&&e>this.version&&(s="Config")),s){let t=this.sprintf("%s Device version (%3.2f) incompatible with %s version (%3.2f)",i.class,this.version,s,e);this.error("%s\n\nClearing your browser's cache may resolve the issue.",t)}}}defineRegister(i,e,s){this.registers[i]={get:e.bind(this),set:s?s.bind(this):null}}defineRegisterAlias(i,e){this.assert(this.registers[i]),this.registers[i]&&(this.registers[e]=this.registers[i])}enumDevices(i){let e;try{let s=Device.Machines[this.idMachine];if(s)for(e in s){let t=s[e];if(t.idDevice!=t.idMachine&&!i(t))return!1}return!0}catch(i){this.printf("error while enumerating device '%s': %s\n",e,i.message)}return!1}findBinding(i,e=!1){let s;if(i&&(s=super.findBinding(i,e),void 0===s&&e)){let e=Device.Machines[this.idMachine];for(let t in e)if(s=e[t].bindings[i],s)break;s||(s=null),this.bindings[i]=s}return s}findDevice(i,e=!0){let s=i,t=this.idMachine,n=t.indexOf(".");n>0&&(t=t.substr(0,n),i=i.substr(n+1));let h=Device.Machines[t],r=h&&h[i]||null;if(!r){for(n=0;n<Device.Components.length;n++)if(Device.Components[n].id===s){r=Device.Components[n];break}if(!r&&e)throw new Error(this.sprintf('no "%s" device',s))}return r}findDeviceByClass(i,e=!0){let s=null,t=Device.Machines[this.idMachine];if(t)for(let e in t)if(t[e].config.class==i){if(s){s=null;break}s=t[e]}if(!s&&e)throw new Error(this.sprintf("no %s device",i));return s}getMachineConfig(i){let e=this.findDevice(this.idMachine);return e&&e.config&&e.config[i]||this.config[i]}getRegister(i){let e=this.registers[i];return e&&e.get()}isReady(){return this==this.machine&&this.ready?this.enumDevices((i=>i.isReady())):this.ready}setReady(i=this.ready){if(this.ready=i,this.isReady()){let i;for(;i=this.aReadyCallbacks.pop();)i();this!=this.machine&&this.machine.setReady()}}whenReady(i){return this.isReady()?(i(),!0):(this.aReadyCallbacks.push(i),!1)}notifyMessage(i){}printf(i,...e){return"number"==typeof i&&this.isMessageOn(i)&&(void 0===this.dbg&&(this.dbg=this.findDeviceByClass("Debugger",!1)),this.dbg&&this.dbg.notifyMessage(i),this.machine.messages&MESSAGE.ADDR&&(void 0===this.cpu&&(this.cpu=this.findDeviceByClass("CPU")),this.cpu))?(i=e.shift(),super.printf("%#06x: %s.%s\n",this.cpu.regPCLast,this.idDevice,this.sprintf(i,...e).trim())):super.printf(i,...e)}removeDevice(i){let e=Device.Machines[this.idMachine];e&&delete e[i]}setRegister(i,e){let s=this.registers[i];return!(!s||!s.set)&&(s.set(e),!0)}}Device.CLASSES.Device=Device;

			class FileInfo{static ENTRY={OFFSET:"o",SYMBOL:"s"};static OE={SIG:23117,oeSignature:[0,2],oeLastBytes:[2,2],oeBlocks:[4,2],oeRelocEntries:[6,2],oeHeaderParas:[8,2],oeExtraParas:[10,2],oeMaxParas:[12,2],oeSSRel:[14,2],oeSPInit:[16,2],oeChecksum:[18,2],oeIPInit:[20,2],oeCSRel:[22,2],oeRelocOffset:[24,2],oeOverlay:[26,2],oeDOS40Bits:[32,2],oeUnusedBits:[34,2],oeNEHeader:[60,4],NE_SIG:64};static NE={SIG:17742,neSignature:[0,2],neLinkerVer:[2,2],neETOffset:[4,2],neETSize:[6,2],neChecksum:[8,4],neFlags:[12,2],neDataSeg:[14,2],neHeapSize:[16,2],neStackSize:[18,2],neCSIP:[20,4],neSSSP:[24,4],neSTEntries:[28,2],neMRTEntries:[30,2],neNRNTSize:[32,2],neSTOffset:[34,2],neRTOffset:[36,2],neRNTOffset:[38,2],neMRTOffset:[40,2],neINTOffset:[42,2],neNRNTOffset:[44,4],neETMovable:[48,2],neSegOffShift:[50,2],neRTEntries:[52,2],neEXEType:[54,1]};constructor(e,t,i,s,l,n,a,o=-1,d=null){this.disk=e,this.iVolume=t,this.path=i,this.name=s,this.attr=l,this.date=n,this.size=a,this.cluster=o,this.aLBA=d,this.device=e.device,Device.MAXDEBUG&&o>=0&&this.device.printf(MESSAGE.FILE,'"%d:%s" size=%d attr=%#0bx date=%#T cluster=%d sectors=%j\n',t,i,a,l,n,o,d)}loadValue(e,t){let i;t=t||2;let s=e>>9,l=511&e,n=this.disk.getSector(this.aLBA[s]);if(n){if(l+t<=n[DiskInfo.SECTOR.LENGTH])return this.disk.getSectorData(n,l,t);i=0;let s=0;for(;t--;)i|=this.loadValue(e++,1)<<s,s+=8}return i}loadString(e,t){let i="";for(t||(t=-1);t--;){let t=this.loadValue(e++,1);if(!t)break;i+=String.fromCharCode(t)}return i}loadField(e,t){return this.loadValue(e[0]+(t||0),e[1])}loadSegmentTable(e,t,i,s=!0){let l=1;for(this.segments={},this.ordinals=s?{}:null,Device.DEBUG&&this.device.printf(MESSAGE.FILE,"loadSegmentTable(%s,%#0lx,%#0wx)\n",this.path,e,t);t--;){let t=this.loadValue(e)<<i;if(t){let i=this.loadValue(e+2)||65536;Device.DEBUG&&this.device.printf(MESSAGE.FILE,"segment %d: offStart=%#0lx offEnd=%#0lx\n"+l,t,t+i),this.segments[l++]={offStart:t,offEnd:t+i-1}}e+=8}this.segments[254]={offStart:0,offEnd:0}}loadEntryTable(e,t){let i=1;for(Device.DEBUG&&this.device.printf("loadEntryTable(%#0lx,%#0lx)\n",e,t);e<t;){let t=this.loadValue(e),s=255&t;if(!s)break;let l,n=t>>8;if(Device.DEBUG&&this.device.printf(MESSAGE.FILE,"bundle for segment %d: %d entries @%#x\n",n,s,e),e+=2,n)for(;s--;){let t,s=e;this.loadValue(e,1);n<=254?(l=n,t=this.loadValue(e+1),e+=3):(l=this.loadValue(e+3,1),t=this.loadValue(e+4),e+=6),this.segments[l]?(this.segments[l].ordinals||(this.segments[l].ordinals={}),this.segments[l].ordinals[i]={[FileInfo.ENTRY.OFFSET]:t},Device.DEBUG&&this.device.printf(MESSAGE.FILE,"ordinal %d: segment=%d offset=%#0lx @%x\n",i,l,t,s)):Device.DEBUG&&this.device.printf(MESSAGE.FILE,"invalid segment: %d\n",l),this.ordinals&&(this.ordinals[i]=[l,t]),i++}else i+=s}}loadNameTable(e,t){let i=0;for(Device.DEBUG&&this.device.printf(MESSAGE.FILE,"loadNameTable(%#0lx,%#0lx)\n",e,t||0);!t||e<t;){let s=e,l=this.loadValue(e,1);if(!l)break;let n=this.loadString(e+1,l);if(!n)break;if(e+=1+l,i){let t,i=this.loadValue(e),l=this.ordinals&&this.ordinals[i];if(l){let e=l[0];if(this.segments[e]){let l=this.segments[e].ordinals;this.device.assert(l&&l[i]),l&&(t=l[i],t&&(t[FileInfo.ENTRY.SYMBOL]=n,Device.DEBUG&&this.device.printf(MESSAGE.FILE,"segment %d offset %#0wx ordinal %d: %s @ %x\n",e,t[FileInfo.ENTRY.OFFSET],i,n,s)))}else Device.DEBUG&&this.device.printf("%s: cannot find segment %d (offset %#0wx) for symbol %s with ordinal %d @%x\n",this.path,e,l[1],n,i,s)}Device.DEBUG&&!t&&this.device.printf(MESSAGE.FILE,"s: cannot find ordinal %d for symbol %s @%x\n",this.path,i,n,s)}else t?this.modDesc=n:this.module=n;e+=2,i++}}loadSymbols(){if(!this.name.endsWith(".EXE")&&!this.name.endsWith(".DLL")&&!this.name.endsWith(".DRV"))return;if(this.loadField(FileInfo.OE.oeSignature)!=FileInfo.OE.SIG)return;if(this.loadField(FileInfo.OE.oeRelocOffset)!=FileInfo.OE.NE_SIG)return;let e=this.loadField(FileInfo.OE.oeNEHeader);if(this.loadField(FileInfo.NE.neSignature,e)!=FileInfo.NE.SIG)return;let t=this.loadField(FileInfo.NE.neSTEntries,e),i=this.loadField(FileInfo.NE.neSTOffset,e),s=this.loadField(FileInfo.NE.neSegOffShift,e);i&&t&&this.loadSegmentTable(i+e,t,s||0),i=this.loadField(FileInfo.NE.neETOffset,e);let l=this.loadField(FileInfo.NE.neETSize,e);i&&l&&this.loadEntryTable(i+=e,i+l),i=this.loadField(FileInfo.NE.neRNTOffset,e),i&&this.loadNameTable(i+e),i=this.loadField(FileInfo.NE.neNRNTOffset,e),l=this.loadField(FileInfo.NE.neNRNTSize,e),i&&l&&this.loadNameTable(i,i+l)}getSymbol(e,t){let i=null;if(this.segments)for(let s in this.segments){let l=this.segments[s];if(e>=l.offStart&&e<=l.offEnd){let s,n=e-=l.offStart;if(l.ordinals){for(let a in l.ordinals){let o=l.ordinals[a],d=e-o[0];if(!d){i=this.module+"!"+o[1];break}t&&d>0&&d<n&&(s=o,n=d)}!i&&s&&(i=this.module+"!"+s[1]+"+"+this.device.sprintf("%#0x",n))}break}}return i||this.name+"+"+this.device.sprintf("%#0x",e)}}

			class CharSet{static fromCP437(t,e=!1){let r="";"number"==typeof t&&(t=[t]);for(let C=0;C<t.length;C++){let a;if(a=Array.isArray(t)?t[C]:"string"==typeof t?t.charCodeAt(C):t.readUInt8(C),a<CharSet.CP437.length&&(a>=32||e&&10!=a&&13!=a&&26!=a))r+=CharSet.CP437[a];else{if(e&&26==a)break;r+=String.fromCharCode(a)}}return r}static toCP437(t,e={}){let r="";for(let C=0;C<t.length;C++){let a=e[t[C]];a||(a=CharSet.CP437.indexOf(t[C]),a<0&&(a=t.charCodeAt(C),a>255&&(a=e[""]||42))),r+=String.fromCharCode(a)}return r}static isCP437(t){return CharSet.CP437.indexOf(t)>=0}static isText(t,e=[]){for(let r=0;r<t.length;r++){let C=t.charCodeAt(r);if((!e.length||e.indexOf(C)<0&&C<=255)&&(0==C||C>=128&&!CharSet.isCP437(t[r])))return!1}return!0}static toUpperCaseASCII(t){let e="";for(let r=0;r<t.length;r++){let C=t.charCodeAt(r);C>=97&&C<=122&&(C-=32),e+=String.fromCharCode(C)}return e}}CharSet.CP437=["\0","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""," ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];

			class CPU extends Device{constructor(t,s,e){e.class="CPU",super(t,s,e),this.dbg=void 0,this.regPC=this.regPCLast=0,this.addrReset=this.config.addrReset||0,this.time=this.findDeviceByClass("Time"),this.time.addClock(this),this.time.addUpdate(this),this.nCyclesStart=this.nCyclesRemain=this.nCyclesSnapped=0}abort(t){this.regPC=this.regPCLast,this.printf("%s\n",t.message),this.time.stop()}connectDebugger(t){return this.dbg=t,this.registers}execute(t){}startClock(t=0){this.nCyclesStart=this.nCyclesRemain=t;try{this.execute(t)}catch(t){this.abort(t)}return this.getClock()}stopClock(){this.nCyclesStart-=this.nCyclesRemain,this.nCyclesRemain=this.nCyclesSnapped=0}getClock(){return this.nCyclesStart-this.nCyclesRemain}}

			class CPUx86 extends CPU{constructor(C,O,e){super(C,O,e)}}CPUx86.MODEL_8086=8086,CPUx86.MODEL_8088=8088,CPUx86.MODEL_80186=80186,CPUx86.MODEL_80188=80188,CPUx86.MODEL_80286=80286,CPUx86.MODEL_80386=80386,CPUx86.STEPPING_80386_A0=80546,CPUx86.STEPPING_80386_A1=80547,CPUx86.STEPPING_80386_B0=80562,CPUx86.STEPPING_80386_B1=80563,CPUx86.STEPPING_80386_B2=80564,CPUx86.STEPPING_80386_C0=80578,CPUx86.STEPPING_80386_D0=80594,CPUx86.STEPPING_80386_D1=80595,CPUx86.STEPPING_80386_D2=80596,CPUx86.ADDR_INVALID=4294967296,CPUx86.EXCEPTION={DE_EXC:0,DB_EXC:1,NMI:2,BP_TRAP:3,OF_TRAP:4,BR_FAULT:5,UD_FAULT:6,NM_FAULT:7,DF_FAULT:8,MP_FAULT:9,TS_FAULT:10,NP_FAULT:11,SS_FAULT:12,GP_FAULT:13,PF_FAULT:14,MF_FAULT:16},CPUx86.PS={CF:1,BIT1:2,PF:4,BIT3:8,AF:16,BIT5:32,ZF:64,SF:128,TF:256,IF:512,DF:1024,OF:2048,IOPL:{MASK:12288,SHIFT:12},NT:16384,BIT15:32768,RF:65536,VM:131072},CPUx86.CR0={MSW:{PE:1,MP:2,EM:4,TS:8,ON:65520,MASK:65535},ET:16,ON:2147483616,PG:-2147483648},CPUx86.DR7={L0:1,G0:2,L1:4,G1:8,L2:16,G2:32,L3:64,G3:128,ENABLE:255,LE:256,GE:512,RW0:196608,LEN0:786432,RW1:3145728,LEN1:12582912,RW2:50331648,LEN2:201326592,RW3:805306368,LEN3:-1073741824},CPUx86.DR6={B0:1,B1:2,B2:4,B3:8,BD:8192,BS:16384,BT:32768},CPUx86.SEL={RPL:3,LDT:4,MASK:65528},CPUx86.DESC={LIMIT:{OFFSET:0},BASE:{OFFSET:2},ACC:{OFFSET:4,BASE1623:255,TYPE:{OFFSET:5,MASK:7936,SEG:4096,NONSEG:3840,CODE:2048,ACCESSED:256,READABLE:512,WRITABLE:512,CONFORMING:1024,EXPDOWN:1024,TSS_BUSY:512,NONSEG_386:2048,TSS286:256,LDT:512,TSS286_BUSY:768,GATE_CALL:1024,GATE_TASK:1280,GATE286_INT:1536,GATE286_TRAP:1792,TSS386:2304,TSS386_BUSY:2816,GATE386_CALL:3072,GATE386_INT:3584,GATE386_TRAP:3840,CODE_OR_DATA:7680,DATA_READONLY:4096,DATA_WRITABLE:4608,DATA_EXPDOWN:5120,DATA_EXPDOWN_WRITABLE:5632,CODE_EXECONLY:6144,CODE_READABLE:6656,CODE_CONFORMING:7168,CODE_CONFORMING_READABLE:7680},DPL:{MASK:24576,SHIFT:13},PRESENT:32768,INVALID:0},EXT:{OFFSET:6,LIMIT1619:15,AVAIL:16,BIG:64,LIMITPAGES:128,BASE2431:65280},INVALID:0},CPUx86.LADDR={PDE:{MASK:-4194304,SHIFT:20},PTE:{MASK:4190208,SHIFT:10},OFFSET:4095},CPUx86.PTE={FRAME:-4096,DIRTY:64,ACCESSED:32,USER:4,READWRITE:2,PRESENT:1},CPUx86.TSS286={PREV_TSS:0,CPL0_SP:2,CPL0_SS:4,CPL1_SP:6,CPL1_SS:8,CPL2_SP:10,CPL2_SS:12,TASK_IP:14,TASK_PS:16,TASK_AX:18,TASK_CX:20,TASK_DX:22,TASK_BX:24,TASK_SP:26,TASK_BP:28,TASK_SI:30,TASK_DI:32,TASK_ES:34,TASK_CS:36,TASK_SS:38,TASK_DS:40,TASK_LDT:42},CPUx86.TSS386={PREV_TSS:0,CPL0_ESP:4,CPL0_SS:8,CPL1_ESP:12,CPL1_SS:16,CPL2_ESP:20,CPL2_SS:24,TASK_CR3:28,TASK_EIP:32,TASK_PS:36,TASK_EAX:40,TASK_ECX:44,TASK_EDX:48,TASK_EBX:52,TASK_ESP:56,TASK_EBP:60,TASK_ESI:64,TASK_EDI:68,TASK_ES:72,TASK_CS:76,TASK_SS:80,TASK_DS:84,TASK_FS:88,TASK_GS:92,TASK_LDT:96,TASK_IOPM:100},CPUx86.ERRCODE={EXT:1,IDT:2,LDT:4,SELMASK:65532},CPUx86.RESULT={BYTE:128,WORD:32768,DWORD:-2147483648,TYPE:-2147450752,CF:1,PF:2,AF:4,ZF:8,SF:16,OF:32,ALL:63,LOGIC:26,NOTCF:62},CPUx86.OPFLAG={NOREAD:1,NOWRITE:2,NOINTR:4,WRAP:8,SEG:16,LOCK:32,REPZ:64,REPNZ:128,REPEAT:256,PUSHSP:512,DATASIZE:1024,ADDRSIZE:2048,FAULT:4096,DBEXC:8192,REPSEG:16384},CPUx86.INTFLAG={NONE:0,INTR:1,TRAP:2,HALT:4,DMA:8,DEBUGGER:16},CPUx86.OPCODE={ES:38,CS:46,SS:54,DS:62,PUSHSP:84,PUSHA:96,POPA:97,BOUND:98,ARPL:99,FS:100,GS:101,OS:102,AS:103,PUSHN:104,IMULN:105,PUSH8:106,IMUL8:107,INSB:108,INSW:109,OUTSB:110,OUTSW:111,ENTER:200,LEAVE:201,CALLF:154,MOVSB:164,MOVSW:165,CMPSB:166,CMPSW:167,STOSB:170,STOSW:171,LODSB:172,LODSW:173,SCASB:174,SCASW:175,INT3:204,INTN:205,INTO:206,IRET:207,ESC0:216,ESC1:217,ESC2:218,ESC3:219,ESC4:220,ESC5:221,ESC6:222,ESC7:223,LOOPNZ:224,LOOPZ:225,LOOP:226,CALL:232,JMP:233,JMPF:234,JMPS:235,LOCK:240,INT1:241,REPNZ:242,REPZ:243,CLI:250,STI:251,CLD:252,STD:253,GRP4W:255,CALLW:4351,CALLFDW:6399,CALLMASK:14591,UD2:2831},CPUx86.FPU={MODEL_8087:8087,MODEL_80287:80287,MODEL_80287XL:80387,MODEL_80387:80387,CONTROL:{IM:1,DM:2,ZM:4,OM:8,UM:16,PM:32,EXC:63,IEM:128,PC:768,RC:{NEAR:0,DOWN:1024,UP:2048,CHOP:3072,MASK:3072},IC:4096,UNUSED:57408,INIT:959},STATUS:{IE:1,DE:2,ZE:4,OE:8,UE:16,PE:32,SF:64,EXC:127,ES:128,C0:256,C1:512,C2:1024,ST:14336,ST_SHIFT:11,C3:16384,CC:18176,BUSY:32768},TAGS:{VALID:0,ZERO:1,SPECIAL:2,EMPTY:3,MASK:3}},CPUx86.CYCLES_8088={nWordCyclePenalty:4,nEACyclesBase:5,nEACyclesDisp:6,nEACyclesBaseIndex:7,nEACyclesBaseIndexExtra:8,nEACyclesBaseDisp:9,nEACyclesBaseIndexDisp:11,nEACyclesBaseIndexDispExtra:12,nOpCyclesAAA:4,nOpCyclesAAD:60,nOpCyclesAAM:83,nOpCyclesArithRR:3,nOpCyclesArithRM:9,nOpCyclesArithMR:16,nOpCyclesArithMID:1,nOpCyclesCall:19,nOpCyclesCallF:28,nOpCyclesCallWR:16,nOpCyclesCallWM:21,nOpCyclesCallDM:37,nOpCyclesCLI:2,nOpCyclesCompareRM:9,nOpCyclesCWD:5,nOpCyclesBound:33,nOpCyclesInP:10,nOpCyclesInDX:8,nOpCyclesIncR:3,nOpCyclesIncM:15,nOpCyclesInt:51,nOpCyclesInt3D:1,nOpCyclesIntOD:2,nOpCyclesIntOFall:4,nOpCyclesIRet:32,nOpCyclesJmp:15,nOpCyclesJmpF:15,nOpCyclesJmpC:16,nOpCyclesJmpCFall:4,nOpCyclesJmpWR:11,nOpCyclesJmpWM:18,nOpCyclesJmpDM:24,nOpCyclesLAHF:4,nOpCyclesLEA:2,nOpCyclesLS:16,nOpCyclesLoop:17,nOpCyclesLoopZ:18,nOpCyclesLoopNZ:19,nOpCyclesLoopFall:5,nOpCyclesLoopZFall:6,nOpCyclesMovRR:2,nOpCyclesMovRM:8,nOpCyclesMovMR:9,nOpCyclesMovRI:10,nOpCyclesMovMI:10,nOpCyclesMovAM:10,nOpCyclesMovMA:10,nOpCyclesDivBR:80,nOpCyclesDivWR:124,nOpCyclesDivBM:86,nOpCyclesDivWM:134,nOpCyclesIDivBR:101,nOpCyclesIDivWR:145,nOpCyclesIDivBM:107,nOpCyclesIDivWM:151,nOpCyclesMulBR:70,nOpCyclesMulWR:93,nOpCyclesMulBM:76,nOpCyclesMulWM:104,nOpCyclesIMulBR:80,nOpCyclesIMulWR:108,nOpCyclesIMulBM:86,nOpCyclesIMulWM:114,nOpCyclesNegR:3,nOpCyclesNegM:16,nOpCyclesOutP:10,nOpCyclesOutDX:8,nOpCyclesPopAll:51,nOpCyclesPopReg:8,nOpCyclesPopMem:17,nOpCyclesPushAll:36,nOpCyclesPushReg:11,nOpCyclesPushMem:16,nOpCyclesPushSeg:10,nOpCyclesPrefix:2,nOpCyclesCmpS:18,nOpCyclesCmpSr0:7,nOpCyclesCmpSrn:15,nOpCyclesLodS:12,nOpCyclesLodSr0:7,nOpCyclesLodSrn:11,nOpCyclesMovS:18,nOpCyclesMovSr0:7,nOpCyclesMovSrn:15,nOpCyclesScaS:15,nOpCyclesScaSr0:7,nOpCyclesScaSrn:13,nOpCyclesStoS:11,nOpCyclesStoSr0:7,nOpCyclesStoSrn:8,nOpCyclesRet:8,nOpCyclesRetn:12,nOpCyclesRetF:18,nOpCyclesRetFn:17,nOpCyclesShift1M:15,nOpCyclesShiftCR:8,nOpCyclesShiftCM:20,nOpCyclesShiftCS:2,nOpCyclesTestRR:3,nOpCyclesTestRM:9,nOpCyclesTestRI:5,nOpCyclesTestMI:11,nOpCyclesXchgRR:4,nOpCyclesXchgRM:17,nOpCyclesXLAT:11},CPUx86.CYCLES_80286={nWordCyclePenalty:0,nEACyclesBase:0,nEACyclesDisp:0,nEACyclesBaseIndex:0,nEACyclesBaseIndexExtra:0,nEACyclesBaseDisp:0,nEACyclesBaseIndexDisp:1,nEACyclesBaseIndexDispExtra:1,nOpCyclesAAA:3,nOpCyclesAAD:14,nOpCyclesAAM:16,nOpCyclesArithRR:2,nOpCyclesArithRM:7,nOpCyclesArithMR:7,nOpCyclesArithMID:0,nOpCyclesCall:7,nOpCyclesCallF:13,nOpCyclesCallWR:7,nOpCyclesCallWM:11,nOpCyclesCallDM:16,nOpCyclesCLI:3,nOpCyclesCompareRM:6,nOpCyclesCWD:2,nOpCyclesBound:13,nOpCyclesInP:5,nOpCyclesInDX:5,nOpCyclesIncR:2,nOpCyclesIncM:7,nOpCyclesInt:23,nOpCyclesInt3D:0,nOpCyclesIntOD:1,nOpCyclesIntOFall:3,nOpCyclesIRet:17,nOpCyclesJmp:7,nOpCyclesJmpF:11,nOpCyclesJmpC:7,nOpCyclesJmpCFall:3,nOpCyclesJmpWR:7,nOpCyclesJmpWM:11,nOpCyclesJmpDM:15,nOpCyclesLAHF:2,nOpCyclesLEA:3,nOpCyclesLS:7,nOpCyclesLoop:8,nOpCyclesLoopZ:8,nOpCyclesLoopNZ:8,nOpCyclesLoopFall:4,nOpCyclesLoopZFall:4,nOpCyclesMovRR:2,nOpCyclesMovRM:3,nOpCyclesMovMR:5,nOpCyclesMovRI:2,nOpCyclesMovMI:3,nOpCyclesMovAM:5,nOpCyclesMovMA:3,nOpCyclesDivBR:14,nOpCyclesDivWR:22,nOpCyclesDivBM:17,nOpCyclesDivWM:25,nOpCyclesIDivBR:17,nOpCyclesIDivWR:25,nOpCyclesIDivBM:20,nOpCyclesIDivWM:28,nOpCyclesMulBR:13,nOpCyclesMulWR:21,nOpCyclesMulBM:16,nOpCyclesMulWM:24,nOpCyclesIMulBR:13,nOpCyclesIMulWR:21,nOpCyclesIMulBM:16,nOpCyclesIMulWM:24,nOpCyclesNegR:2,nOpCyclesNegM:7,nOpCyclesOutP:5,nOpCyclesOutDX:5,nOpCyclesPopAll:19,nOpCyclesPopReg:5,nOpCyclesPopMem:5,nOpCyclesPushAll:17,nOpCyclesPushReg:3,nOpCyclesPushMem:5,nOpCyclesPushSeg:3,nOpCyclesPrefix:0,nOpCyclesCmpS:8,nOpCyclesCmpSr0:5,nOpCyclesCmpSrn:9,nOpCyclesLodS:5,nOpCyclesLodSr0:5,nOpCyclesLodSrn:4,nOpCyclesMovS:5,nOpCyclesMovSr0:5,nOpCyclesMovSrn:4,nOpCyclesScaS:7,nOpCyclesScaSr0:5,nOpCyclesScaSrn:8,nOpCyclesStoS:3,nOpCyclesStoSr0:4,nOpCyclesStoSrn:3,nOpCyclesRet:11,nOpCyclesRetn:11,nOpCyclesRetF:15,nOpCyclesRetFn:15,nOpCyclesShift1M:7,nOpCyclesShiftCR:5,nOpCyclesShiftCM:8,nOpCyclesShiftCS:0,nOpCyclesTestRR:2,nOpCyclesTestRM:6,nOpCyclesTestRI:3,nOpCyclesTestMI:6,nOpCyclesXchgRR:3,nOpCyclesXchgRM:5,nOpCyclesXLAT:5},CPUx86.CYCLES_80386={nEACyclesBase:0,nEACyclesDisp:0,nEACyclesBaseIndex:0,nEACyclesBaseIndexExtra:0,nEACyclesBaseDisp:0,nEACyclesBaseIndexDisp:1,nEACyclesBaseIndexDispExtra:1},CPUx86.PS_DIRECT_8086=CPUx86.PS.TF|CPUx86.PS.IF|CPUx86.PS.DF,CPUx86.PS_SET_8086=CPUx86.PS.BIT1|CPUx86.PS.IOPL.MASK|CPUx86.PS.NT|CPUx86.PS.BIT15,CPUx86.PS_CACHED=CPUx86.PS.CF|CPUx86.PS.PF|CPUx86.PS.AF|CPUx86.PS.ZF|CPUx86.PS.SF|CPUx86.PS.OF,CPUx86.PS_SAHF=CPUx86.PS.CF|CPUx86.PS.PF|CPUx86.PS.AF|CPUx86.PS.ZF|CPUx86.PS.SF,CPUx86.OPFLAG_PREFIXES=CPUx86.OPFLAG.SEG|CPUx86.OPFLAG.LOCK|CPUx86.OPFLAG.REPZ|CPUx86.OPFLAG.REPNZ|CPUx86.OPFLAG.DATASIZE|CPUx86.OPFLAG.ADDRSIZE,CPUx86.CLASSES.CPUx86=CPUx86;

			class DiskInfo{static MIN_PARTITION=3e6;static DESC={IMAGE:"imageInfo",VOLUMES:"volTable",FILES:"fileTable",DISKDATA:"diskData"};static TYPE={CHS:"CHS"};static IMAGE={TYPE:"type",NAME:"name",FORMAT:"format",HASH:"hash",CHECKSUM:"checksum",CYLINDERS:"cylinders",HEADS:"heads",TRACKDEF:"trackDefault",SECTORDEF:"sectorDefault",DISKSIZE:"diskSize",ORIGBPB:"bootSector",VERSION:"version",REPOSITORY:"repository",GENERATED:"generated",SOURCE:"source",COMMAND:"diskimage.js"};static VOLDESC={PARTITION:"iPartition",MEDIA_ID:"idMedia",LBA_VOL:"lbaStart",LBA_TOTAL:"lbaTotal",FAT_ID:"idFAT",VBA_FAT:"vbaFAT",VBA_ROOT:"vbaRoot",ROOT_TOTAL:"rootTotal",VBA_DATA:"vbaData",CLUS_SECS:"clusSecs",CLUS_MAX:"clusMax",CLUS_BAD:"clusBad",CLUS_FREE:"clusFree",CLUS_TOTAL:"clusTotal"};static FILEDESC={VOL:"vol",PATH:"path",NAME:"name",ATTR:"attr",DATE:"date",SIZE:"size",HASH:"hash",MODULE:"module",MODNAME:"name",MODDESC:"description",MODSEGS:"segments",CONTENTS:"contents",ORIGIN:"origin"};static SECTOR={CYLINDER:"c",HEAD:"h",ID:"s",LENGTH:"l",DATA:"d",FILE_INDEX:"f",FILE_OFFSET:"o",DATA_CRC:"dataCRC",DATA_ERROR:"dataError",DATA_MARK:"dataMark",HEAD_CRC:"headCRC",HEAD_ERROR:"headError"};static MBR={PCJS_SIG:409,DRIVE0PARMS:{CYLS:414,HEADS:416,SECTORS:428},DRIVE1PARMS:{CYLS:430,HEADS:432,SECTORS:444},PARTITIONS:{OFFSET:446,ENTRY:{STATUS:0,CHS_FIRST:1,TYPE:4,CHS_LAST:5,VBA_FIRST:8,VBA_TOTAL:12},ENTRY_LENGTH:16,STATUS:{ACTIVE:128,INACTIVE:0},TYPE:{EMPTY:0,FAT12_PRIMARY:1,FAT16_PRIMARY:4,EXTENDED:5,FAT16_BIG:6}},SIG_OFFSET:510,SIGNATURE:43605};static BOOT={SIG_OFFSET:510,SIGNATURE:43605};static PCJS_LABEL="PCJS";static PCJS_OEM="PCJS.ORG";static PCJS_VALUE=1397375824;static BPB={OPCODE:0,BEGIN:3,OEM:3,SECBYTES:11,CLUSSECS:13,RESSECS:14,FATS:16,DIRENTS:17,DISKSECS:19,MEDIA:21,FATSECS:22,TRACKSECS:24,DRIVEHEADS:26,HIDDENSECS:28,BOOTDRIVE:30,BOOTHEAD:31,LARGESECS:32,END:36,DRIVE:36,CYLSECS:37,LBAROOT:39,LBADATA:41,ENDEX:43};static GEOMETRIES={163840:[40,1,8,512,254],184320:[40,1,9,512,252],327680:[40,2,8,512,255],368640:[40,2,9,512,253],737280:[80,2,9,512,249],1228800:[80,2,15,512,249],1474560:[80,2,18,512,240],2949120:[80,2,36,512,240],10653696:[306,4,17],21411840:[615,4,17],256256:[77,1,26,128],1261568:[77,2,8,1024],2494464:[203,2,12,512],5242880:[256,2,40,256],10485760:[512,2,40,256]};static FAT={MEDIA_160KB:254,MEDIA_180KB:252,MEDIA_320KB:255,MEDIA_360KB:253,MEDIA_720KB:249,MEDIA_1200KB:249,MEDIA_FIXED:248,MEDIA_1440KB:240,MEDIA_2880KB:240};static FAT12={MAX_CLUSTERS:4084,CLUSNUM_FREE:0,CLUSNUM_RES:1,CLUSNUM_MIN:2,CLUSNUM_MAX:4086,CLUSNUM_BAD:4087,CLUSNUM_EOC:4088};static FAT16={MAX_CLUSTERS:65524,CLUSNUM_FREE:0,CLUSNUM_RES:1,CLUSNUM_MIN:2,CLUSNUM_MAX:65526,CLUSNUM_BAD:65527,CLUSNUM_EOC:65528};static DIRENT={NAME:0,EXT:8,ATTR:11,MODTIME:22,MODDATE:24,CLUSTER:26,SIZE:28,LENGTH:32,UNUSED:0,INVALID:229};static ATTR={READONLY:1,HIDDEN:2,SYSTEM:4,VOLUME:8,LFN:15,SUBDIR:16,ARCHIVE:32,METADATA:256};static aDefaultBPBs=[[235,254,144,80,67,74,83,46,79,82,71,0,2,1,1,0,2,64,0,64,1,254,1,0,8,0,1,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,2,1,0,2,112,0,128,2,255,1,0,8,0,2,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,1,1,0,2,64,0,104,1,252,2,0,9,0,1,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,2,1,0,2,112,0,208,2,253,2,0,9,0,2,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,1,1,0,2,224,0,96,9,249,7,0,15,0,2,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,2,1,0,2,112,0,160,5,249,3,0,9,0,2,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,1,1,0,2,112,0,160,5,249,5,0,9,0,2,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,2,1,1,0,2,224,0,64,11,240,9,0,18,0,2,0,0,0,0,0],[235,254,144,73,66,77,32,32,50,46,48,0,2,8,1,0,2,0,2,3,81,248,8,0,17,0,4,0,1,0,0,0],[235,254,144,73,66,77,32,32,50,46,48,0,2,16,1,0,2,0,4,23,163,248,8,0,17,0,4,0,1,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,128,0,4,1,0,2,68,0,210,7,0,6,0,26,0,1,0,0,0,0,0],[235,254,144,80,67,74,83,46,79,82,71,0,4,1,1,0,2,192,0,208,4,0,2,0,8,0,2,0,0,0,0,0]];constructor(t,e="",i=!1){this.device=t,this.printf=()=>{},this.assert=()=>{},this.diskName=e,this.args="",this.fWritable=i,this.volTable=[],this.fileTable=[],this.aMetaData=[],this.tablesBuilt=!1,this.cbDiskData=0,this.dwChecksum=0,this.driveCtrl="",this.driveType=-1,this.hash="none"}buildDiskFromBuffer(t,e,i,$={}){this.aDiskData=null,this.cbDiskData=0,this.dwChecksum=0,this.fromJSON=!1;let s=0,n=0,r=0,a=[],o=$.cbSector||512,l=0,f=0,D=t.length,I=D,E,S,h,x,T,d;if(void 0==$.driveType&&($.driveType=-1),($.partitioned||D>=DiskInfo.MIN_PARTITION&&!1!==$.partitioned)&&t.readUInt16LE(DiskInfo.BOOT.SIG_OFFSET)==DiskInfo.BOOT.SIGNATURE){for(let c=446;c<=494;c+=16)if(t.readUInt8(c)>=128){f=t.readUInt32LE(c+8)*o,I=t.readUInt32LE(c+12)*o;break}}let A=t.readUInt8(f+DiskInfo.BPB.OPCODE),k=t.readUInt8(f+DiskInfo.BPB.OPCODE+1),_=t.readUInt16LE(f+DiskInfo.BPB.SECBYTES);this.abOrigBPB=[],this.fBPBModified=!1,this.abOrigBPB.push(f);for(let R=DiskInfo.BPB.OPCODE;R<DiskInfo.BPB.LARGESECS+4;R++)this.abOrigBPB.push(t.readUInt8(f+R));let C=!1,B=DiskInfo.GEOMETRIES[D];B||(B=DiskInfo.GEOMETRIES[D-128]),B&&(n=B[0],s=B[1],r=B[2],o=B[3]||o,l=B[4]||l);let u=!1,b=0;if((A==CPUx86.OPCODE.JMP||A==CPUx86.OPCODE.JMPS||A==CPUx86.OPCODE.CLD)&&_>=128&&(_&_-1)==0){let O=t.readUInt16LE(f+DiskInfo.BPB.DRIVEHEADS),F=t.readUInt16LE(f+DiskInfo.BPB.TRACKSECS);if(O&&F){u=!0,b=t.readUInt8(f+DiskInfo.BPB.MEDIA);let g=t.readUInt16LE(f+DiskInfo.BPB.DISKSECS);g||(g=t.readUInt32LE(f+DiskInfo.BPB.LARGESECS));let N=(t.readUInt16LE(f+DiskInfo.BPB.HIDDENSECS)+g)/(F*O);if(B&&$.driveType<0){if(l&&l!=b&&this.printf(MESSAGE.WARNING,"BPB media ID (%#0bx) does not match physical media ID (%#0bx)\n",b,l),n!=N){let M=n-N==1?MESSAGE.INFO:MESSAGE.WARNING;this.printf(M,"BPB cylinders (%d) do not match physical cylinders (%d)\n",N,n),M==MESSAGE.INFO&&this.printf(M,"last cylinder may have been reserved for diagnostics and/or head-parking\n")}s!=O&&this.printf(MESSAGE.WARNING,"BPB heads (%d) do not match physical heads (%d)\n",O,s),r!=F&&this.printf(MESSAGE.WARNING,"BPB sectors/track (%d) do not match physical sectors/track (%d)\n",F,r)}else(n=D/((s=O)*(r=F)*_))!=(0|n)&&(this.printf(MESSAGE.WARNING,"total cylinders (%d) not a multiple of %d sectors per cylinder\n",n,s*r),n|=0),o!=_&&(this.printf(MESSAGE.WARNING,"overriding default sector size (%d) with BPB sector size (%d)\n",o,_),o=_),l=b;3680==g&&this.fXDFSupport&&(this.printf(MESSAGE.WARNING,"XDF diskette detected, experimental XDF output enabled\n"),C=!0)}}let L=-1;for(let P=0;P<DiskInfo.aDefaultBPBs.length;P++)if(DiskInfo.aDefaultBPBs[P][DiskInfo.BPB.MEDIA]==l&&(DiskInfo.aDefaultBPBs[P][DiskInfo.BPB.DISKSECS]+256*DiskInfo.aDefaultBPBs[P][DiskInfo.BPB.DISKSECS+1])*o==D&&(!u||t.readUInt8(f+DiskInfo.BPB.CLUSSECS)==DiskInfo.aDefaultBPBs[P][DiskInfo.BPB.CLUSSECS])){L=P;break}let p=r;if(L>=0){b||(b=t.readUInt8(f+512)),(L>=2&&b==DiskInfo.FAT.MEDIA_320KB&&l==DiskInfo.FAT.MEDIA_360KB||b==DiskInfo.FAT.MEDIA_160KB&&l==DiskInfo.FAT.MEDIA_180KB)&&(L-=2,l=DiskInfo.aDefaultBPBs[L][DiskInfo.BPB.MEDIA],p=DiskInfo.aDefaultBPBs[L][DiskInfo.BPB.TRACKSECS],this.printf(MESSAGE.WARNING,"shrinking track size to %d sectors/track\n",p));let m=!1;if(u)for(let U=DiskInfo.BPB.SECBYTES;U<DiskInfo.BPB.HIDDENSECS+2;U++){let v=DiskInfo.aDefaultBPBs[L][U],G=t.readUInt8(f+U);v!=G&&(this.printf(MESSAGE.WARNING,"BPB byte %#02bx default (%#02bx) does not match actual byte: %#02bx\n",U,v,G),U!=DiskInfo.BPB.FATS&&U!=DiskInfo.BPB.DIRENTS&&(m=!0))}if(!u||m){if(A==CPUx86.OPCODE.JMPS&&k>=34||e){for(let y=e?0:DiskInfo.BPB.SECBYTES;y<DiskInfo.BPB.LARGESECS+4;y++)t.writeUInt8(DiskInfo.aDefaultBPBs[L][y]||0,f+y);this.printf(MESSAGE.INFO,"BPB has been updated\n"),i&&(this.fBPBModified=!0)}else if(246==A&&246==k&&b>248){this.printf(MESSAGE.WARNING,"repairing damaged boot sector with BPB for media ID %#02bx\n",l);for(let H=0;H<DiskInfo.BPB.LARGESECS+4;H++)t.writeUInt8(DiskInfo.aDefaultBPBs[L][H]||0,f+H)}else this.printf(MESSAGE.WARNING,"unrecognized boot sector: %#02bx,%#02bx\n",A,k)}}if((u&&t.readUInt16LE(f+DiskInfo.BOOT.SIG_OFFSET)==DiskInfo.BOOT.SIGNATURE||e)&&t.readInt32LE(DiskInfo.BPB.OEM+f)!=DiskInfo.PCJS_VALUE&&D<DiskInfo.MIN_PARTITION&&"PCJS"!=$.driveCtrl&&(t.write(DiskInfo.PCJS_OEM,DiskInfo.BPB.OEM+f,DiskInfo.PCJS_OEM.length),this.printf(MESSAGE.INFO,"OEM string has been updated\n"),i&&(this.fBPBModified=!0)),T=0,!s&&!(254&A)){let V=t.readUInt16LE(f+6);if(!(V&V-1)){o=V,s=t.readUInt8(f+1),n=t.readUInt16LE(f+2),p=r=t.readUInt16LE(f+4);let K=s*n;if(T=8,!(x=r*o))for(h=0;h<K;h++)p=r=t.readUInt16LE(T),x=r*(V=t.readUInt16LE(T+2)),d=t.readUInt32LE(T+4),E=t.slice(d,d+x),a[h]=[r,V,E],T+=8}}if(s){h=0,x=r*o;let Y=this.parseSuppData($.suppData);this.aDiskData=Array(n),i&&(this.hash=i(t)),this.nCylinders=n;for(let w=0;w<n;w++){let z=Array(s);this.aDiskData[w]=z,this.nHeads=s;let X=0;for(let W=0;W<s;W++){if(a.length){let J=a[h++];p=r=J[0],o=J[1],E=J[2],x=r*o}else E=t.slice(T+X,T+X+x);let Z=Array(p);z[W]=Z,this.nSectors=p;let q=o,j=p;this.cbSector=o,C&&(j=w?4:19);let Q=null;for(let tt=1,te=0;tt<=j&&(te<x||Q);tt++,te+=q){let ti=tt;C&&w&&(ti=512==(q=W?1==tt?8192:2==tt?2048:3==tt?1024:512:1==tt?1024:2==tt?512:3==tt?2048:8192)?2:1024==q?3:2048==q?4:6);let t$,ts;if($.sectorIDs){let tn="string"==typeof $.sectorIDs?[$.sectorIDs]:$.sectorIDs;for(let tr=0;tr<tn.length;tr++)+(t$=tn[tr].split(":"))[0]!==w||+t$[1]!==W||+t$[2]!==ti||isNaN(ts=+t$[3])||(ti=ts,this.printf(MESSAGE.WARNING,"changing %d:%d:%d sectorID to %d\n",+t$[0],+t$[1],+t$[2],ti))}let ta=0;if($.sectorErrors){let to="string"==typeof $.sectorErrors?[$.sectorErrors]:$.sectorErrors;for(let tl=0;tl<to.length;tl++)+(t$=to[tl].split(":"))[0]===w&&+t$[1]===W&&+t$[2]===ti&&(ta=ts=+t$[3]||-1,this.printf(MESSAGE.WARNING,"forcing error for sector %d:%d:%d at %d bytes\n",+t$[0],+t$[1],+t$[2],ta))}if(S=E.slice(te,te+q),l&&!w&&!W&&tt==(f/o|0)+2){let tf=S.readUInt8(0);l!=tf&&this.printf(MESSAGE.WARNING,"FAT ID (%#02bx) does not match physical media ID (%#02bx)\n",tf,l),l=0}let tD=this.buildSector(w,W,ti,q,S),tI=null;if(Y[w]&&(Q=Y[w][W])){let tE;for(tE=0;tE<Q.length&&!(Q[tE].sectorID<=p);tE++);tE==Q.length?(j=p+Q.length,tI=Q[tt-p-1]):(tI=Q[tt-1],j=Q.length)}tI&&(tD[DiskInfo.SECTOR.ID]=tI.sectorID,tI.length&&(tD[DiskInfo.SECTOR.LENGTH]=tI.length),tI.headCRC&&(tD[DiskInfo.SECTOR.HEAD_CRC]=tI.headCRC),tI.headError&&(tD[DiskInfo.SECTOR.HEAD_ERROR]=!0),tI.dataCRC&&(tD[DiskInfo.SECTOR.DATA_CRC]=tI.dataCRC),tI.dataMark&&(tD[DiskInfo.SECTOR.DATA_MARK]=tI.dataMark),ta||(ta=tI.dataError),tD[DiskInfo.SECTOR.DATA]=tI.data),ta&&(tD[DiskInfo.SECTOR.DATA_ERROR]=ta),Z[tt-1]=tD,this.cbDiskData+=tD[DiskInfo.SECTOR.LENGTH]}X+=x}T+=X}return!0}return!1}buildDiskFromFiles(t,e,i,$=0,s,n={}){if(!i||!i.length)return!1;this.diskName=e,this.abOrigBPB=[],this.fBPBModified=!1,this.minDOSVersion=0,this.aFileData=i;let r=1024*($||1440),a=$?2*$:0,o=0,l=this.calcFileSizes(i);DiskInfo.findDriveType(n,a,this)&&(this.driveCtrl=n.driveCtrl,this.driveType=n.driveType,this.nCylinders=n.nCylinders,this.nHeads=n.nHeads,this.nSectors=n.nSectors,this.cbSector=n.cbSector||512,r=(o=this.nCylinders*this.nHeads*this.nSectors)*this.cbSector);let f=function(t){let e=0;if(t)for(let i of t)e+=1+f(i.files);return e};if(this.printf(MESSAGE.DISK+MESSAGE.INFO,"calculated size for %d files: %d bytes (%#x)\n",f(i),l),l>=r)return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"file(s) too large (%d bytes total, %d bytes maximum)\n",l,r),!1;let D,I=this,E=function(t,e){let i=0;for(let $=0;$<e;$++)i|=D[t++]<<8*$;return i},S=function(t,e,i){for(let $=0;$<e;$++)D[t++]=255&i,i>>>=8;I.assert(!i)},h=2,x=12,T=512,d,c,A,k,_=-1,R,C,B,u=0,b,O=0,F=0;if(this.driveType>=0){this.minDOSVersion=2,D=[235,254,144,73,66,77,32,32,50,46,48,0,2,8,1,0,2,0,2,3,81,248,8,0,17,0,4,0,1,0,0,0,0];let g=240;if(c=this.nHeads,d=this.nSectors,n.partitioned&&(g=248,O=n.hiddenSectors||1,F=c*d),o<=O+F)return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"insufficient sectors (%d total, %d unusable)\n",o,O+F),!1;o-=O+F,T=n.cbSector||T,S(DiskInfo.BPB.SECBYTES,2,T),R=n.clusterSize&&Math.ceil(n.clusterSize/T)||1;let N=32768/T|0;(12==n.typeFAT||16==n.typeFAT)&&(x=n.typeFAT),R=DiskInfo.nearestPowerOfTwo(R,N),u=(u=n.rootEntries||512)+15>>4<<4,!n.rootEntries&&u<i.length&&(u=Math.ceil(i.length/u)*u),n.clusterSize||(o<=512?R=1:o<=2048?R=2:o<=8192?R=4:o<=32680?R=8:n.verDOS>=3?(x=16,R=o<=262144?4:o<=524288?8:o<=1048576?16:o<=2097152?32:64):R=16),n.rootEntries||(u=o<=512?64:o<=2048?112:o<=8192?256:o<=32680||3==n.verDOS?512:1024),b=Math.ceil(32*u/T);let M=i[0]?Math.trunc(i[0].size/T)+1:0,L=4,P,p,m,U=R;for(;;){if(p=12==x?0:DiskInfo.FAT12.MAX_CLUSTERS+1,m=12==x?DiskInfo.FAT12.MAX_CLUSTERS:DiskInfo.FAT16.MAX_CLUSTERS,B=Math.ceil(Math.ceil((P=Math.floor(o/R))*x/8)/T),3==n.verDOS&&16==x&&(B=Math.ceil((o-1-b)/(256*R+h))),n.trimFAT&&10947==o&&8==R&&5==B&&(B=4),P<p){if(!L--)break;x=12,R=U,U=1;continue}if(P<=m&&(B*T<=32768||n.verDOS>=3.31)){if(function(){let t=!1;if(M&&(!n.verDOS||n.verDOS<3.31)){let e=n.hiddenSectors?0:d;for(;e--&&(O+1+h*B+b+M)%d!=0;){O++,o--,t=!0}}return t}()){if(!L--)break;continue}break}if(R==N){if(12==x){if(!L--)break;x=16,R=U,U=1;continue}this.printf(MESSAGE.DISK+MESSAGE.ERROR,"cluster size (%d) at limit for disk with %d sectors\n",R*T,o);break}R*=2}if(L<0&&this.printf(MESSAGE.DISK+MESSAGE.ERROR,"unable to find suitable cluster size for %d sectors\n",o),16==x){if(n.verDOS>=3.1||o>32680){let v=0|n.verDOS||2,G=10*n.verDOS%10||0;S(DiskInfo.BPB.OEM+5,1,48+v),S(DiskInfo.BPB.OEM+7,1,48+G)}this.minDOSVersion<3&&(this.minDOSVersion=3)}C=R*T,S(DiskInfo.BPB.CLUSSECS,1,R),S(DiskInfo.BPB.FATS,1,h),S(DiskInfo.BPB.MEDIA,1,g),S(DiskInfo.BPB.FATSECS,2,B),S(DiskInfo.BPB.TRACKSECS,2,d),S(DiskInfo.BPB.DRIVEHEADS,2,c),o<=65535?S(DiskInfo.BPB.DISKSECS,2,o):(S(DiskInfo.BPB.DISKSECS,2,0),S(DiskInfo.BPB.LARGESECS,4,o),this.minDOSVersion=3.31),S(DiskInfo.BPB.DIRENTS,2,u),S(DiskInfo.BPB.RESSECS,2,1),S(DiskInfo.BPB.HIDDENSECS,2,O),n.verDOS>=2&&n.verDOS<3.2&&n.verDOS>=this.minDOSVersion&&(S(DiskInfo.BPB.BOOTDRIVE,1,!1===n.partitioned?0:128),S(DiskInfo.BPB.LARGESECS,1,M)),k=(A=o-(b+h*B+1))*T;let y=Math.ceil(Math.ceil((Math.trunc(A/R)+2)*x/8)/T);y!=B&&this.printf(MESSAGE.DISK+MESSAGE.WARNING,"%d FAT sectors allocated, but only %d are required\n",B,y)}if(!o){let H=0;for(_=0;_<DiskInfo.aDefaultBPBs.length;_++)if((D=DiskInfo.aDefaultBPBs[_].slice())[DiskInfo.BPB.MEDIA]==DiskInfo.FAT.MEDIA_FIXED==$>=1e4&&((u=E(DiskInfo.BPB.DIRENTS,2))>H&&(H=u),!(i.length>u))){if(C=(T=E(DiskInfo.BPB.SECBYTES,2))*(R=D[DiskInfo.BPB.CLUSSECS]),h=D[DiskInfo.BPB.FATS],B=E(DiskInfo.BPB.FATSECS,2),b=(u*DiskInfo.DIRENT.LENGTH+T-1)/T|0,o=E(DiskInfo.BPB.DISKSECS,2),O=E(DiskInfo.BPB.HIDDENSECS,2),d=E(DiskInfo.BPB.TRACKSECS,2),c=E(DiskInfo.BPB.DRIVEHEADS,2),A=o-(b+h*B+1),F=O?c*d:0,k=A*T,!a||O){if(l<=k&&a<=o){let V=this.calcFileSizes(i,R);if(V<=k){l=V;break}}}else if(a==o)break}if(_==DiskInfo.aDefaultBPBs.length&&(u=H,i.length<=u))return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"files exceed supported disk formats (%d bytes total)\n",l),!1;this.nCylinders=(o+O+F)/(c*d),this.nHeads=c,this.nSectors=d,this.cbSector=T}if(i.length>u)return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"%d files in root exceeds supported maximum of %d\n",i.length,u),!1;if(l>k)return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"file(s) too large (%d bytes total, %d bytes available)\n",l,k),!1;let K,Y=0,w=(o+O)*T,z=(o+O+F)*T;t.new(z),t.fill(0),O&&(K=this.buildMBR(c,d,T,O,o,x),Y+=this.copyData(t,Y,K)*O),D[DiskInfo.BOOT.SIG_OFFSET]=255&DiskInfo.BOOT.SIGNATURE,D[DiskInfo.BOOT.SIG_OFFSET+1]=DiskInfo.BOOT.SIGNATURE>>8&255,K=this.buildData(T,D),Y+=1*this.copyData(t,Y,K);let X=[];for(this.buildFATEntry(X,0,65280|D[DiskInfo.BPB.MEDIA],x),this.buildFATEntry(X,1,65535,x),this.buildFAT(X,i,2,C,x);h--;)K=this.buildData(B*T,X),Y+=this.copyData(t,Y,K);let W=[],J=this.buildDir(W,i);if(_>=0&&_<2){let Z=J*DiskInfo.DIRENT.LENGTH;for(;J++<u;)W[Z]=DiskInfo.DIRENT.INVALID,Z+=DiskInfo.DIRENT.LENGTH}K=this.buildData(b*T,W),Y+=this.copyData(t,Y,K);let q=this.buildClusters(t,i,Y,C,0,0);return(Y+=q*R*T,this.printf(MESSAGE.DISK+MESSAGE.INFO,"%d bytes written, %d bytes available\n",Y,w),Y>w)?(this.printf(MESSAGE.DISK+MESSAGE.ERROR,"too much data for disk image (%d clusters required)\n",q),!1):this.buildDiskFromBuffer(t,void 0,s,n)}calcFileSizes(t,e){let i=0,$=512*(e||1);for(let s=0;s<t.length;s++){let n=t[s].size,r=0;n<0&&(n=(t[s].files.length+2)*32,r=this.calcFileSizes(t[s].files,e)),i+=n,(n%=$)&&(i+=$-n),i+=r}return i}buildData(t,e){let i=Array(t);for(let $=0;$<t;$++)i[$]=e&&e[$]||0;return i}copyData(t,e,i){return t.fill(i,e,e+i.length),i.length}buildClusters(t,e,i,$,s,n){let r=0,a=0;for(let o=0;o<e.length;o++){let l=e[o].data,f=e[o].size;if(f>0)this.assert(f==l.length);else if(f<0){let D=[];f=32*this.buildDir(D,e[o].files,e[o].date,e[o].cluster,s),l.new(f),l.fill(D),r++}f&&(l.copy(t,i),this.printf(MESSAGE.DEBUG+MESSAGE.DISK,"%#x: %#x bytes written for %s\n",i,l.length,e[o].path)),i+=f,a+=f/$|0;let I=f%$;I&&(i+=I=$-I,a++)}if(r>0){for(let E=0;E<e.length;E++)if(e[E].size<0){this.printf(MESSAGE.DEBUG+MESSAGE.DISK,"%#x: buildClusters()\n",i);let S=this.buildClusters(t,e[E].files,i,$,e[E].cluster,n+1);a+=S,i+=S*$,this.printf(MESSAGE.DEBUG+MESSAGE.DISK,"%#x: buildClusters() returned, writing %d clusters\n",i,S)}}return a}buildDateTime(t){if(!t)return 0;let e=t.getFullYear();if(e<1980)return 0;let i=t.getMonth()+1,$=t.getDate(),s=(31&t.getHours())<<11|(63&t.getMinutes())<<5|t.getSeconds()>>1&31;return e>2099&&(e=2099,i=12,$=31,s=1),(65535&((e-1980&127)<<9|i<<5|$))<<16|65535&s}buildDir(t,e,i,$,s){void 0===i&&(i=null),void 0===$&&($=-1),void 0===s&&(s=-1);let n=0,r=0,a=[];$>=0&&(n+=this.buildDirEntry(t,n,".",0,DiskInfo.ATTR.SUBDIR,i,$),n+=this.buildDirEntry(t,n,"..",0,DiskInfo.ATTR.SUBDIR,i,s),r+=2);for(let o=0;o<e.length;o++){let l=e[o];if(void 0===l.cluster){this.printf(MESSAGE.DISK,"file %s missing cluster, skipping\n",l.name);continue}let f,D=0;do f=this.buildShortName(l.name,!!(l.attr&DiskInfo.ATTR.VOLUME),D++,l.nameEncoding);while(a.indexOf(f)>=0);l.attr!=DiskInfo.ATTR.VOLUME&&a.push(f),n+=this.buildDirEntry(t,n,f,l.size,l.attr,l.date,l.cluster),r++}return r}buildDirEntry(t,e,i,$,s,n,r){let a,o="",l=e;for(s==DiskInfo.ATTR.VOLUME?(o=i.substr(8,3),i=i.substr(0,8)):(a=i.indexOf("."))>0&&(o=i.substr(a+1),i=i.substr(0,a)),a=0;a<8;a++)t[e++]=a<i.length?i.charCodeAt(a):32;for(a=0;a<3;a++)t[e++]=a<o.length?o.charCodeAt(a):32;t[e++]=s,e+=10;let f=this.buildDateTime(n);return t[e++]=255&f,t[e++]=f>>8&255,f>>>=16,t[e++]=255&f,t[e++]=f>>8&255,t[e++]=255&r,t[e++]=r>>8&255,$<0&&($=0),t[e++]=255&$,t[e++]=$>>8&255,t[e++]=$>>16&255,t[e++]=$>>24&255,e-l}buildFAT(t,e,i,$,s=12){let n,r=0;for(let a=0;a<e.length;a++){(n=e[a].size)<0&&(n=(e[a].files.length+2)*32,r++);let o=(n+$-1)/$|0;if(o)for(e[a].cluster=i;o-- >0;){let l=i+1;o||(l=(1<<s)-1),this.printf(MESSAGE.DEBUG+MESSAGE.DISK,"%s: setting cluster entry %d to %#0wx\n",e[a].name,i,l),this.buildFATEntry(t,i++,l,s)}else e[a].cluster=0}if(r)for(let f=0;f<e.length;f++)(n=e[f].size)<0&&(i=this.buildFAT(t,e[f].files,i,$,s));return i}buildFATEntry(t,e,i,$=12){let s=e*$,n=s>>3;i&=(1<<$)-1,16==$?(t[n]=255&i,t[n+1]=i>>8):s%8==0?(t[n]=255&i,void 0===t[++n]&&(t[n]=0),t[n]=240&t[n]|i>>8):(void 0===t[n]&&(t[n]=0),t[n]=15&t[n]|(15&i)<<4,t[n+1]=i>>4)}buildMBR(t,e,i,$,s,n=12){let r=494,a=this.buildData(i);a[r++]=128;let o=this.getCHS($);a[r++]=o[1],a[r++]=o[2]|(768&o[0])>>2,a[r++]=255&o[0];let l=12==n?DiskInfo.MBR.PARTITIONS.TYPE.FAT12_PRIMARY:s<=65535?DiskInfo.MBR.PARTITIONS.TYPE.FAT16_PRIMARY:DiskInfo.MBR.PARTITIONS.TYPE.FAT16_BIG;a[r++]=l,a[r++]=t-1;let f=s/(t*e)|0;return a[r++]=e|(768&f)>>2,a[r++]=255&f,a[r++]=255&$,a[r++]=$>>8&255,a[r++]=$>>16&255,a[r++]=$>>24&255,a[r++]=255&s,a[r++]=s>>8&255,a[r++]=s>>16&255,a[r++]=s>>24&255,a[r++]=85,a[r]=170,a}buildShortName(t,e=!1,i=0,$="utf8"){let s="utf8"==$?t.toUpperCase():CharSet.toUpperCaseASCII(t);if(e)s=s.substr(0,11).trimEnd();else{let n=s.lastIndexOf("."),r="";if(n>=0?(r=s.substr(n+1),s=s.substr(0,n)):e&&s.length>8&&(r=s.substr(8)),s=s.substr(0,8).trimEnd().replace(/\./g,""),i){let a="~"+i;s=s.substr(0,8-a.length)+a}r=r.substr(0,3).trimEnd();let o=-1;r&&(o=s.length,s+="."+r);for(let l=0;l<s.length;l++){if(l==o)continue;let f=s.charAt(l);"utf8"==$&&0>"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$%&'()-@^_`{}~ ".indexOf(f)&&(s=s.substr(0,l)+"_"+s.substr(l+1))}}return s}buildDiskFromJSON(t,e=!1){if(this.aDiskData=null,this.cbDiskData=0,this.dwChecksum=0,this.fromJSON=!1,this.abOrigBPB=[],this.fBPBModified=!1,this.hash="none","string"==typeof t)try{t=JSON.parse(t)}catch(i){try{t=JSON.parse(t.replace(/([a-z]+):/gm,'"$1":').replace(/\/\/[^\n]*/gm,""))}catch($){this.printf(MESSAGE.ERROR,"%s\n",$.message)}}if(t){let s=t[DiskInfo.DESC.IMAGE];if(s){let n=s[DiskInfo.IMAGE.ORIGBPB];if(n&&(this.abOrigBPB=JSON.parse(n)),s.hash&&(this.hash=s.hash),!this.volTable.length&&t.volTable){let r=t.volTable;for(let a=0;a<r.length;a++)void 0==r[a].iPartition&&(r[a].iPartition=-1);this.volTable=r}this.tablesBuilt=this.fromJSON=this.buildFileTableFromJSON(t[DiskInfo.DESC.FILES])}let o=t[DiskInfo.DESC.DISKDATA]||t;if(o&&o.length){if(e){let l=o,f=Array(l.length);for(let D=0;D<l.length;D++){let I=l[D];f[D]=Array(I.length);for(let E=0;E<I.length;E++){let S=I[E];f[D][E]=Array(S.length);for(let h=0;h<S.length;h++){let x=S[h];f[D][E][h]={[DiskInfo.SECTOR.CYLINDER]:x[DiskInfo.SECTOR.CYLINDER],[DiskInfo.SECTOR.HEAD]:x[DiskInfo.SECTOR.HEAD],[DiskInfo.SECTOR.ID]:x[DiskInfo.SECTOR.ID],[DiskInfo.SECTOR.LENGTH]:x[DiskInfo.SECTOR.LENGTH],[DiskInfo.SECTOR.DATA]:x[DiskInfo.SECTOR.DATA],pattern:x.pattern}}}}o=f}let T=o;this.aDiskData=o,this.nCylinders=T.length,this.nSectors=this.cbSector=0;for(let d=0;d<T.length;d++){let c=T[d];this.nHeads=c.length;for(let A=0;A<c.length;A++){let k=c[A],_=k.length;this.nSectors?this.nSectors!=_&&this.printf(MESSAGE.DISK+MESSAGE.INFO,"%s: %d:%d has non-standard sector count: %d\n",this.diskName,d,A,_):this.nSectors=_;for(let R=0;R<k.length;R++){let C=k[R],B=0;C&&(this.rebuildSector(d,A,C),B=C[DiskInfo.SECTOR.LENGTH]),!this.cbSector&&B?this.cbSector=B:this.cbSector!=B&&this.printf(MESSAGE.DISK+MESSAGE.INFO,"%s: %d:%d:%d has non-standard sector size: %d\n",this.diskName,d,A,C?C[DiskInfo.SECTOR.ID]:R+1,B),this.cbDiskData+=B}}}return!0}}return!1}buildDiskFromPSI(t){this.aDiskData=null,this.cbDiskData=0,this.abOrigBPB=[],this.fBPBModified=!1;let e=[],i=0,$=t.length,s,n=0,r,a=function(e,i){let $=0;for(let s=e;s<i;s++){$^=t.readUInt8(s)<<24;for(let n=0;n<8;n++)2147483648&$?$=$<<1^517762881:$<<=1}return 0|$},o=function(){n&&(i+=n+12),s=t.readUInt32BE(i),n=t.readUInt32BE(i+4);let e=t.readInt32BE(i+8+n),$=a(i,i+8+n);e==$?r=t.slice(i+8,i+8+n):(this.printf(MESSAGE.WARNING,"chunk 0x%x at 0x%x: CRC 0x%x != calculated CRC 0x%x\n",s,i,e,$),s=1162757152)};o(),1347635488!=s&&(this.printf(MESSAGE.WARNING,"missing PSI header\n"),$=0);let l=r.readUInt16BE(0),f=r.readUInt16BE(2),D,I,E,S,h,x,T,d,c;for(this.printf(MESSAGE.INFO,"file format: 0x%04x\nsector format: 0x%02x 0x%02x\n",l,f>>8,255&f);i<$;){switch(o(),s){case 1397048148:for(D=r.readUInt16BE(0),I=r.readUInt8(2),E=r.readUInt8(3),S=r.readUInt16BE(4),h=r.readUInt8(6),x=r.readUInt8(7),T={[DiskInfo.SECTOR.CYLINDER]:D,[DiskInfo.SECTOR.HEAD]:I,[DiskInfo.SECTOR.ID]:E,[DiskInfo.SECTOR.LENGTH]:S,[DiskInfo.SECTOR.DATA]:[]},d=0,c=S>>2,this.printf(MESSAGE.DEBUG,"SECT: %d:%d:%d %d bytes, flags 0x%x, pattern 0x%02x\n",D,I,E,S,h,x);e.length<D+1;)e.push([]);for(;e[D].length<I+1;)e[D].push([]);e[D][I].push(T),1&h&&(T[DiskInfo.SECTOR.DATA][d++]=x|x<<8|x<<16|x<<24),4&h&&(T[DiskInfo.SECTOR.DATA_ERROR]=-1),-6&h&&this.printf(MESSAGE.WARNING,"unsupported flags: 0x%x\n",h),this.cbDiskData+=S;break;case 1145132097:if(this.printf(MESSAGE.DEBUG,"DATA: %d bytes\n",r.length),!T){this.printf(MESSAGE.ERROR,"no sector defined, aborting\n"),s=0;break}d&&(this.printf(MESSAGE.WARNING,"sector with data and pattern\n"),d=0);for(let A=0;A<r.length;A+=4)d>=c&&this.printf(MESSAGE.WARNING,"data for sector offset %d exceeds sector length\n",4*d,S),T[DiskInfo.SECTOR.DATA][d++]=r.readUInt8(A)|r.readUInt8(A+1)<<8|r.readUInt8(A+2)<<16|r.readUInt8(A+3)<<24;d<c&&this.printf(MESSAGE.WARNING,"sector data stops at offset %d instead of %d\n",4*d,S);break;case 1229081933:this.printf(MESSAGE.DEBUG,"IBMM: at 0x%x\n",i);break;case 1330005587:this.printf(MESSAGE.DEBUG,"OFFS: at 0x%x\n",i);break;case 1413830740:this.printf(MESSAGE.DEBUG,"TEXT: at 0x%x\n",i);break;case 1162757152:s=0,this.aDiskData=e;break;default:this.printf(MESSAGE.WARNING,"unrecognized chunk at 0x%x: 0x%08x\n",i,s),s=0}if(!s)break}return!!this.aDiskData}buildFileTableFromJSON(t){if(t){if(!this.fileTable.length){for(let e=0;e<t.length;e++){let i=t[e],$=i[DiskInfo.FILEDESC.VOL]||0,s=this.device.getBaseName(i[DiskInfo.FILEDESC.PATH],!1,!0),n=i[DiskInfo.FILEDESC.PATH].replace(/\//g,"\\"),r=+i[DiskInfo.FILEDESC.ATTR],a=this.device.parseDate(i[DiskInfo.FILEDESC.DATE],!0),o=i[DiskInfo.FILEDESC.SIZE]||0,l=new FileInfo(this,$,n,s,r,a,o);l.index=e,t[e]=l;let f=i[DiskInfo.FILEDESC.HASH];f&&(l.hash=f)}this.fileTable=t}return!0}return!1}buildTables(t){if(!this.fileTable.length&&!this.tablesBuilt||t){this.tablesBuilt=!0,this.deleteTables();let e=this.getSector(0);if(!e)return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"unable to read %s boot sector\n",this.diskName),-1;let i=0;for(;;){let $=this.buildVolume(i,e);if(!$||$.iPartition<0)break;i++}let s=[];if(this.aFileData){let n=function(t){for(let e=0;e<t.length;e++){let i=t[e];i.cluster&&(s[i.cluster]={origin:i.path,contents:i.data.buffer}),i.files&&n(i.files)}};n(this.aFileData)}for(let r=0;r<this.fileTable.length;r++){let a=this.fileTable[r],o=0;if("."!=a.name&&".."!=a.name){if(a.cluster){let l=s[a.cluster];l&&(a.origin=l.origin,a.contents=l.contents)}for(let f=0;f<a.aLBA.length;f++)this.updateSector(r,o,a.aLBA[f])||this.printf(MESSAGE.DISK+MESSAGE.ERROR,"unable to map %s sector to offset %d\n",a.name,o),o+=this.cbSector;a.loadSymbols()}}}return this.fileTable.length}buildVolume(t,e){let i=0,$=this.nCylinders*this.nHeads*this.nSectors*this.cbSector,s={iVolume:t,iPartition:-1,idMedia:0,lbaStart:0,lbaTotal:0};if(0==t&&(s.idMedia=this.getSectorData(e,DiskInfo.BPB.MEDIA,1),s.cbSector=this.getSectorData(e,DiskInfo.BPB.SECBYTES,2),s.cbSector!=this.cbSector||!this.checkMediaID(s.idMedia))){s.idMedia=0,s.vbaFAT=1,s.nFATBits=12,s.cbSector,this.cbSector,i=this.getClusterEntry(s,0,0);for(let n=0;n<DiskInfo.aDefaultBPBs.length;n++){let r=DiskInfo.aDefaultBPBs[n];if(r[DiskInfo.BPB.MEDIA]==i||!r[DiskInfo.BPB.MEDIA]&&i>=248){let a=(r[DiskInfo.BPB.DISKSECS]+256*r[DiskInfo.BPB.DISKSECS+1])*this.cbSector;if(a==$&&($<=368640||!r[DiskInfo.BPB.MEDIA])){s.idMedia=i,s.vbaRoot=s.vbaFAT+r[DiskInfo.BPB.FATSECS]*r[DiskInfo.BPB.FATS],s.clusSecs=r[DiskInfo.BPB.CLUSSECS],s.lbaTotal=a/this.cbSector,s.rootEntries=r[DiskInfo.BPB.DIRENTS],s.cbSector=this.cbSector;break}}}}let o=0;if(!s.idMedia){i=0,s.nFATBits=0,s.cbSector=this.cbSector;let l,f=48,D=0,I=0;for(let E=0;E<=1;E++){for(l=0;l<4;){let S,h=DiskInfo.MBR.PARTITIONS.OFFSET+l*DiskInfo.MBR.PARTITIONS.ENTRY_LENGTH,x=this.getSectorData(e,h+DiskInfo.MBR.PARTITIONS.ENTRY.STATUS,1);if(x==DiskInfo.MBR.PARTITIONS.STATUS.ACTIVE||x==DiskInfo.MBR.PARTITIONS.STATUS.INACTIVE){let T=this.getSectorData(e,h+DiskInfo.MBR.PARTITIONS.ENTRY.TYPE,1);if((T==DiskInfo.MBR.PARTITIONS.TYPE.FAT12_PRIMARY||T==DiskInfo.MBR.PARTITIONS.TYPE.FAT16_PRIMARY||T==DiskInfo.MBR.PARTITIONS.TYPE.FAT16_BIG)&&0==E&&o++==t){if(S=this.getSectorData(e,h+DiskInfo.MBR.PARTITIONS.ENTRY.VBA_FIRST,4),s.lbaStart=S+D,!(e=this.getSector(s.lbaStart)))break;this.getSectorData(e,DiskInfo.BPB.SECBYTES,2)!=this.cbSector&&(e=null),s.nFATBits=T==DiskInfo.MBR.PARTITIONS.TYPE.FAT12_PRIMARY?12:16;break}if(T==DiskInfo.MBR.PARTITIONS.TYPE.EXTENDED&&1==E){if(D=(S=this.getSectorData(e,h+DiskInfo.MBR.PARTITIONS.ENTRY.VBA_FIRST,4))+I,I||(I=D),!(e=this.getSector(D)))break;l=E=0;continue}}l++}if(l<4||!--f)break}if(!e||4==l)return t||this.printf(MESSAGE.DISK+MESSAGE.WARNING,"%d-byte %s disk image contains unknown volume(s)\n",$,this.diskName),null;s.sectorFATCache=null}if(s.iPartition=o-1,s.lbaTotal||(s.idMedia=this.getSectorData(e,DiskInfo.BPB.MEDIA,1),s.lbaTotal=this.getSectorData(e,DiskInfo.BPB.DISKSECS,2)||this.getSectorData(e,DiskInfo.BPB.LARGESECS,4),s.vbaFAT=this.getSectorData(e,DiskInfo.BPB.RESSECS,2),s.vbaRoot=s.vbaFAT+this.getSectorData(e,DiskInfo.BPB.FATSECS,2)*this.getSectorData(e,DiskInfo.BPB.FATS,1),s.rootEntries=this.getSectorData(e,DiskInfo.BPB.DIRENTS,2),s.clusSecs=this.getSectorData(e,DiskInfo.BPB.CLUSSECS,1)),s.vbaData=s.vbaRoot+((s.rootEntries*DiskInfo.DIRENT.LENGTH+(s.cbSector-1))/s.cbSector|0),s.clusTotal=(s.lbaTotal-s.vbaData)/s.clusSecs|0,s.nFATBits&&(12==s.nFATBits&&s.clusTotal>DiskInfo.FAT12.MAX_CLUSTERS||16==s.nFATBits&&s.clusTotal<=DiskInfo.FAT12.MAX_CLUSTERS)&&this.printf(MESSAGE.DISK+MESSAGE.ERROR,"%s volume %d %d-bit FAT inconsistent with cluster total (%d)\n",this.diskName,t,s.nFATBits,s.clusTotal),s.nFATBits=s.clusTotal<=DiskInfo.FAT12.MAX_CLUSTERS?12:16,s.clusMax=12==s.nFATBits?DiskInfo.FAT12.CLUSNUM_MAX:DiskInfo.FAT16.CLUSNUM_MAX,i||(i=this.getClusterEntry(s,0,0)),i!=s.idMedia)return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"%s volume %d FAT ID (%#0bx) does not match media ID (%#0bx)\n",this.diskName,t,i,s.idMedia),null;this.printf(MESSAGE.DISK+MESSAGE.DEBUG,"%s:\n  vbaFAT: %d\n  vbaRoot: %d\n  vbaData: %d\n  lbaTotal: %d\n  clusSecs: %d\n  clusTotal: %d\n",this.diskName,s.vbaFAT,s.vbaRoot,s.vbaData,s.lbaTotal,s.clusSecs,s.clusTotal);let d=(s.lbaTotal-s.vbaData)%s.clusSecs;d&&this.printf(MESSAGE.DISK+MESSAGE.DEBUG,"%s volume %d contains %d sectors, wasting %d sectors\n",this.diskName,t,s.lbaTotal,d),this.assert(!(s.rootEntries*DiskInfo.DIRENT.LENGTH%s.cbSector)),this.volTable.push(s);let c=[];for(let A=s.vbaRoot;A<s.vbaData;A++)c.push(s.lbaStart+A);this.getDir(s,c),s.clusBad=0,s.clusFree=0;for(let k=2;k<s.clusTotal+2;k++){let _=this.getClusterEntry(s,k,0)|this.getClusterEntry(s,k,1);_?_==s.clusMax+1&&s.clusBad++:s.clusFree++}return this.printf(MESSAGE.DISK+MESSAGE.DEBUG,"%s volume %d: %d cluster(s) bad, %d cluster(s) free, %d bytes free\n",this.diskName,t,s.clusBad,s.clusFree,s.clusFree*s.clusSecs*s.cbSector),s}checkMediaID(t){for(let e in DiskInfo.FAT)if(t==DiskInfo.FAT[e])return!0;return!1}deleteTables(){if(this.fileTable.length){let t=this.aDiskData;for(let e=0;e<t.length;e++)for(let i=0;i<t[e].length;i++)for(let $=0;$<t[e][i].length;$++){let s=t[e][i][$];s&&(delete s[DiskInfo.SECTOR.FILE_INDEX],delete s[DiskInfo.SECTOR.FILE_OFFSET],delete s.iModify,delete s.cModify)}}this.fileTable=[],this.volTable=[]}getFileDesc(t,e,i){let $=null,s={[DiskInfo.FILEDESC.HASH]:t.hash,[DiskInfo.FILEDESC.PATH]:t.path.replace(/\\/g,"/"),[DiskInfo.FILEDESC.NAME]:t.name,[DiskInfo.FILEDESC.ATTR]:this.device.sprintf("%#0bx",t.attr),[DiskInfo.FILEDESC.DATE]:this.device.sprintf("%T",t.date),[DiskInfo.FILEDESC.SIZE]:t.size,[DiskInfo.FILEDESC.VOL]:t.iVolume};if(t.size&&!(t.attr&DiskInfo.ATTR.METADATA)&&(e||i)&&(this.assert("."!=t.name[0]),t.contents?$=t.contents:($=Array(t.size),this.readSectorArray(t,$))),e?(s[DiskInfo.FILEDESC.CONTENTS]=$,t.origin&&(s[DiskInfo.FILEDESC.ORIGIN]=t.origin)):(delete s[DiskInfo.FILEDESC.NAME],!t.size&&t.attr&DiskInfo.ATTR.SUBDIR|DiskInfo.ATTR.VOLUME&&delete s[DiskInfo.FILEDESC.SIZE],t.iVolume||delete s[DiskInfo.FILEDESC.VOL]),t.module&&(s[DiskInfo.FILEDESC.MODULE]={[DiskInfo.FILEDESC.MODNAME]:t.module,[DiskInfo.FILEDESC.MODDESC]:t.modDesc,[DiskInfo.FILEDESC.MODSEGS]:t.segments}),i&&$){let n=i($);s[DiskInfo.FILEDESC.HASH]&&n!=s[DiskInfo.FILEDESC.HASH]&&this.printf(MESSAGE.DISK+MESSAGE.WARNING,"%s original hash (%s) does not match current hash (%s)\n",s[DiskInfo.FILEDESC.PATH],s[DiskInfo.FILEDESC.HASH],n),s[DiskInfo.FILEDESC.HASH]=n}else s[DiskInfo.FILEDESC.HASH]||delete s[DiskInfo.FILEDESC.HASH];return s}getFileListing(t=-1,e=0,i){let $="";if(this.buildTables()>0){let s=this.volTable.length;t<0?t=0:s=1;let n=" ".repeat(e),r="dir"!=i&&"sorted"!=i&&"metadata"!=i?RegExp("^"+i.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/\?/g,".")+"$","i"):null;for(;t<this.volTable.length&&s-- >0;){let a=this.volTable[t],o=-1,l=null,f=0,D=0,I=0,E=0,S=(function(t,e){return this.device.sprintf("%s %8d file(s)   %8d bytes\n",n,t,e)}).bind(this),h,x="",T="?",d=this.fileTable;"sorted"==i&&(d=this.fileTable.slice(0)).sort(function(t,e){return t.path<e.path?-1:t.path>e.path?1:0});let c=!1,A=!r;for(h=0;h<d.length;h++){let k=d[h];if(k.iVolume>t)break;if(k.iVolume==t){if(!A&&"."!=k.name&&".."!=k.name&&k.name.match(r)&&(A=!0),k.path.lastIndexOf("\\")>0&&(c=!0,!r))break;k.attr&DiskInfo.ATTR.VOLUME&&!c&&(x=k.name)}}for(h=0;h<d.length&&A;h++){let _=d[h];if(_.iVolume!=t||_.attr&DiskInfo.ATTR.VOLUME||_.attr&DiskInfo.ATTR.METADATA&&"metadata"!=i)continue;if(o!=_.iVolume){let R=this.volTable[_.iVolume];T=String.fromCharCode(R.iPartition<0?65:67+R.iPartition),o=_.iVolume}let C=_.name,B="",u=_.path.lastIndexOf("\\"),b=_.path.substring(0,u);b||(b="\\"),"."!=C[0]&&(u=C.indexOf("."))>0&&(B=C.substr(u+1),C=C.substr(0,u)),l!=b&&(null!=l?$+=S(D,f):$+=this.device.sprintf("\n%s Volume in drive %s %s%s",n,T,x?"is ":"has no label",x),l=b,$+=this.device.sprintf("\n%s Directory of %s:%s\n\n",n,T,b),f=D=0);let O;if(_.attr&DiskInfo.ATTR.SUBDIR)O="<DIR>    ";else{if(r&&!_.name.match(r))continue;O=this.device.sprintf("%9d",_.size),f+=_.size,I+=_.size}let F="",g="";_.date.getFullYear()>=1980&&(F=this.device.sprintf("  %2M-%02D-%0.2Y",_.date),(_.date.getHours()||_.date.getMinutes()||_.date.getSeconds())&&(g=this.device.sprintf("  %2G:%02N%.1A",_.date))),$+=this.device.sprintf("%s%-8s %-3s%s%s%s%s\n",n,C,B,_.attr&(DiskInfo.ATTR.READONLY|DiskInfo.ATTR.HIDDEN|DiskInfo.ATTR.SYSTEM)?"*":" ",O,F,g),E++,D++}A&&($+=S(D,f),E>D&&($+="\n"+n+"Total files listed:\n",$+=S(E,I)),$+=this.device.sprintf("%s%28d bytes free\n",n,a.clusFree*a.clusSecs*this.cbSector)),t++}!$&&r&&($="file not found: "+i+"\n")}return $}getFileManifest(t,e=!1,i=!1,$=!0){let s=[];if(this.buildTables()>0){for(let n=0;n<this.fileTable.length;n++){let r=this.fileTable[n];"."!=r.name&&".."!=r.name&&(!(r.attr&DiskInfo.ATTR.METADATA)||i)&&s.push(this.getFileDesc(r,$,t))}e&&s.sort(function(t,e){return t.path<e.path?-1:t.path>e.path?1:0})}return s}getModuleInfo(t,e){let i={};for(let $=0;$<this.fileTable.length;$++){let s=this.fileTable[$];if(s.sModule!=t)continue;let n=s.aSegments[e];if(n){for(let r in n.entries){let a=n.entries[r];i[a[1]]=a[0]}break}}return i}getSymbolInfo(t){let e=[],i=t.toUpperCase();for(let $=0;$<this.fileTable.length;$++){let s=this.fileTable[$];for(let n in s.aSegments){let r=s.aSegments[n];for(let a in r.entries){let o=r.entries[a];o[1]&&o[1].indexOf(i)>=0&&e.push([o[1],s.name,n,o[0],r.offEnd-r.offStart])}}}return e}getVolDesc(t,e){let i={[DiskInfo.VOLDESC.PARTITION]:t.iPartition,[DiskInfo.VOLDESC.MEDIA_ID]:t.idMedia,[DiskInfo.VOLDESC.LBA_VOL]:t.lbaStart,[DiskInfo.VOLDESC.LBA_TOTAL]:t.lbaTotal,[DiskInfo.VOLDESC.FAT_ID]:t.nFATBits,[DiskInfo.VOLDESC.VBA_FAT]:t.vbaFAT,[DiskInfo.VOLDESC.VBA_ROOT]:t.vbaRoot,[DiskInfo.VOLDESC.ROOT_TOTAL]:t.rootEntries,[DiskInfo.VOLDESC.VBA_DATA]:t.vbaData,[DiskInfo.VOLDESC.CLUS_SECS]:t.clusSecs,[DiskInfo.VOLDESC.CLUS_MAX]:t.clusMax,[DiskInfo.VOLDESC.CLUS_BAD]:t.clusBad,[DiskInfo.VOLDESC.CLUS_FREE]:t.clusFree,[DiskInfo.VOLDESC.CLUS_TOTAL]:t.clusTotal};return!e&&t.iPartition<0&&delete i[DiskInfo.VOLDESC.PARTITION],i}getDate(t,e,i){let $=0,s=(t>>9)+1980,n=(t>>5&15)-1,r=31&t,a=e>>11,o=e>>5&63,l=(31&e)<<1,f=n,D=r,I=a,E=o,S=l;return(t||e)&&f<0&&(f=0,$++),f>11&&(f=11,$++),(t||e)&&D<1&&(D=1,$++),D>31&&(D=31,$++),I>23&&(I=23,$++),E>59&&(E=59,$++),S>59&&(S=59,$++),$&&this.printf(MESSAGE.DISK+MESSAGE.WARNING,"%s has invalid timestamp: %04d-%02d-%02d %02d:%02d:%02d\n",i,s,n,r,a,o,l),new Date(s,f,D,I,E,S)}getDir(t,e,i={},$=""){let s,n=this.fileTable.length,r=t.cbSector/DiskInfo.DIRENT.LENGTH|0;i.path=$+"\\",this.printf(MESSAGE.DEBUG+MESSAGE.DISK,'getDir("%s","%s")\n',this.diskName,i.path);for(let a=0;a<e.length;a++){let o=e[a];for(let l=0;l<r;l++){if(!this.getDirEntry(t,i,o,l)){a=e.length;break}if(null==i.name||i.attr==DiskInfo.ATTR.LFN)continue;let f=CharSet.fromCP437(i.name),D=CharSet.fromCP437(i.path)+f,I=this.getDate(i.modDate,i.modTime,this.diskName+":"+D);(s=new FileInfo(this,t.iVolume,D,f,i.attr,I,i.size,i.cluster,i.aLBA)).index=this.fileTable.length,this.fileTable.push(s)}}let E=this.fileTable.length;for(let S=n;S<E;S++)(s=this.fileTable[S]).attr&DiskInfo.ATTR.SUBDIR&&s.aLBA.length&&"."!=s.name&&".."!=s.name&&this.getDir(t,s.aLBA,i,$+"\\"+s.name)}getDirEntry(t,e,i,$){if(t.sectorDirCache&&t.lbaDirCache&&t.lbaDirCache==i||(t.lbaDirCache=i,t.sectorDirCache=this.getSector(t.lbaDirCache)),t.sectorDirCache){let s=$*DiskInfo.DIRENT.LENGTH,n=this.getSectorData(t.sectorDirCache,s,1);if(n==DiskInfo.DIRENT.UNUSED)return!1;if(n==DiskInfo.DIRENT.INVALID)return e.name=null,!0;e.attr=this.getSectorData(t.sectorDirCache,s+DiskInfo.DIRENT.ATTR,1),e.name=this.getSectorString(t.sectorDirCache,s+DiskInfo.DIRENT.NAME,8);let r=this.getSectorString(t.sectorDirCache,s+DiskInfo.DIRENT.EXT,3);return e.attr&DiskInfo.ATTR.VOLUME?e.name=(e.name+r).trim():(e.name=e.name.trimEnd(),(r=r.trimEnd()).length&&(e.name+="."+r)),e.modDate=this.getSectorData(t.sectorDirCache,s+DiskInfo.DIRENT.MODDATE,2),e.modTime=this.getSectorData(t.sectorDirCache,s+DiskInfo.DIRENT.MODTIME,2),e.size=this.getSectorData(t.sectorDirCache,s+DiskInfo.DIRENT.SIZE,4),e.size<0&&(e.size=0),e.cluster=this.getSectorData(t.sectorDirCache,s+DiskInfo.DIRENT.CLUSTER,2),e.aLBA=this.convertClusterToSectors(t,e),!0}return!1}convertClusterToSectors(t,e){let i=[],$=e.cluster;if($){for(;$<=t.clusMax&&!($<DiskInfo.FAT12.CLUSNUM_MIN);){let s=t.vbaData+($-DiskInfo.FAT12.CLUSNUM_MIN)*t.clusSecs;for(let n=0;n<t.clusSecs;n++)i.push(t.lbaStart+s++);$=this.getClusterEntry(t,$,0)|this.getClusterEntry(t,$,1)}($<DiskInfo.FAT12.CLUSNUM_MIN||$==t.clusMax+1)&&this.printf(MESSAGE.DISK+MESSAGE.WARNING,"%s %s contains invalid cluster (%d)\n",this.diskName,e.name,$)}return i}getClusterEntry(t,e,i){let $=0,s=8*t.cbSector,n=t.nFATBits*e+(i?8:0),r=n/s|0;if(t.sectorFATCache&&t.vbaFATCache&&t.vbaFATCache==t.vbaFAT+r||(t.vbaFATCache=t.vbaFAT+r,t.sectorFATCache=this.getSector(t.lbaStart+t.vbaFATCache)),t.sectorFATCache){let a=(n=n%s|0)>>3;$=this.getSectorData(t.sectorFATCache,a,1),i?16==t.nFATBits?$<<=8:(this.assert(12==t.nFATBits),7&n?$<<=4:$=(15&$)<<8):7&n&&($>>=4)}return $}getCHS(t){let e,i=0,$=0,s=this.nHeads*this.nSectors;if((e=t/s|0)<this.nCylinders){let n=t%s;i=n/this.nSectors|0,$=n%this.nSectors+1}return[e,i,$]}getSector(t){let[e,i,$]=this.getCHS(t);return this.seek(e,i,$)}getSectorArray(t){let e=0;if(this.fileTable.length&&(!t||t.size>0&&!t.aLBA)){let i=this.aDiskData,$=0;for(let s=0;s<i.length;s++)for(let n=0;n<i[s].length;n++)for(let r=0;r<i[s][n].length;r++){let a=i[s][n][r];if(a){let o=a[DiskInfo.SECTOR.FILE_INDEX];if(void 0!=o){let l=this.fileTable[o];this.assert(l),l.aLBA||(l.aLBA=[]);let f=a[DiskInfo.SECTOR.FILE_OFFSET]/this.cbSector;Device.DEBUG&&this.assert(void 0==l.aLBA[f]||l.aLBA[f]==f),l.aLBA[f]=$,(!t||t.index==o)&&e++}}$++}}return e}getUnusedSector(t,e){let i=-1;if(t<0&&(t=0),this.volTable.length&&t>=0&&t<this.volTable.length){if(!(i=e+1)){let $=this.volTable[t];i=$.lbaStart+$.vbaData}let s;for(;(s=this.getSector(i))&&!(this.getUnusedSectorData(s)>=0);)i++;s||(i=-1)}return i}getUnusedSectorData(t){let e=0,i=t[DiskInfo.SECTOR.FILE_INDEX];if(void 0!=i){let $=this.fileTable[i];if($){let s=t[DiskInfo.SECTOR.FILE_OFFSET];(e=$.size-s)>=this.cbSector&&(e=-1)}}return e}readSectorArray(t,e){let i=0,$=0,s=e.length;if(t.aLBA||this.getSectorArray(t),t.aLBA)for(;s>0&&i>=0&&i<t.aLBA.length;){let n=this.getSector(t.aLBA[i++]);if(!n)break;let r=n[DiskInfo.SECTOR.LENGTH],a=s>r?r:s;for(let o=0;o<a;o++){let l=this.read(n,o);if(l<0){i=-1;break}e[$++]=l,s--}}return e.length-s}getSectorData(t,e,i){let $=0,s=0;for(this.assert(i>0&&i<=4);i--;){this.assert(e<t[DiskInfo.SECTOR.LENGTH]);let n=this.read(t,e++);if(this.assert(n>=0),n<0)break;$|=n<<s,s+=8}return $}getSectorString(t,e,i){let $="";for(;i--;){let s=this.read(t,e++);if(s<=0)break;$+=String.fromCharCode(s)}return $}updateSector(t,e,i){let $,s,n,[r,a,o]=this.getCHS(i);if(($=this.aDiskData[r])&&(s=$[a])&&(n=s[o-1])){let l=this.fileTable[t];if(n[DiskInfo.SECTOR.ID]!=o&&this.printf(MESSAGE.DISK+MESSAGE.WARNING,"%d:%d:%d has non-standard sector ID %d; see file %s\n",r,a,o,n[DiskInfo.SECTOR.ID],l.path),void 0!=n[DiskInfo.SECTOR.FILE_INDEX]&&(n[DiskInfo.SECTOR.FILE_INDEX]!=t||n[DiskInfo.SECTOR.FILE_OFFSET]!=e)){let f=this.fileTable[n[DiskInfo.SECTOR.FILE_INDEX]];return this.printf(MESSAGE.DISK+MESSAGE.WARNING,'"%s" cross-linked at offset %d with "%s" at offset %d\n',f.path,n[DiskInfo.SECTOR.FILE_OFFSET],l.path,e),!1}return n[DiskInfo.SECTOR.FILE_INDEX]=t,n[DiskInfo.SECTOR.FILE_OFFSET]=e,!0}return this.printf(MESSAGE.DISK+MESSAGE.ERROR,"unable to map %s LBA %d to CHS\n",this.diskName,i),!1}buildSector(t,e,i,$,s,n=0){let r=[],a=$>>2;for(let o=0;o<a;o++,n+=4)r[o]=s&&n<s.length?s.readInt32LE(n):0;let l={[DiskInfo.SECTOR.CYLINDER]:t,[DiskInfo.SECTOR.HEAD]:e,[DiskInfo.SECTOR.ID]:i,[DiskInfo.SECTOR.LENGTH]:$,[DiskInfo.SECTOR.DATA]:r};return this.initSector(l,r,$,0)}rebuildSector(t,e,i){void 0!=i[DiskInfo.SECTOR.CYLINDER]&&(this.assert(i[DiskInfo.SECTOR.CYLINDER]==t),delete i[DiskInfo.SECTOR.CYLINDER]),void 0!=i[DiskInfo.SECTOR.HEAD]&&(this.assert(i[DiskInfo.SECTOR.HEAD]==e),delete i[DiskInfo.SECTOR.HEAD]);let $=i.pattern;delete i.pattern;let s=i[DiskInfo.SECTOR.ID];void 0!=s?delete i[DiskInfo.SECTOR.ID]:($|=0,s=i.sector,delete i.sector);let n=i[DiskInfo.SECTOR.LENGTH];void 0!=n?delete i[DiskInfo.SECTOR.LENGTH]:(n=i.length||512,delete i.length);let r=i[DiskInfo.SECTOR.DATA];return r?delete i[DiskInfo.SECTOR.DATA]:(r=i.data)?delete i.data:r=[],i[DiskInfo.SECTOR.CYLINDER]=t,i[DiskInfo.SECTOR.HEAD]=e,i[DiskInfo.SECTOR.ID]=s,i[DiskInfo.SECTOR.LENGTH]=n,i[DiskInfo.SECTOR.DATA]=r,this.initSector(i,r,n,$)}initSector(t,e,i,$){let s=i>>2,n=null,r=0;for(let a=0;a<s;a++){let o=e[a];void 0==o&&(o=void 0!=$?$:e[e.length-1],e[a]=o),n===o?r++:(n=o,r=0)}e.length-=r,s=e.length<s?e.length-1:e.length;let l=0;for(let f=0;f<s;f++)l=l+e[f]&4294967295;return this.dwChecksum=(this.dwChecksum+l&4294967295)>>>0,this.fWritable&&(t.iModify=t.cModify=0),t}getData(t,e){if(this.aDiskData){let i=0,$=this.aDiskData;for(let s=0;s<$.length;s++)for(let n=0;n<$[s].length;n++)for(let r=0;r<$[s][n].length;r++){let a=$[s][n][r];if(a){let o=a[DiskInfo.SECTOR.LENGTH];for(let l=0;l<o;l++){let f=this.read(a,l);this.assert(f>=0),t.writeUInt8(f,i++)}}}if(this.abOrigBPB.length&&e){let D=this.abOrigBPB.shift();for(let I=DiskInfo.BPB.OPCODE;I<DiskInfo.BPB.LARGESECS+4;I++)t.writeUInt8(this.abOrigBPB[I-DiskInfo.BPB.OPCODE],D+I)}return this.assert(i==t.length),!0}return!1}addMetaData(t){t&&(this.aMetaData=this.aMetaData.concat(t))}getJSON(t,e=!1,i=0,$=""){let s,n;if(e)this.deleteTables();else if(this.buildTables(this.fromJSON)>=0){for(let r=0;r<this.volTable.length;r++)s||(s=[]),s.push(this.getVolDesc(this.volTable[r]));for(let a=0;a<this.fileTable.length;a++){let o=this.fileTable[a],l=this.getFileDesc(o,!1,t);n||(n=[]),n.push(JSON.stringify(l,null,0))}}let f={[DiskInfo.IMAGE.TYPE]:DiskInfo.TYPE.CHS,[DiskInfo.IMAGE.NAME]:this.diskName,[DiskInfo.IMAGE.FORMAT]:this.getFormat(),[DiskInfo.IMAGE.HASH]:this.hash,[DiskInfo.IMAGE.CHECKSUM]:this.dwChecksum,[DiskInfo.IMAGE.CYLINDERS]:this.nCylinders,[DiskInfo.IMAGE.HEADS]:this.nHeads,[DiskInfo.IMAGE.TRACKDEF]:this.nSectors,[DiskInfo.IMAGE.SECTORDEF]:this.cbSector,[DiskInfo.IMAGE.DISKSIZE]:this.cbDiskData,[DiskInfo.IMAGE.ORIGBPB]:JSON.stringify(this.abOrigBPB),[DiskInfo.IMAGE.VERSION]:"2.10",[DiskInfo.IMAGE.REPOSITORY]:Device.REPOSITORY};this.fBPBModified||delete f[DiskInfo.IMAGE.ORIGBPB],$&&(f[DiskInfo.IMAGE.SOURCE]=$);let D=JSON.stringify(f,null,i+2),I,E;s&&(I=JSON.stringify(s,null,i+1)),n&&(E="",n.forEach(t=>{E&&(E+=",\n"),E+="  "+t}),this.aMetaData&&this.aMetaData.forEach(t=>{E&&(E+=",\n");E+="  "+JSON.stringify(this.getFileDesc(t,!1),null,0)}),E="[\n"+E+"\n]");let S=JSON.stringify(this.aDiskData,null,i);return i||(S=S.replace(/\{/g,"\n  {")),'{\n"'+DiskInfo.DESC.IMAGE+'": '+D+',\n"'+(I?DiskInfo.DESC.VOLUMES+'": '+I+',\n"':"")+(E?DiskInfo.DESC.FILES+'": '+E+',\n"':"")+DiskInfo.DESC.DISKDATA+'":'+S+"\n}"}findFile(t,e=!0){let i=null;if(this.buildTables()>0&&(t=t.toUpperCase(),this.fileTable))for(let $=0;$<this.fileTable.length;$++){let s=this.fileTable[$];if(t==s.name){i=this.getFileDesc(s,!!e);break}}return i}getChecksum(){return this.dwChecksum}static findDriveType(t,e,i){if(t.driveCtrl){let $=DRIVE_CTRLS.indexOf(t.driveCtrl);if($>=0){let s=-1,n=0,r,a=Object.keys(DRIVE_TYPES[$]);for(let o of a){let l=DRIVE_TYPES[$][o].slice();l.unshift(+o),l[3]=l[3]||17,l[4]=l[4]||512;let f=l[1]*l[2]*l[3],D=l[4],I,E;512==D&&(I=f*D,l[5]=I/1024/1024,i&&i.printf(MESSAGE.DISK+MESSAGE.DEBUG,"%s drive type %2d: %4d cylinders, %2d heads, %2d sectors/track (%5sMb)%s\n",t.driveCtrl,l[0],l[1],l[2],l[3],l[5].toFixed(1),t.driveType==l[0]?"*":""),t.driveType>=0?t.driveType==l[0]&&(s=l[0],r=l):(e&&(E=Math.abs(f-e))&&(E<n||s<0)||!e&&(E=Math.abs(512*f-1.1*I))&&(E<n||s<0))&&(n=E,s=l[0],r=l))}if(s>=0)return t.driveType=s,t.nCylinders=r[1],t.nHeads=r[2],t.nSectors=r[3],t.cbSector=r[4],t.driveSize=r[5],!0}else if(t.partitioned){if("PCJS"==t.driveCtrl){if(e){let S,h,x,T=-6;do{if((T+=23)>63)return!1;h=Math.trunc((x=Math.trunc(e/T))/1024)||1,h+=1&h,S=Math.trunc(x/h)}while(h>16||S>1024);let d=S*h*T*512;return t.driveType=0,t.nCylinders=S,t.nHeads=h,t.nSectors=T,t.cbSector=512,t.driveSize=d/1024/1024,!0}if(0==t.driveType)return t.cbSector||(t.cbSector=512),t.driveSize=t.nCylinders*t.nHeads*t.nSectors*t.cbSector/1024/1024,!0}}else if(t.driveType>=0)return!0}return!1}getDriveType(t){let e=!1;if(this.cbDiskData){let i=this.driveCtrl||t.driveCtrl,$=this.driveType;if($<0){let s=this.getSector(0);if((s&&this.getSectorData(s,DiskInfo.MBR.PCJS_SIG,4))==DiskInfo.PCJS_VALUE){let n=this.getSectorData(s,DiskInfo.MBR.DRIVE0PARMS.CYLS,2);n&&(this.assert(this.nCylinders==n),this.assert(this.nHeads==this.getSectorData(s,DiskInfo.MBR.DRIVE0PARMS.HEADS,1)),this.assert(this.nSectors==this.getSectorData(s,DiskInfo.MBR.DRIVE0PARMS.SECTORS,1)),i="")}let r=DRIVE_CTRLS.indexOf(i);if(r>=0){let a=Object.keys(DRIVE_TYPES[r]);for(let o of a){let l=DRIVE_TYPES[r][o];if(this.nCylinders==l[0]&&this.nHeads==l[1]&&this.nSectors==(l[2]||17)){$=+o;break}}}$<0&&(i="PCJS",$=0)}t.driveCtrl=i,t.driveType=$,t.nCylinders=this.nCylinders,t.nHeads=this.nHeads,t.nSectors=this.nSectors,t.cbSector=this.cbSector||512,t.driveSize=this.cbDiskData/1024/1024,e=!0}return e}static validateDriveType(t,e){let i=null,$=DRIVE_CTRLS.indexOf(t);if($>=0){let s=DRIVE_TYPES[$][e];if(s){let n=s[0],r=s[1],a=s[2]||17,o=s[3]||512;i={driveCtrl:t,driveType:e,nCylinders:n,nHeads:r,nSectors:a,cbSector:o,driveSize:n*r*a*o/1024/1024}}}return i}getFormat(){let t="",e="Unknown",i=[DiskInfo.SECTOR.DATA_CRC,DiskInfo.SECTOR.DATA_ERROR,DiskInfo.SECTOR.DATA_MARK,DiskInfo.SECTOR.HEAD_CRC,DiskInfo.SECTOR.HEAD_ERROR];if(this.aDiskData){let $=this.aDiskData;for(let s=0;s<$.length&&!t;s++)for(let n=0;n<$[s].length&&!t;n++)for(let r=0;r<$[s][n].length&&!t;r++){let a=$[s][n][r];if(a){if(+a[DiskInfo.SECTOR.ID]!=r+1){t="*";break}for(let o in i)if(void 0!==a[i[o]]){t="*";break}}}this.volTable.length&&(e="PC"+Math.round(this.cbDiskData/1024)+"K")}return e+t}getHash(){return this.hash}getName(){return this.diskName.replace(/\.[a-z]+$/i,"")}setName(t){t&&(this.diskName=t)}getNewestDate(t){let e;for(let i=0;i<this.fileTable.length;i++){let $=this.fileTable[i];(!t||$.name.indexOf(".COM")>0||$.name.indexOf(".EXE")>0)&&(!e||e.getTime()<$.date.getTime())&&(e=$.date)}return e}getSize(){return this.cbDiskData}setArgs(t){this.args=t}parseSuppData(t){let e={};if(t){let i=t.split(/[ \t]*MFM Sector\s*\n/);for(let $=1;$<i.length;$++){let s=i[$].match(/Sector ID:([0-9]+)[\s\S]*?Track ID:([0-9]+)[\s\S]*?Side ID:([0-9]+)[\s\S]*?Size:([0-9]+)[\s\S]*?DataMark:0x([0-9A-F]+)[\s\S]*?Head CRC:0x([0-9A-F]+)\s+\(([^)]*)\)[\s\S]*?Data CRC:0x([0-9A-F]+)\s+\(([^)]*)\)/);if(s){let n=[],r=+s[1],a=+s[2],o=+s[3],l=+s[4],f=parseInt(s[5],16),D=parseInt(s[6],16),I="Ok"!=s[7],E=parseInt(s[8],16),S="BAD CRC!"!=s[9]?0:-1,h,x=/([0-9A-F]+)\|([^|]*)\|/g;for(;h=x.exec(i[$]);){let T=0,d=0,c,A=/\s+([0-9A-F]+)/g;for(;c=A.exec(h[2]);)d|=parseInt(c[1],16)<<T,32==(T+=8)&&(n.push(d),T=d=0);T&&n.push(d)}e[a]||(e[a]={}),e[a][o]||(e[a][o]=[]);let k={sectorID:r,length:l,dataMark:f,headCRC:D,headError:I,dataCRC:E,dataError:S,data:n};e[a][o].push(k)}}}return e}read(t,e,i){let $=-1;if(t&&(!Device.DEBUG||e||i||this.printf(MESSAGE.DEBUG+MESSAGE.DISK,'read("%s",CHS=%d:%d:%d)\n',this.diskName,t[DiskInfo.SECTOR.CYLINDER],t[DiskInfo.SECTOR.HEAD],t[DiskInfo.SECTOR.ID]),e<t[DiskInfo.SECTOR.LENGTH])){let s=t[DiskInfo.SECTOR.DATA],n=e>>2;$=(n<s.length?s[n]:s[s.length-1])>>((3&e)<<3)&255}return $}seek(t,e,i,$,s){let n=null,r=this.drive,a=this.aDiskData[t];if(a){let o,l=a[e];if(!l&&r&&r.bFormatting&&e<2){for(o=0,l=Array(r.bSectorEnd);o<l.length;o++)l[o]=this.buildSector(t,e,o+1,r.nBytes);e<r.nHeads&&(a[e]=l,this.nHeads=e+1)}if(l){for(o=0;o<l.length;o++)if(l[o]&&l[o][DiskInfo.SECTOR.ID]==i){if(n=l[o],$&&$==n){let f=o,D;for(;++f>=l.length&&(f=0),(D=l[f])!=n;)if(D[DiskInfo.SECTOR.ID]==i){n=D,o=f;break}}break}!n&&r&&r.bFormatting&&9==r.bSector&&(n=l[o]=this.buildSector(t,e,r.bSector,r.nBytes),this.nSectors<r.bSector&&(this.nSectors=r.bSector))}}return s&&s(n,!1),n}write(t,e,i,$){if(!$&&!this.fWritable)return!1;if(Device.DEBUG&&!e&&this.printf(MESSAGE.DEBUG+MESSAGE.DISK,'write("%s",CHS=%d:%d:%d)\n',this.diskName,t[DiskInfo.SECTOR.CYLINDER],t[DiskInfo.SECTOR.HEAD],t[DiskInfo.SECTOR.ID]),e<t[DiskInfo.SECTOR.LENGTH]){if(i!=this.read(t,e,!0)){let s=t[DiskInfo.SECTOR.DATA],n=s[s.length-1],r=e>>2,a=(3&e)<<3;for(let o=s.length;o<=r;o++)s[o]=n;this.fWritable&&(t.cModify?r<t.iModify?(t.cModify+=t.iModify-r,t.iModify=r):r>=t.iModify+t.cModify&&(t.cModify+=r-(t.iModify+t.cModify)+1):(t.iModify=r,t.cModify=1)),s[r]=s[r]&~(255<<a)|i<<a}return!0}return null}updateBootSector(t,e=0,i=0){let $=!1;if(t&&this.buildTables()>=0){let s=-1,n=!1;if(e<0?s=0:e>=0&&e<this.volTable.length&&(n=!0,s=this.volTable[e].lbaStart),s>=0){let r=this.getSector(s);if(r){$=!0;let a=r[DiskInfo.SECTOR.LENGTH];if(n&&t.readUInt8(0)==CPUx86.OPCODE.CLD){let o=this.getSectorData(r,DiskInfo.BPB.SECBYTES,2),l=this.getSectorData(r,DiskInfo.BPB.FATS,1),f=this.getSectorData(r,DiskInfo.BPB.FATSECS,2),D=this.getSectorData(r,DiskInfo.BPB.RESSECS,2)+l*f,I=this.getSectorData(r,DiskInfo.BPB.DIRENTS,2),E=this.getSectorData(r,DiskInfo.BPB.TRACKSECS,2),S=this.getSectorData(r,DiskInfo.BPB.DRIVEHEADS,2);t.writeUInt8(0,DiskInfo.BPB.DRIVE),t.writeUInt16LE(E*S,DiskInfo.BPB.CYLSECS),t.writeUInt16LE(D,DiskInfo.BPB.LBAROOT),t.writeUInt16LE(D+(32*I+(o-1))/o|0,DiskInfo.BPB.LBADATA)}for(let h=0;h<a&&h<t.length;h++){let x=t.readUInt8(h);if(n)switch(i){case 0:if(h>=DiskInfo.BPB.BEGIN&&h<DiskInfo.BPB.END)continue;break;case 1:break;case 2:if(h>=DiskInfo.BPB.BEGIN&&h<DiskInfo.BPB.LARGESECS)continue}else if(0==s){if(h>=DiskInfo.MBR.PARTITIONS.OFFSET)continue;if(i>=0){let T=-1,d;switch(h){case DiskInfo.MBR.DRIVE1PARMS.CYLS:T++;case DiskInfo.MBR.DRIVE0PARMS.CYLS:T++,d=255&this.nCylinders;break;case DiskInfo.MBR.DRIVE1PARMS.CYLS+1:T++;case DiskInfo.MBR.DRIVE0PARMS.CYLS+1:T++,d=this.nCylinders>>8&255;break;case DiskInfo.MBR.DRIVE1PARMS.HEADS:T++;case DiskInfo.MBR.DRIVE0PARMS.HEADS:T++,d=this.nHeads;break;case DiskInfo.MBR.DRIVE1PARMS.SECTORS:T++;case DiskInfo.MBR.DRIVE0PARMS.SECTORS:T++,d=this.nSectors}T==i&&(x=d)}}if(!this.write(r,h,x,!0)){$=!1;break}}}}}return $}static nearestPowerOfTwo(t,e=1073741824){let i=1;for(;i<t&&i<e;)i<<=1;return i}}

			function downloadFile(blob, filename)
				{
				var link = document.createElement("a");
				link.style.display = "none";
				document.body.appendChild(link);
				link.href = URL.createObjectURL(blob);
				link.download = filename;
				link.click();
				}

			function convertIMG(event)
				{
				var filereader = new FileReader();

				filereader.onload = function()
					{
					var filename = event.target.files[0].name.split(".")[0];
					var extension = event.target.files[0].name.split(".").pop().toLowerCase();

					if (extension === "img")
						{
						var device = new Device();

						var diskInfo = new DiskInfo(device, "c.img");
						diskInfo.buildDiskFromBuffer(buffer.Buffer.from(filereader.result));

						var data = diskInfo.getJSON("", false, 0, "");
						downloadFile(new Blob([data]), filename + ".json");

						document.getElementById("uploader").value = null;
						}
					};

				filereader.readAsArrayBuffer(event.target.files[0]);
				}

			window.addEventListener("load", function()
				{
				document.getElementById("uploader").addEventListener("change",function(e){convertIMG(e)});
				});
		</script>
	</body>
</html>