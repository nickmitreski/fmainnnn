<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Podcast Generator Map</title>
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Include our CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- React for better UI management (though not actively used for complex components in this version) -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <!-- For step-by-step guidance, add Shepherd.js -->
    <link rel="stylesheet" href="https://unpkg.com/shepherd.js@11.1.0/dist/css/shepherd.css">
    <script src="https://unpkg.com/shepherd.js@11.1.0/dist/js/shepherd.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="toolbar">
        <button id="place-podcast-btn" class="toolbar-button special" data-tour="place">
            <div class="button-main icon-circle">
                <span class="toolbar-btn-icon"><i class="fas fa-map-marker-alt"></i></span>
                <span class="button-title">Place Podcast Area</span>
            </div>
            <p class="button-description">Click here! Start your creation by dropping a pin and creating a new podcast anywhere on the map.</p>
        </button>
        <button id="view-podcasts-btn" class="toolbar-button" data-tour="manage">
            <div class="button-main icon-circle">
                <span class="toolbar-btn-icon"><i class="fas fa-list-check"></i></span>
                <span class="button-title">Your Saved Podcasts</span>
            </div>
            <p class="button-description">Browse, edit, and listen to your own podcast areas anytime.</p>
        </button>
        <button id="guide-btn" class="toolbar-button guide-btn" data-tour="guide">
            <div class="button-main icon-circle">
                <span class="toolbar-btn-icon"><i class="fas fa-question-circle"></i></span>
                <span class="button-title">How to Use</span>
            </div>
            <p class="button-description">Step-by-step walkthrough on podcast creation, map use, and audio tools.</p>
        </button>
    </div>

    <!-- Podcast Management Modal -->
    <div id="podcast-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="podcast-modal-title">Podcast Area Details</div>

            <div id="saved-podcast-list-container">
                <h4>Saved Podcast Areas</h4>
                <div id="saved-podcast-list">
                    <ul>
                        <!-- Saved podcast list items will be rendered here -->
                    </ul>
                    <div class="no-saved-podcasts">No saved podcast areas yet. Click "Place Podcast Area" to create one.</div>
                </div>
            </div>
            
            <div id="current-podcast-details">
                <h4>Configure New or Loaded Podcast Area</h4>
                <p id="current-location-info" style="font-style: italic; color: #555;"></p>
                <div class="podcast-settings">
                    <div>
                        <label for="podcast-topic">Main Topic / What's it about? (Free Text)</label>
                        <input type="text" id="podcast-topic" placeholder="e.g., History of this park">
                    </div>
                    <div class="podcast-templates">
                        <p>Or choose from templates:</p>
                        <label><input type="checkbox" class="template-checkbox" value="Best Restaurants"> Best Restaurants</label>
                        <label><input type="checkbox" class="template-checkbox" value="Must Know Places"> Must Know Places</label>
                        <label><input type="checkbox" class="template-checkbox" value="History"> History (Parks, Buildings, Landmarks)</label>
                        <label><input type="checkbox" class="template-checkbox" value="Local Culture"> Local Culture</label>
                        <label><input type="checkbox" class="template-checkbox" value="Nature & Scenery"> Nature & Scenery</label>
                         <label><input type="checkbox" class="template-checkbox" value="Architecture"> Architecture</label>
                         <label><input type="checkbox" class="template-checkbox" value="Arts and Culture"> Arts and Culture</label>
                         <label><input type="checkbox" class="template-checkbox" value="Family Fun"> Family Fun</label>
                         <label><input type="checkbox" class="template-checkbox" value="Hidden Gems"> Hidden Gems</label>
                         <label><input type="checkbox" class="template-checkbox" value="Sports History"> Sports History</label>
                    </div>
                    <div class="podcast-visibility">
                        <label><input type="checkbox" id="podcast-public-checkbox"> Make this Podcast Area public</label>
                        <p class="button-description">Public areas are visible to everyone on the map.</p>
                    </div>
                    <div class="podcast-dynamic-content">
                        <label><input type="checkbox" id="include-news-checkbox" checked> Include Recent News & Events</label>
                    </div>
                    <div class="podcast-radius">
                        <label for="podcast-radius-value">Radius:</label>
                        <input type="number" id="podcast-radius-value" value="1" min="0.1" step="0.1">
                        <select id="podcast-radius-unit">
                            <option value="km">km</option>
                            <option value="miles">miles</option>
                        </select>
                    </div>
                    <div class="podcast-style">
                        <label for="podcast-style-select">Podcast Style/Tone:</label>
                        <select id="podcast-style-select">
                            <option value="informative">Informative</option>
                            <option value="conversational">Conversational</option>
                            <option value="historical">Historical Focus</option>
                            <option value="foodie">Foodie Guide</option>
                            <option value="travelogue">Travelogue</option>
                             <option value="storytelling">Storytelling</option>
                             <option value="upbeat">Upbeat/Energetic</option>
                             <option value="relaxed">Relaxed/Calm</option>
                        </select>
                    </div>
                     <div class="podcast-format">
                        <label for="podcast-format-select">Output Format:</label>
                        <select id="podcast-format-select">
                            <option value="summary">Summary</option>
                            <option value="script-excerpt">Script Excerpt</option>
                            <option value="interview-style">Interview Style</option>
                            <option value="documentary">Documentary</option>
                            <option value="poetic-description">Poetic Description</option>
                        </select>
                    </div>
                    <div>
                        <label for="podcast-narrators">Narrator(s) / Host and Guest Voice(s):</label>
                        <select id="podcast-narrators" multiple size="6" style="width:100%;"></select>
                        <small id="voice-selection-note" style="display:block; color: #666;">Select up to 1 host & 2 guest voices. The first is main host, the rest are guests for conversation/dialogue.</small>
                    </div>
                     <div class="podcast-detail-level">
                         <label for="podcast-detail-level">Detail Level:</label>
                         <input type="range" id="podcast-detail-level" min="1" max="10" value="5">
                         <span id="detail-level-value">5</span>
                     </div>
                </div>

                <h4>Generated Content</h4>
                <button id="generate-podcast-modal-btn"><i class="fas fa-magic"></i> <span>Generate Podcast</span></button>
                <button id="read-aloud-btn" style="display: none;"><i class="fas fa-volume-up"></i> <span>Read Aloud</span></button>
                <button id="generate-audio-btn" style="display: none;"><i class="fas fa-microphone-alt"></i> <span>Generate Audio from Edited Content</span></button>
                <div id="podcast-generation-status">Click "Generate Podcast" to create content.</div>
                <div id="podcast-generation-progress-container">
                    <div id="podcast-generation-progress"></div>
                </div>
                
                <h4>Audio Playback</h4>
                <div id="audio-status">Audio will be available after generation.</div>
                <div id="audio-progress-bar-container">
                    <div id="audio-progress-bar"></div>
                </div>
                <button id="play-podcast-modal-btn" style="display: none;"><i class="fas fa-play"></i> <span>Play Audio</span></button>

                <div id="podcast-modal-output">
                    <!-- Generated text output -->
                </div>
                
                <div id="editable-podcast-content" class="editable-content">
                    <!-- Editable paragraphs will be rendered here -->
                </div>
                
                <button id="download-podcast-btn" style="display: none;"><i class="fas fa-download"></i> <span>Download Podcast</span></button>
                <!-- Show generated audiofiles if available -->
                <div id="audiofiles-list-section" style="margin:15px 0; display:none;">
                    <h4>Generated Audio Files</h4>
                    <ul id="audiofiles-list" style="list-style:disc; padding-left:20px; margin: 10px 0;"></ul>
                </div>
                <div id="podcast-references">
                    <h4>Sources & References</h4>
                    <div id="references-table-container" style="display: none;">
                        <table id="references-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Type</th>
                                    <th>Link</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- References will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-references">References will be generated with podcast content.</div>
                </div>
                <div id="podcast-actions">
                    <button id="save-podcast-btn"><i class="fas fa-save"></i> <span>Save Podcast Area</span></button>
                    <button id="update-podcast-btn" style="display: none;"><i class="fas fa-sync-alt"></i> <span>Update Podcast Area</span></button>
                    <button id="delete-podcast-btn" style="display: none;"><i class="fas fa-trash-alt"></i> <span>Delete Podcast Area</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="download-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button" onclick="closeDownloadModal()">&times;</span>
            <h3>Download Podcast</h3>
            <p>Select download format:</p>
            <div class="download-options">
                <button onclick="downloadPodcast('mp3')"><i class="fas fa-file-audio"></i> <span>Audio (MP3)</span></button>
                <button onclick="downloadPodcast('txt')"><i class="fas fa-file-alt"></i> <span>Script (TXT)</span></button>
                <button onclick="downloadPodcast('json')"><i class="fas fa-file-code"></i> <span>Full Data (JSON)</span></button>
            </div>
        </div>
    </div>

    <!-- AI Tool Modal -->
    <div id="ai-tool-modal" class="modal">
        <div class="modal-content ai-tool-modal-content">
            <span class="close-button" onclick="closeAiToolModal()">&times;</span>
            <h3>AI Tool - Edit Paragraph</h3>
            <div class="ai-tool-form">
                <label for="ai-instruction">Enter your instruction for this paragraph:</label>
                <textarea id="ai-instruction" placeholder="e.g., make it more dramatic, add historical context, focus on architecture, make it more engaging..."></textarea>
                <div class="ai-tool-actions">
                    <button onclick="applyAiInstruction()"><i class="fas fa-check"></i> <span>Apply AI Instruction</span></button>
                    <button onclick="closeAiToolModal()"><i class="fas fa-times"></i> <span>Cancel</span></button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-footer">
        Local Podcast Generator Map by <a href="https://kosch.cloud" target="_blank">KoSch</a> using <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> and <a href="https://websim.ai" target="_blank">websim.ai</a> technology | 
        <a href="https://websim.ai/@kosch" target="_blank">Kosch on Websim</a> | 
        <a href="https://kosch.cloud" target="_blank">kosch.cloud</a>
    </div>

    <!-- Include Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n630ngoOtxivrZgo+3cnKVlG4zPKGpKaYcfringVaâ€¢"
        crossorigin=""></script>
    <!-- Include our script -->
    <script type="module" src="script.js"></script>
    <script type="text/javascript">
    // Shepherd Tour initialization, triggers when Guide button is clicked
    document.addEventListener("DOMContentLoaded", function () {
      const guideBtn = document.getElementById('guide-btn');
      let tour;
      if (guideBtn && window.Shepherd) {
        guideBtn.addEventListener('click', function () {
            if (tour) { tour.cancel(); }
            tour = new Shepherd.Tour({
                defaults: { classes: 'shepherd-theme-arrows', scrollTo: true }
            });
            // Use only steps for elements that exist to avoid TypeError on null target
            const steps = [
                {
                    id: 'intro',
                    text: 'Welcome to the Local Podcast Map! Let\'s take a quick tour so you know where to start.',
                    attachTo: { element: '#toolbar', on: 'bottom' },
                    btns: [{ text: 'Next', action: () => tour.next() }]
                },
                {
                    id: 'place-btn',
                    text: 'Click this green button to <b>place a Podcast Area</b> anywhere on the map.<br>Pick a location you want to record about!',
                    attachTo: { element: '#place-podcast-btn', on: 'bottom' },
                    btns: [{ text: 'Next', action: () => tour.next() }]
                },
                {
                    id: 'manage-btn',
                    text: 'Access all your <b>saved podcasts</b> easily here.',
                    attachTo: { element: '#view-podcasts-btn', on: 'bottom' },
                    btns: [{ text: 'Next', action: () => tour.next() }]
                },
                {
                    id: 'modal-details',
                    text: 'After placing a pin, configure your <b>topic</b>, <b>radius</b>, tone, and select one or more narrator voices. Then generate your podcast!',
                    attachTo: { element: '#current-podcast-details', on: 'top' },
                    btns: [{ text: 'Next', action: () => tour.next() }]
                },
                {
                    id: 'audio-tools',
                    text: 'Generate audio, use the "Read Aloud", and download your finished podcast from these controls.',
                    attachTo: { element: '#audio-status', on: 'top' },
                    btns: [{ text: 'Finish', action: () => tour.next() }]
                }
            ];
            for (const step of steps) {
                let attachEl = null;
                try {
                    attachEl = typeof step.attachTo.element === "string"
                        ? document.querySelector(step.attachTo.element)
                        : step.attachTo.element;
                } catch {}
                if (attachEl) {
                    tour.addStep({
                        id: step.id,
                        text: step.text,
                        attachTo: step.attachTo,
                        buttons: step.btns.map(btn => ({
                            text: btn.text,
                            action: btn.action
                        }))
                    });
                }
            }
            if (!tour.steps || !tour.steps.length) {
              alert("Unable to start guide: required elements are missing.");
              return;
            }
            tour.start();
        });
      }
    });

    // Monkey patch Shepherd Step to always resolve attachTo to document.body if missing to prevent TypeError
    // (In some Shepherd versions, the object is Step.prototype; if not available, skip.)
    (function(){
      if (window.Shepherd && window.Shepherd.Step) {
        const proto = window.Shepherd.Step.prototype;
        const origResolve = proto._getResolvedAttachTo;
        if (typeof origResolve === "function") {
          proto._getResolvedAttachTo = function(...args) {
            try {
              const attachTo = this.options && this.options.attachTo;
              if (attachTo && attachTo.element) {
                let elem = (typeof attachTo.element === "string")
                  ? document.querySelector(attachTo.element)
                  : attachTo.element;
                if (!elem) {
                  // fallback to body instead of null which causes TypeError
                  return { element: document.body, on: attachTo.on || 'bottom' };
                }
                return origResolve.apply(this, args);
              } else {
                return { element: document.body, on: 'bottom' };
              }
            } catch (e) {
              return { element: document.body, on: 'bottom' };
            }
          }
        }
      }
    })();
    </script>
</body>
</html>